<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FichaDnD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* A fonte 'Optimus Princeps' precisa ser carregada localmente ou de um CDN.
           Para este exemplo, o caminho 'path/to/OptimusPrinceps.woff2' é um placeholder.
           Você precisaria hospedar esses arquivos de fonte e atualizar os caminhos. */
        @font-face {
            font-family: 'Optimus Princeps';
            src: url('path/to/OptimusPrinceps.woff2') format('woff2'),
                 url('path/to/OptimusPrinceps.woff') format('woff');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        :root {
            /* Cores base da lore: Dourado para a luz da redenção, cinzas e preto para as sombras */
            --gold-glow: #ffd700; /* Dourado vibrante para brilhos e destaques */
            --gold-glow-hover: #ffec80; /* Dourado mais claro para hover */
            --text-primary: #f0f0f0; /* Branco/Prateado muito claro para texto principal (almas purificadas) */
            --bg-dark-transparent: rgba(10, 5, 5, 0.85); /* Fundo escuro semitransparente, mantendo a profundidade */
            --border-gold: rgba(255, 215, 0, 0.6); /* Borda dourada com mais presença */
            --green-success: #22c55e; /* Verde para sucesso */
            --red-failure: #ef4444; /* Vermelho para falha */
            --black-transparent: rgba(0, 0, 0, 0.6); /* Fundo ainda mais transparente para elementos internos */
            --hp-gradient-start: #6b0000; /* Gradiente de HP: escuro para claro */
            --hp-gradient-end: #ff0000;
            --ethereal-blue: rgba(48, 64, 80, 0.5); /* Azul etéreo sutil para elementos de fundo */

            /* Variáveis para cores de chama (default Radiant) */
            --flame-orange: rgba(255, 165, 0, 0.7);
            --flame-yellow: rgba(255, 200, 0, 0.5);
            --flame-red: rgba(255, 100, 0, 0.3);
            --flame-orange-alt: rgba(255, 180, 0, 0.8);
            --flame-yellow-alt: rgba(255, 210, 0, 0.6);
            --flame-red-alt: rgba(255, 80, 0, 0.4);

            /* Nova variável para intensidade do brilho etéreo/chama */
            --flame-spread-factor: 1.0; /* Fator para controlar o "espalha" (spread) da box-shadow */

            /* Novas variáveis para cores de texto específicas */
            --header-gold-text: #ffd700; /* Cor padrão para títulos e cabeçalhos */
            --success-text: #22c55e; /* Cor padrão para texto de sucesso */
            --failure-text: #ef4444; /* Cor padrão para texto de falha */
        }

        /* Tema Necrótico */
        body.theme-necrotic {
            --gold-glow: #00E6E6; /* Bright Cyan */
            --gold-glow-hover: #00FFFF; /* Even brighter Cyan */
            --text-primary: #A0A0A0; /* Darker grey for readability on dark backgrounds */
            --border-gold: rgba(0, 150, 150, 0.6); /* Darker teal for borders */
            --green-success: #7CFC00; /* Lime Green */
            --red-failure: #8B008B; /* Dark Magenta/Purple */
            --black-transparent: rgba(0, 0, 0, 0.7);
            --hp-gradient-start: #4B0082; /* Indigo - deep purple */
            --hp-gradient-end: #800080; /* Purple */
            --flame-orange: rgba(0, 180, 180, 0.7); /* Teal flame start */
            --flame-yellow: rgba(0, 220, 220, 0.5); /* Lighter teal flame */
            --flame-red: rgba(0, 120, 120, 0.3); /* Darker teal flame */
            --flame-orange-alt: rgba(0, 190, 190, 0.8);
            --flame-yellow-alt: rgba(0, 230, 230, 0.6);
            --flame-red-alt: rgba(0, 130, 130, 0.4);
            --header-gold-text: #00E6E6;
            --success-text: #7CFC00;
            --failure-text: #8B008B;
        }

        body {
            font-family: 'Optimus Princeps', serif;
            background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0.7), rgba(10, 5, 5, 0.95)), url('https://storage.googleapis.com/gemini-prod-us-west1-assets/user/uploaded_file_517e3f88-4c9b-4401-b66e-c533c3937777.jpg'); /* Updated placeholder background image */
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text-primary);
            overflow-y: auto;
            overflow-x: hidden;
            min-height: 1080px;
            padding-bottom: 2rem;
            transition: background-color 0.5s ease;
        }

        /* Custom Scrollbar - mantém o dourado como um filete de luz */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #080404; }
        ::-webkit-scrollbar-thumb { background: var(--gold-glow); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--gold-glow-hover); }

        .gothic-card {
            background-color: var(--bg-dark-transparent);
            border: 1px solid var(--border-gold);
            border-radius: 8px;
            box-shadow: 0 0 18px rgba(255, 215, 0, 0.25);
            backdrop-filter: blur(6px);
            position: relative;
            z-index: 1;
        }

        /* Class for cards that will have the subtle flame effect */
        .glowing-card::before {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border-radius: 10px;
            z-index: -1;
            pointer-events: none;
            animation: flame-flicker 2s infinite alternate;
            opacity: var(--flame-glow-opacity, 0.8); /* Adjusted default opacity */
        }

        /* Desabilita o brilho etéreo quando a classe no-flame-glow está presente no body */
        body.no-flame-glow .glowing-card::before,
        body.no-flame-glow .aura-gold {
            animation: none !important;
            box-shadow: none !important;
            opacity: 0 !important;
        }

        /* Keyframes for the subtle flame effect */
        @keyframes flame-flicker {
            0% {
                box-shadow:
                    0 0 8px calc(3px * var(--flame-spread-factor)) var(--flame-orange),
                    0 0 16px calc(6px * var(--flame-spread-factor)) var(--flame-yellow),
                    0 0 24px calc(9px * var(--flame-spread-factor)) var(--flame-red);
                opacity: 0.7;
            }
            50% {
                box-shadow:
                    0 0 10px calc(4px * var(--flame-spread-factor)) var(--flame-orange-alt),
                    0 0 20px calc(8px * var(--flame-spread-factor)) var(--flame-yellow-alt),
                    0 0 28px calc(11px * var(--flame-spread-factor)) var(--flame-red-alt);
                opacity: 0.9;
            }
            100% {
                box-shadow:
                    0 0 8px calc(3px * var(--flame-spread-factor)) var(--flame-orange),
                    0 0 16px calc(6px * var(--flame-spread-factor)) var(--flame-yellow),
                    0 0 24px calc(9px * var(--flame-spread-factor)) var(--flame-red);
                opacity: 0.7;
            }
        }

        /* Brilho etéreo para a imagem do personagem - also more subtle */
        .aura-gold {
            border: none;
            animation: image-flame-glow 2s infinite alternate;
            position: relative;
            z-index: 10;
        }

        @keyframes image-flame-glow {
            0% {
                box-shadow:
                    0 0 10px calc(5px * var(--flame-spread-factor)) var(--flame-orange),
                    0 0 20px calc(10px * var(--flame-spread-factor)) var(--flame-yellow),
                    0 0 30px calc(15px * var(--flame-spread-factor)) var(--flame-red);
                opacity: 0.8;
            }
            50% {
                box-shadow:
                    0 0 12px calc(6px * var(--flame-spread-factor)) var(--flame-orange-alt),
                    0 0 25px calc(12px * var(--flame-spread-factor)) var(--flame-yellow-alt),
                    0 0 35px calc(18px * var(--flame-spread-factor)) var(--flame-red-alt);
                opacity: 1;
            }
            100% {
                box-shadow:
                    0 0 10px calc(5px * var(--flame-spread-factor)) var(--flame-orange),
                    0 0 20px calc(10px * var(--flame-spread-factor)) var(--flame-yellow),
                    0 0 30px calc(15px * var(--flame-spread-factor)) var(--flame-red);
                opacity: 0.8;
            }
        }

        .gothic-input, .gothic-select, .gothic-textarea {
            background-color: var(--black-transparent);
            border: 1px solid var(--border-gold);
            color: var(--text-primary); border-radius: 4px; transition: all 0.3s ease;
            width: 100%; padding: 0.5rem;
        }
        .gothic-input:focus, .gothic-select:focus, .gothic-textarea:focus {
            outline: none;
            box-shadow: 0 0 12px var(--gold-glow);
            border-color: var(--gold-glow);
        }

        /* Hide number input arrows (spinners) for Webkit (Chrome, Safari) */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Hide number input arrows (spinners) for Firefox */
        input[type="number"] {
            -moz-appearance: textfield;
        }

        .action-button-group { position: relative; }
        .action-button-group .action-button-name {
            position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%);
            background-color: #000; color: var(--gold-glow); padding: 2px 8px;
            border-radius: 4px; font-size: 0.75rem; opacity: 0; visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s; white-space: nowrap;
        }
        .action-button-group:hover .action-button-name { opacity: 1; visibility: visible; }

        .gothic-btn {
            background-color: transparent; border: 1px solid var(--gold-glow); color: var(--gold-glow);
            padding: 8px 16px; border-radius: 4px; font-weight: bold; text-transform: uppercase;
            letter-spacing: 1px; transition: all 0.3s ease; text-shadow: 0 0 5px var(--gold-glow);
            cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        .gothic-btn:hover {
            background-color: var(--gold-glow);
            color: #000;
            box-shadow: 0 0 18px var(--gold-glow);
        }

        .hp-bar-container { background-color: var(--black-transparent); border: 1px solid var(--border-gold); border-radius: 5px; padding: 2px; }
        #hpBar { background: linear-gradient(to right, var(--hp-gradient-start), var(--hp-gradient-end)); height: 20px; border-radius: 3px; transition: width 0.5s ease-in-out; text-shadow: 1px 1px 2px #000; }

        .death-save { width: 0.8rem; height: 0.8rem; border: 1px solid var(--border-gold); border-radius: 50%; cursor: pointer; transition: all 0.2s; }
        .death-save.success.checked { background-color: var(--green-success); border-color: var(--green-success); box-shadow: 0 0 8px var(--green-success); }
        .death-save.failure.checked { background-color: var(--red-failure); border-color: var(--red-failure); box-shadow: 0 0 8px var(--red-failure); }

        .advantage-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            border: 1px solid var(--border-gold);
            cursor: pointer;
            transition: all 0.2s;
            justify-self: center;
        }
        .advantage-dot.toggled {
            background-color: var(--gold-glow);
            box-shadow: 0 0 5px var(--gold-glow);
        }

        .proficiency-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1px solid var(--border-gold);
            cursor: pointer;
            transition: all 0.2s;
            justify-self: center;
        }
        .proficiency-dot.toggled {
            background-color: var(--text-primary);
            box-shadow: 0 0 8px var(--text-primary);
            border-color: var(--text-primary);
        }

        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7); backdrop-filter: blur(8px);
            display: none; justify-content: center; align-items: center; z-index: 50; padding: 1rem;
        }
        /* Ajuste do z-index para o modal de edição de magia */
        #spellEditModal {
            z-index: 55; /* Deve ser maior que o spellModal */
        }
        /* Novo modal de visualização de imagem em tela cheia */
        #imageViewerModal {
            z-index: 60; /* Maior que todos os outros modais */
        }
        #imageViewerModal .modal-content {
            background: none; /* Sem fundo ou borda gótica para foco na imagem */
            border: none;
            box-shadow: none;
            backdrop-filter: none;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            max-width: 90vw;
            max-height: 90vh;
        }
        #imageViewerModal img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; /* Garante que a imagem se ajuste sem cortar */
            border-radius: 8px;
            border: 2px solid var(--gold-glow);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .modal-content { width: 90%; max-width: 800px; max-height: 90vh; }

        /* Attribute Item Styles (for attributes below image) */
        #attribute-bar {
            display: flex;
            justify-content: center;
            gap: 2.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        .attribute-item {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            width: 70px;
        }
        .attr-score-display {
            width: 50px;
            height: 50px;
            background: var(--black-transparent);
            border-radius: 50%;
            border: 1px solid var(--border-gold);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease-in-out;
            font-size: 1.5rem;
            font-weight: bold;
        }
        .attr-name {
            font-size: 0.9rem;
            margin-top: 0.25rem;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .attr-modifier { /* Popup on hover */
            position: absolute;
            background: #000;
            color: var(--gold-glow);
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 0.8rem;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            white-space: nowrap;
            pointer-events: none;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: bold;
        }
        .attribute-item:hover .attr-modifier { opacity: 1; visibility: visible; }
        .attribute-item:hover .attr-score-display { transform: scale(1.1); background: var(--gold-glow); color: #000; }

        /* Settings Icon */
        #settings-btn {
            position: absolute;
            top: 1rem;
            left: 1rem;
            opacity: 0.5;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        #settings-btn:hover { opacity: 1; transform: scale(1.1) rotate(45deg); }
        input[type="color"] {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            width: 44px; height: 44px; background-color: transparent;
            border: none; cursor: pointer; padding: 0;
        }
        input[type="color"]::-webkit-color-swatch { border-radius: 50%; border: 2px solid var(--border-gold); }
        input[type="color"]::-moz-color-swatch { border-radius: 50%; border: 2px solid var(--border-gold); }

        /* Estilo para agrupar habilidades e perícias */
        .ability-group {
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid rgba(255, 215, 0, 0.1);
        }
        .ability-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        /* Alinhamento geral para habilidades e perícias */
        .ability-row {
            display: grid;
            grid-template-columns: 2.5fr auto auto 1fr; /* Nome, Ponto Vantagem, Ponto Proficiência, Total */
            align-items: center;
            gap: 0.5rem;
            min-height: 2rem;
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }

        .ability-row label {
            text-align: left;
            white-space: normal;
            overflow: visible;
            text-overflow: clip;
            font-size: 1rem;
        }

        .ability-row span.font-bold.text-lg {
            justify-self: center;
            font-size: 1.1rem;
        }

        /* GLOBAL TABS STYLING */
        #global-tabs {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border-gold);
            padding-bottom: 0.5rem;
            flex-wrap: wrap; /* Allow tabs to wrap on smaller screens */
        }
        .tab-button {
            background-color: var(--black-transparent);
            border: 1px solid var(--border-gold);
            color: var(--text-primary);
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap; /* Prevent text wrapping within button */
        }
        .tab-button:hover {
            background-color: rgba(255, 215, 0, 0.1); /* Subtle hover */
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
            color: var(--gold-glow);
        }
        .tab-button.active {
            background-color: var(--gold-glow);
            color: #000;
            box-shadow: 0 0 15px var(--gold-glow);
            border-color: var(--gold-glow);
            transform: translateY(-2px); /* Slight lift for active tab */
        }

        .tab-content {
            display: none; /* Hidden by default */
        }
        .tab-content.active {
            display: block; /* Show active tab content */
        }


        /* Spell Modal Tabs (still used within Grimório tab) */
        .spell-modal-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-gold);
            padding-bottom: 0.5rem;
            gap: 1rem;
        }
        .spell-modal-tab-button {
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: 'Optimus Princeps', serif;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        .spell-modal-tab-button.active {
            color: var(--gold-glow);
            background-color: rgba(255, 215, 0, 0.1);
            box-shadow: 0 0 8px rgba(255, 215, 0, 0.2);
        }
        .spell-modal-tab-button:hover:not(.active) {
            background-color: rgba(255, 215, 0, 0.05);
        }
        .spell-modal-tab-content {
            display: none;
        }
        .spell-modal-tab-content.active {
            display: block;
        }

        /* Initiative and Proficiency card styling */
        #initiative-proficiency-card {
            background-color: var(--bg-dark-transparent);
            border: 1px solid var(--border-gold);
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
            backdrop-filter: blur(5px);
            padding: 1rem;
            text-align: center;
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #initiative-proficiency-card .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #initiative-proficiency-card .stat-label {
            font-size: 1.2rem;
            color: var(--gold-glow);
            margin-bottom: 0.25rem;
        }
        #initiative-proficiency-card .stat-value-large {
            font-size: 3rem;
            font-weight: bold;
            color: var(--gold-glow);
            text-shadow: 0 0 5px var(--gold-glow);
        }
        #initiative-proficiency-card .stat-value-small {
            font-size: 2rem;
            font-weight: bold;
            color: var(--text-primary);
            text-shadow: 0 0 3px rgba(0,0,0,0.5);
        }

        /* Music Player Styling */
        #musicPlayerCard {
            margin-top: 1.5rem;
        }

        /* Removemos as abas, então esses estilos não são mais estritamente necessários aqui */
        .music-player-tabs {
            display: none;
        }
        .music-player-tab-button {
            display: none;
        }

        .music-player-tab-content {
            display: block;
            padding: 1rem;
        }
        .music-player-tab-content.hidden {
            display: none;
        }

        #localMusicDropArea {
            border: 2px dashed var(--border-gold);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        #localMusicDropArea.drag-over {
            background-color: rgba(255, 215, 0, 0.1);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }
        #localMusicInput {
            display: none;
        }

        #localPlaylist {
            list-style: none;
            padding: 0;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 1rem;
        }
        #localPlaylist li {
            background-color: var(--black-transparent);
            padding: 0.5rem;
            margin-bottom: 0.25rem;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }
        #localPlaylist li.active-track {
            background-color: rgba(255, 215, 0, 0.25);
            border: 1px solid var(--gold-glow);
        }
        #localPlaylist li button {
            background: none;
            border: none;
            color: var(--red-failure);
            cursor: pointer;
            font-size: 1rem;
        }

        #musicControls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
        }
        #musicControls button {
            background-color: var(--black-transparent);
            border: 1px solid var(--border-gold);
            color: var(--gold-glow);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        #musicControls button:hover {
            background-color: var(--gold-glow);
            color: #000;
            box-shadow: 0 0 8px var(--gold-glow);
        }
        #volumeControl {
            width: 100px;
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: var(--black-transparent);
            outline: none;
            border-radius: 4px;
            transition: opacity .2s;
        }
        #volumeControl::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--gold-glow);
            cursor: pointer;
            box-shadow: 0 0 5px var(--gold-glow);
        }
        #volumeControl::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--gold-glow);
            cursor: pointer;
            box-shadow: 0 0 5px var(--gold-glow);
        }

        /* Now Playing Pop-up */
        #nowPlayingPopup {
            position: fixed;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.85);
            border: 1px solid var(--gold-glow);
            border-radius: 0 0 8px 8px;
            color: var(--text-primary);
            padding: 0.75rem 1.5rem;
            font-family: 'Optimus Princeps', serif;
            font-size: 1.1rem;
            text-align: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: top 0.5s ease-out, opacity 0.5s ease-out;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            max-width: 90%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #nowPlayingPopup.show {
            top: 0;
            opacity: 1;
            visibility: visible;
        }

        /* Message Pop-up (for alerts) */
        .message-popup {
            position: fixed;
            top: -100px; /* Start off-screen */
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.85);
            border: 1px solid var(--gold-glow);
            border-radius: 0 0 8px 8px;
            color: var(--text-primary);
            padding: 0.75rem 1.5rem;
            font-family: 'Optimus Princeps', serif;
            font-size: 1.1rem;
            text-align: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: top 0.5s ease-out, opacity 0.5s ease-out;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            max-width: 90%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .message-popup.show {
            top: 0; /* Slide in */
            opacity: 1;
            visibility: visible;
        }

        /* Inventory Item Grid Display */
        .inventory-item-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); /* Imagens um pouco maiores */
            gap: 1rem;
            /* Adicionado padding para garantir que a sombra do hover não seja cortada pelos limites do overflow */
            padding: 5px; /* Pequeno padding para evitar clipping superior/inferior da sombra */
            margin: -5px; /* Compensar o padding para manter o layout original */
        }
        .inventory-item-card {
            background-color: var(--black-transparent);
            border: 1px solid var(--border-gold);
            border-radius: 8px;
            padding: 0.75rem;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        .inventory-item-card:hover {
            box-shadow: 0 0 10px var(--gold-glow);
            transform: translateY(-2px);
            /* Garante que o item em hover fique acima dos outros, se houver sobreposição */
            z-index: 2;
        }
        .inventory-item-card img {
            width: 100px; /* Imagem maior no grid */
            height: 100px; /* Imagem maior no grid */
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid rgba(255, 215, 0, 0.4);
        }
        .inventory-item-card .item-name {
            font-weight: bold;
            font-size: 0.9rem;
            color: var(--text-primary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            width: 100%;
        }
        .inventory-item-card .item-qty {
            font-size: 0.8rem;
            color: var(--gold-glow);
        }
        .inventory-item-card .delete-item-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            color: var(--red-failure);
            cursor: pointer;
            font-size: 1rem;
            padding: 0;
            line-height: 1;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .inventory-item-card .delete-item-btn:hover {
            opacity: 1;
        }
        #item-detail-image {
            width: 160px; /* Imagem ainda maior no modal de detalhes */
            height: 160px; /* Imagem ainda maior no modal de detalhes */
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid var(--border-gold);
            cursor: pointer; /* Indica que a imagem é clicável */
        }
        /* Corrigido: Removido gothic-card do #item-detail-notes para evitar brilho cortado */
        #item-detail-notes {
            background-color: var(--black-transparent); /* Mantém o fundo transparente */
            border: 1px solid var(--border-gold); /* Mantém a borda */
            border-radius: 8px; /* Mantém as bordas arredondadas */
            padding: 0.75rem; /* Mantém o padding */
        }

        /* Estilos para a seção de ataques */
        .attack-item {
            background-color: var(--black-transparent);
            border: 1px solid var(--border-gold);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }
        .attack-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .attack-item-header h4 {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--header-gold-text);
        }
        .attack-details {
            font-size: 0.85rem;
            opacity: 0.8;
        }
        .attack-notes {
            font-size: 0.9rem;
            margin-top: 0.5rem;
            border-top: 1px solid rgba(255, 215, 0, 0.1);
            padding-top: 0.5rem;
        }

        /* Estilos para recursos e condições */
        .resource-item, .condition-item {
            background-color: var(--black-transparent);
            border: 1px solid var(--border-gold);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }
        .resource-item-header, .condition-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .resource-item-header h4, .condition-item-header h4 {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--header-gold-text);
        }
        .resource-details, .condition-details {
            font-size: 0.85rem;
            opacity: 0.8;
        }
        .resource-notes, .condition-notes {
            font-size: 0.9rem;
            margin-top: 0.5rem;
            border-top: 1px solid rgba(255, 215, 0, 0.1);
            padding-top: 0.5rem;
        }
        .resource-uses {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: bold;
            color: var(--gold-glow);
        }
        .resource-use-btn {
            background-color: var(--black-transparent);
            border: 1px solid var(--border-gold);
            color: var(--gold-glow);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .resource-use-btn:hover {
            background-color: var(--gold-glow);
            color: #000;
            box-shadow: 0 0 8px var(--gold-glow);
        }
        .condition-checkbox {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border: 2px solid var(--border-gold);
            border-radius: 4px;
            cursor: pointer;
            display: inline-block;
            vertical-align: middle;
            position: relative;
            margin-right: 8px;
            transition: all 0.2s ease;
        }

        .condition-checkbox:checked {
            background-color: var(--red-failure);
            border-color: var(--red-failure);
            box-shadow: 0 0 8px var(--red-failure);
        }

        .condition-checkbox:checked::before {
            content: '\2713'; /* Checkmark unicode character */
            display: block;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 16px;
            line-height: 1;
        }

        .condition-item.active {
            background-color: rgba(255, 0, 0, 0.1);
            border-color: var(--red-failure);
            box-shadow: 0 0 10px var(--red-failure);
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <input type="file" id="imageUpload" class="hidden" accept="image/*">
    <input type="file" id="wallpaperUpload" class="hidden" accept="image/*">
    <input type="file" id="spell-image-upload" class="hidden" accept="image/*">

    <div class="main-container space-y-6">

        <!-- Global Settings Button -->
        <div id="settings-btn" onclick="openModal('settingsModal')" class="absolute top-4 left-4 z-20">
            <i data-lucide="settings" class="w-8 h-8"></i>
        </div>

        <!-- Global Tabs Navigation -->
        <div id="global-tabs">
            <button class="tab-button" data-tab="character-tab">Personagem</button>
            <button class="tab-button" data-tab="combat-tab">Combate</button>
            <button class="tab-button" data-tab="spellbook-tab">Grimório</button>
            <button class="tab-button" data-tab="inventory-tab">Inventário</button>
            <button class="tab-button" data-tab="history-tab">História</button>
            <button class="tab-button" data-tab="tools-tab">Ferramentas</button>
        </div>

        <!-- TAB: Personagem -->
        <div id="character-tab" class="tab-content space-y-6">
            <div class="gothic-card p-6 relative flex items-center header-section">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full">
                    <input id="characterName" class="gothic-input text-2xl col-span-1" placeholder="Nome do Personagem">
                    <input id="characterClass" class="gothic-input text-2xl col-span-1" placeholder="Classe">
                    <input id="characterRace" class="gothic-input text-2xl col-span-1" placeholder="Raça">
                </div>
            </div>

            <div class="gothic-card glowing-card top-central-section-container flex flex-col items-center p-6">
                <!-- Container for Image and Level, to control their relative position and margins -->
                <div class="flex items-center justify-center w-full relative" style="margin-bottom: 2rem;">
                    <!-- Imagem do Personagem -->
                    <div id="char-image-container" class="aura-gold flex-shrink-0 overflow-hidden mx-auto" style="width: 192px; height: 192px; border-radius: 50%;" onclick="document.getElementById('imageUpload').click()">
                        <img id="charImage" src="https://placehold.co/192x192/000000/ffd700?text=?" alt="Retrato" class="w-full h-full object-cover">
                        <div id="char-image-overlay" class="absolute inset-0 flex flex-col items-center justify-center text-center bg-black/50 text-text-primary text-sm font-bold transition-opacity duration-300 opacity-0">
                            Clique para Adicionar Imagem
                            <i data-lucide="image-plus" class="w-8 h-8 mt-2"></i>
                        </div>
                    </div>
                    
                    <!-- Nível do Personagem (Posicionado absolutamento à esquerda da imagem) -->
                    <div id="character-level-in-image-card" class="absolute z-10 flex flex-col items-center justify-center bg-black/60 border border-border-gold rounded-full p-4 shadow-md flex-shrink-0" style="width: 100px; height: 100px; left: calc(50% - 160px); top: 50%; transform: translateY(-50%);">
                        <label class="text-sm font-bold text-text-primary">Nível</label>
                        <div class="level-controls flex items-center gap-1">
                            <button class="level-btn !w-6 !h-6 !text-base" onclick="adjustLevel(-1)"><i data-lucide="minus" class="w-4 h-4"></i></button>
                            <span id="characterLevelDisplay" class="level-display text-3xl font-bold text-gold-glow" style="text-shadow: 0 0 8px var(--gold-glow);">1</span>
                            <button class="level-btn !w-6 !h-6 !text-base" onclick="adjustLevel(1)"><i data-lucide="plus" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                </div>

                <!-- Barra de Atributos (abaixo da imagem e nível) -->
                <div id="attribute-bar">
                    <!-- Atributos serão renderizados aqui -->
                </div>
            </div>

            <div class="middle-grid">
                <div class="col-span-1 space-y-6">
                    <div class="gothic-card p-6">
                        <h2 class="text-2xl text-center mb-4" style="color: var(--header-gold-text);">Habilidades e Perícias</h2>
                        <div id="ability-skill-groups" class="grid grid-cols-1 gap-0"></div>
                    </div>
                </div>

                <div class="col-span-full md:col-span-1 lg:col-span-1 space-y-6">
                    <div id="initiative-proficiency-card" class="glowing-card"> <!-- Applied glowing-card -->
                        <div class="combined-stats">
                            <div class="stat-item">
                                <span class="stat-label">Iniciativa</span>
                                <span id="initiative" class="stat-value-large">+0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Proficiência</span>
                                <span id="proficiencyBonusDisplay" class="stat-value-small">+0</span>
                            </div>
                        </div>
                    </div>

                    <div class="gothic-card p-4">
                        <h3 class="text-xl text-center mb-3" style="color: var(--header-gold-text);">Testes de Morte</h3>
                        <div class="flex justify-around items-center">
                            <div class="flex items-center gap-2">
                                <span class="text-lg" style="color: var(--success-text);">Sucessos:</span>
                                <div id="dss-1" class="death-save success" onclick="toggleDeathSave('successes', 0)"></div>
                                <div id="dss-2" class="death-save success" onclick="toggleDeathSave('successes', 1)"></div>
                                <div id="dss-3" class="death-save success" onclick="toggleDeathSave('successes', 2)"></div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-lg" style="color: var(--failure-text);">Falhas:</span>
                                <div id="dsf-1" class="death-save failure" onclick="toggleDeathSave('failures', 0)"></div>
                                <div id="dsf-2" class="death-save failure" onclick="toggleDeathSave('failures', 1)"></div>
                                <div id="dsf-3" class="death-save failure" onclick="toggleDeathSave('failures', 2)"></div>
                            </div>
                        </div>
                    </div>
                    <div class="gothic-card p-4">
                        <label class="text-xl text-center block mb-2" style="color: var(--header-gold-text);">Pontos de Vida</label>
                        <div class="flex items-center gap-3 my-2">
                            <input id="hpCurrent" type="number" class="gothic-input text-center text-lg" value="10"><span>/</span><input id="hpMax" type="number" class="gothic-input text-center text-lg" value="10">
                        </div>
                        <div class="hp-bar-container">
                            <div id="hpBar" class="text-center font-bold text-white text-base">100%</div>
                        </div>
                    </div>
                    <div class="gothic-card p-4 grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-lg text-center block" style="color: var(--header-gold-text);">PV Temporários</label>
                            <input id="hpTemp" type="number" class="gothic-input text-center text-xl" value="0">
                        </div>
                        <div>
                            <label class="text-lg text-center block" style="color: var(--header-gold-text);">Classe de Armadura</label>
                            <input id="ac" type="number" class="gothic-input text-center text-xl" value="10">
                        </div>
                    </div>
                    <div class="gothic-card p-4 space-y-4">
                        <h3 class="text-xl text-center" style="color: var(--header-gold-text);">Dados de Vida</h3>
                        <div class="grid grid-cols-3 gap-2 items-center">
                            <div>
                                <label class="block text-sm font-bold mb-1">Atual</label>
                                <input type="number" id="hit-dice-current" class="gothic-input text-center text-lg" value="1" min="0" oninput="debouncedUpdateHitDice()">
                            </div>
                            <div class="text-center text-xl font-bold">/</div>
                            <div>
                                <label class="block text-sm font-bold mb-1">Máx</label>
                                <input type="number" id="hit-dice-max" class="gothic-input text-center text-lg" value="1" min="0" oninput="debouncedUpdateHitDice()">
                            </div>
                        </div>
                        <div class="mt-2">
                            <label class="block text-sm font-bold mb-1">Tipo de Dado</label>
                            <select id="hit-dice-type" class="gothic-select text-base" onchange="debouncedUpdateHitDice()">
                                <option value="d6">d6</option>
                                <option value="d8" selected>d8</option>
                                <option value="d10">d10</option>
                                <option value="d12">d12</option>
                            </select>
                        </div>
                        <button class="gothic-btn w-full mt-3" onclick="openSpendHitDicePrompt()">Gastar Dados de Vida</button>
                        <p id="spend-hd-result" class="text-center text-sm mt-2 opacity-80"></p>

                        <h3 class="text-xl text-center mt-6" style="color: var(--header-gold-text);">Descansos</h3>
                        <div class="flex justify-around gap-4">
                            <button class="gothic-btn flex-1" onclick="takeShortRest()">Descanso Curto</button>
                            <button class="gothic-btn flex-1" onclick="takeLongRest()">Descanso Longo</button>
                        </div>
                        <p class="text-center text-sm opacity-80 mt-2">Descansos Curtos: <span id="short-rests-count">0</span> | Descansos Longos: <span id="long-rests-count">0</span></p>
                    </div>
                    <div class="gothic-card p-4 space-y-4">
                        <h3 class="text-xl text-center" style="color: var(--header-gold-text);">Outras Proficiências</h3>
                        <div>
                            <label class="block text-sm font-bold mb-1">Armaduras</label>
                            <textarea id="prof-armors" class="gothic-textarea text-base h-16" placeholder="Ex: Armadura Leve, Média"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-1">Armas</label>
                            <textarea id="prof-weapons" class="gothic-textarea text-base h-16" placeholder="Ex: Simples, Marciais"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-1">Ferramentas</label>
                            <textarea id="prof-tools" class="gothic-textarea text-base h-16" placeholder="Ex: Ferramentas de Ladrão"></textarea>
                        </div>
                        <h3 class="text-xl text-center mt-6" style="color: var(--header-gold-text);">Sentidos Passivos</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="flex flex-col items-center gothic-card p-3">
                                <label class="block text-base">Percepção Passiva</label>
                                <span id="passive-perception" class="block text-2xl font-bold text-center" style="color: var(--header-gold-text);">0</span>
                            </div>
                            <div class="flex flex-col items-center gothic-card p-3">
                                <label class="block text-base">Investigação Passiva</label>
                                <span id="passive-investigation" class="block text-2xl font-bold text-center" style="color: var(--header-gold-text);">0</span>
                            </div>
                            <div class="col-span-full flex flex-col items-center gothic-card p-3">
                                <label class="block text-base">Intuição Passiva</label>
                                <span id="passive-insight" class="block text-2xl font-bold text-center" style="color: var(--header-gold-text);">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: Combate -->
        <div id="combat-tab" class="tab-content space-y-6">
            <div class="gothic-card p-4 space-y-4" id="attacksCard">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xl" style="color: var(--header-gold-text);">Ataques e Habilidades</h3>
                    <button class="gothic-btn text-base" onclick="openAttackEditModal(null)">Adicionar Ataque</button>
                </div>
                <div id="attackList" class="space-y-3">
                </div>
            </div>
            <div class="gothic-card p-4 space-y-4" id="resourcesCard">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xl" style="color: var(--header-gold-text);">Recursos de Classe e Habilidades</h3>
                    <button class="gothic-btn text-base" onclick="openResourceEditModal(null)">Adicionar Recurso</button>
                </div>
                <div id="resourcesList" class="space-y-3">
                </div>
            </div>
            <div class="gothic-card p-4 space-y-4" id="conditionsCard">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xl" style="color: var(--header-gold-text);">Condições de Status</h3>
                    <button class="gothic-btn text-base" onclick="openConditionModal()">Gerenciar Condições</button>
                </div>
                <div id="activeConditionsList" class="space-y-3">
                </div>
            </div>
        </div>

        <!-- TAB: Grimório -->
        <div id="spellbook-tab" class="tab-content space-y-6">
            <div class="gothic-card p-6 flex flex-col">
                <div class="spell-modal-tabs">
                    <button class="spell-modal-tab-button active" data-tab-target="conjuration-tab-content">Conjuração</button>
                    <button class="spell-modal-tab-button" data-tab-target="spells-list-tab-content">Magias</button>
                </div>

                <div id="conjuration-tab-content" class="spell-modal-tab-content active space-y-4">
                    <h2 class="text-xl mb-3 text-center" style="color: var(--header-gold-text);">Estatísticas de Conjuração</h2>
                    <div class="flex items-center gap-3">
                        <label class="text-base flex-1 text-left">Atributo Chave:</label>
                        <select id="spellcasting-ability" class="gothic-select flex-2 text-base" oninput="collectDataFromUI(); updateAllCalculations();">
                            <option value="int">Inteligência</option>
                            <option value="wis">Sabedoria</option>
                            <option value="cha">Carisma</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-3">
                        <div>
                            <label class="block text-base" style="color: var(--header-gold-text);">CD da Magia</label>
                            <div id="spell-save-dc" class="text-4xl font-bold p-2">0</div>
                        </div>
                        <div>
                            <label class="block text-base" style="color: var(--header-gold-text);">Ataque de Magia</label>
                            <div id="spell-attack-bonus" class="text-4xl font-bold p-2">+0</div>
                        </div>
                    </div>
                </div>

                <div id="spells-list-tab-content" class="spell-modal-tab-content space-y-4">
                    <h2 class="text-3xl text-center mb-5" style="color: var(--header-gold-text);">Grimório</h2>
                    <div class="flex justify-between items-center mb-5">
                        <h3 class="text-xl" style="color: var(--header-gold-text);">Espaços de Magia</h3>
                        <button onclick="openSpellEditModal(null)" class="gothic-btn text-base">Criar Magia</button>
                    </div>
                    <div id="spellSlots" class="grid grid-cols-3 md:grid-cols-5 gap-5 mb-5 p-4 border border-border-gold rounded-lg"></div>
                    <div id="spellList" class="flex-grow overflow-y-auto space-y-5 pr-3"></div>
                </div>
            </div>
        </div>

        <!-- TAB: Inventário -->
        <div id="inventory-tab" class="tab-content space-y-6">
            <div class="gothic-card p-6 flex flex-col">
                <div class="flex justify-between items-center mb-5">
                    <h2 class="text-3xl text-center flex-grow" style="color: var(--header-gold-text);">Inventário</h2>
                    <div class="flex gap-3">
                        <button id="inventory-tab-equip" class="gothic-btn text-base !px-5" onclick="switchInventoryListTab('equip')">Equipamento</button>
                        <button id="inventory-tab-key" class="gothic-btn text-base !px-5 opacity-50" onclick="switchInventoryListTab('key')">Itens Chave</button>
                    </div>
                </div>
                <div class="text-right mb-4">
                    <button id="add-item-btn" onclick="openEditInventoryItemModal(null)" class="gothic-btn text-base">Adicionar Equipamento</button>
                </div>
                <div id="inventoryList" class="flex-grow overflow-y-auto space-y-5 pr-3 inventory-item-grid"></div>
            </div>

            <div class="gothic-card p-6 flex flex-col">
                <div id="currency-card"></div>
            </div>
        </div>

        <!-- TAB: História -->
        <div id="history-tab" class="tab-content space-y-6">
            <div class="gothic-card p-4 space-y-4" id="personalityCard">
                <h3 class="text-xl text-center" style="color: var(--header-gold-text);">Personalidade e Antecedentes</h3>
                <div>
                    <label class="block text-sm font-bold mb-1">Traços de Personalidade</label>
                    <textarea id="personalityTraits" class="gothic-textarea text-base h-24" placeholder="Ex: Sou leal aos meus amigos, mas desconfiado de estranhos."></textarea>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">Ideais</label>
                    <textarea id="ideals" class="gothic-textarea text-base h-16" placeholder="Ex: A justiça deve prevalecer sobre tudo."></textarea>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">Defeitos</label>
                    <textarea id="flaws" class="gothic-textarea text-base h-16" placeholder="Ex: Tenho um temperamento explosivo e sou facilmente provocado."></textarea>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">História do Personagem</label>
                    <textarea id="characterHistory" class="gothic-textarea text-base h-32" placeholder="Descreva o passado do seu personagem."></textarea>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">Organizações/Facções</label>
                    <input type="text" id="organizations" class="gothic-input text-base" placeholder="Ex: Guilda dos Ladrões, Ordem dos Paladinos">
                </div>
                <div class="text-center mt-4">
                    <button class="gothic-btn text-base" onclick="openModal('vinculosModal')"><i data-lucide="heart-handshake" class="w-6 h-6"></i>Ver/Gerenciar Vínculos</button>
                </div>
            </div>
            <div class="gothic-card p-6 flex flex-col">
                <h2 class="text-3xl text-center mb-5" style="color: var(--header-gold-text);">Diário de Bordo</h2>
                <textarea id="journalContent" class="gothic-textarea w-full flex-grow text-base" style="min-height: 400px;"></textarea>
            </div>
        </div>

        <!-- TAB: Ferramentas -->
        <div id="tools-tab" class="tab-content space-y-6">
            <div class="gothic-card p-6 flex flex-col">
                <h2 class="text-xl text-center mb-3" style="color: var(--header-gold-text);">Rolador de Dados</h2>
                <div class="grid grid-cols-3 gap-3 mb-3">
                    <button class="gothic-btn text-base" onclick="selectDie(4)">D4</button>
                    <button class="gothic-btn text-base" onclick="selectDie(6)">D6</button>
                    <button class="gothic-btn text-base" onclick="selectDie(8)">D8</button>
                    <button class="gothic-btn text-base" onclick="selectDie(10)">D10</button>
                    <button class="gothic-btn text-base" onclick="selectDie(12)">D12</button>
                    <button class="gothic-btn text-base" onclick="selectDie(20)">D20</button>
                </div>
                <div class="flex items-center gap-3 mb-3">
                    <input id="diceQty" type="number" class="gothic-input w-1/3 text-center text-lg" value="1">
                    <span id="diceType" class="text-2xl font-bold w-1/3 text-center">D20</span>
                    <input id="diceMod" type="number" class="gothic-input w-1/3 text-center text-lg" value="0">
                </div>
                <div class="text-center mb-3">
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="addProficiencyToRoll" class="h-5 w-5 mr-2" style="accent-color: var(--gold-glow);">
                        <span class="text-base">Adicionar Proficiência?</span>
                    </label>
                </div>
                <button class="gothic-btn w-full text-lg" onclick="rollDice()"><i data-lucide="dice-5" class="w-6 h-6"></i>Rolar</button>
                <div class="mt-3 text-center">
                    <p class="text-lg">Resultado: <span id="rollResult" class="text-3xl font-bold" style="color: var(--header-gold-text);">0</span></p>
                    <p class="text-sm opacity-75">Detalhes: <span id="rollDetail"></span></p>
                </div>
                <div class="mt-3 border-t border-yellow-800 pt-3">
                    <h3 class="text-center text-base">Histórico</h3>
                    <div id="rollHistory" class="text-sm text-center h-48 overflow-y-auto space-y-1 p-2"></div>
                </div>
            </div>

            <div id="musicPlayerCard" class="gothic-card p-6">
                <h2 class="text-2xl text-center mb-4" style="color: var(--header-gold-text);">Tocador de Músicas</h2>
                <div id="localMusicTab" class="music-player-tab-content active">
                    <input type="file" id="localMusicInput" accept="audio/*" multiple>
                    <div id="localMusicDropArea" class="mt-4">
                        Arraste e solte arquivos de audio aqui ou clique para selecionar.
                    </div>
                    <ul id="localPlaylist" class="mt-4"></ul>
                    <div id="musicControls">
                        <button onclick="prevTrack()"><i data-lucide="skip-back" class="w-6 h-6"></i></button>
                        <button onclick="togglePlayPause()"><i id="playPauseIcon" data-lucide="play" class="w-8 h-8"></i></button>
                        <button onclick="nextTrack()"><i data-lucide="skip-forward" class="w-6 h-6"></i></button>
                        <input type="range" id="volumeControl" min="0" max="1" step="0.01" value="1" oninput="setVolume(this.value)">
                    </div>
                    <audio id="backgroundMusicPlayer" preload="auto"></audio>
                </div>
            </div>
        </div>

        <!-- Global Quick Access Buttons (permanently visible) -->
        <div class="gothic-card p-4 flex justify-around items-center mt-auto fixed bottom-4 left-1/2 -translate-x-1/2 z-30 w-[95%] max-w-[500px]">
            <div class="action-button-group">
                <button class="gothic-btn !p-4" onclick="switchTab('spellbook-tab')"><i data-lucide="book-open" class="w-6 h-6"></i></button>
                <span class="action-button-name">Magias</span>
            </div>
            <div class="action-button-group">
                <button class="gothic-btn !p-4" onclick="switchTab('inventory-tab')"><i data-lucide="backpack" class="w-6 h-6"></i></button>
                <span class="action-button-name">Inventário</span>
            </div>
            <div class="action-button-group">
                <button class="gothic-btn !p-4" onclick="switchTab('tools-tab')"><i data-lucide="dice-5" class="w-6 h-6"></i></button>
                <span class="action-button-name">Ferramentas</span>
            </div>
        </div>

    </div>

    <!-- Modals (remain separate from tabs for editing/details) -->
    <div id="settingsModal" class="modal">
        <div class="modal-content gothic-card p-6 flex flex-col">
            <h2 class="text-3xl text-center mb-5" style="color: var(--header-gold-text);">Configurações de Aparência</h2>
            <div class="space-y-5 overflow-y-auto pr-3">
                <h3 class="text-xl text-center mb-4" style="color: var(--header-gold-text);">Modo de Tema</h3>
                <div class="flex justify-center items-center gap-4 mb-4">
                    <span class="text-lg">Radiante</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="themeModeSwitch" class="sr-only peer" onchange="toggleThemeMode(this.checked)">
                        <div class="w-11 h-6 bg-yellow-500 rounded-full peer peer-focus:ring-4 peer-focus:ring-yellow-300 dark:peer-focus:ring-cyan-800 dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-cyan-500"></div>
                    </label>
                    <span class="text-lg">Necrótico</span>
                </div>

                <h3 class="text-xl text-center mb-4" style="color: var(--header-gold-text);">Brilho Etéreo (Chamas)</h3>
                <label class="inline-flex items-center cursor-pointer mb-4">
                    <input type="checkbox" id="toggleFlameGlow" class="h-5 w-5 mr-2" style="accent-color: var(--gold-glow);" onchange="toggleFlameGlow(this.checked)">
                    <span class="text-base">Ativar/Desativar Brilho Etéreo</span>
                </label>
                <div id="flame-color-pickers" class="color-picker-grid">
                    </div>
                
                <h3 class="text-xl text-center mt-5" style="color: var(--header-gold-text);">Cores do Tema</h3>
                <div id="color-pickers" class="color-picker-grid"></div>

                <h3 class="text-xl text-center mt-5" style="color: var(--header-gold-text);">Plano de Fundo</h3>
                <button class="gothic-btn w-full text-lg" onclick="document.getElementById('wallpaperUpload').click()">
                    <i data-lucide="image-up" class="w-6 h-6"></i>Carregar Novo Papel de Parede
                </button>

                <h3 class="text-xl text-center mt-5" style="color: var(--header-gold-text);">Layout da Ficha</h3>
                <div class="space-y-2">
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="toggle-section-attacks" class="h-5 w-5 mr-2" style="accent-color: var(--gold-glow);" onchange="toggleSectionVisibility('attacks', this.checked)">
                        <span class="text-base">Seção de Ataques</span>
                    </label>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="toggle-section-resources" class="h-5 w-5 mr-2" style="accent-color: var(--gold-glow);" onchange="toggleSectionVisibility('resources', this.checked)">
                        <span class="text-base">Seção de Recursos</span>
                    </label>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="toggle-section-conditions" class="h-5 w-5 mr-2" style="accent-color: var(--gold-glow);" onchange="toggleSectionVisibility('conditions', this.checked)">
                        <span class="text-base">Seção de Condições</span>
                    </label>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="toggle-section-personality" class="h-5 w-5 mr-2" style="accent-color: var(--gold-glow);" onchange="toggleSectionVisibility('personality', this.checked)">
                        <span class="text-base">Seção de Personalidade</span>
                    </label>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="toggle-section-musicPlayer" class="h-5 w-5 mr-2" style="accent-color: var(--gold-glow);" onchange="toggleSectionVisibility('musicPlayer', this.checked)">
                        <span class="text-base">Tocador de Músicas</span>
                    </label>
                </div>

            </div>
            <button class="gothic-btn mt-8 self-center text-lg" onclick="closeModal('settingsModal')">Fechar</button>
        </div>
    </div>

    <div id="attributeEditModal" class="modal">
        <div class="modal-content !max-w-md gothic-card p-6 flex flex-col">
            <h2 id="attribute-modal-title" class="text-3xl text-center mb-5" style="color: var(--header-gold-text);">Editar Atributo</h2>
            <div class="flex-grow flex flex-col items-center justify-center space-y-5">
                <label class="text-lg">Valor Base do Atributo</label>
                <div class="flex items-center gap-3">
                    <button class="gothic-btn !p-2" onclick="adjustAttributeScore(-1)"><i data-lucide="minus" class="w-5 h-5"></i></button>
                    <input id="attribute-modal-input" type="number" class="gothic-input text-5xl text-center h-24 w-32">
                    <button class="gothic-btn !p-2" onclick="adjustAttributeScore(1)"><i data-lucide="plus" class="w-5 h-5"></i></button>
                </div>
                <p class="text-lg" style="color: var(--header-gold-text);">Modificador: <span id="attribute-modal-modifier" class="font-bold text-2xl"></span></p>
            </div>
            <div class="flex justify-end gap-5 mt-5">
                <button class="gothic-btn text-lg" onclick="closeModal('attributeEditModal')">Fechar</button>
            </div>
        </div>
    </div>

    <div id="spellEditModal" class="modal">
        <div class="modal-content gothic-card p-6 flex flex-col">
            <h2 id="spell-modal-title" class="text-3xl text-center mb-5" style="color: var(--header-gold-text);">Criar Magia</h2>
            <div class="flex-grow overflow-y-auto pr-3 space-y-4">
                <div>
                    <label class="block text-sm font-bold mb-1">Nome da Magia</label>
                    <input type="text" id="spell-name-input" class="gothic-input text-base" placeholder="Nome da Magia">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold mb-1">Nível</label>
                        <input type="number" id="spell-level-input" class="gothic-input text-base" value="0" min="0" max="9">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1">Tempo de Conjuração</label>
                        <input type="text" id="spell-casting-time-input" class="gothic-input text-base" placeholder="1 Ação">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold mb-1">Alcance</label>
                        <input type="text" id="spell-range-input" class="gothic-input text-base" placeholder="18m">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1">Duração</label>
                        <input type="text" id="spell-duration-input" class="gothic-input text-base" placeholder="1 Minuto">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-2">Componentes</label>
                    <div class="flex items-center gap-4">
                        <label class="inline-flex items-center cursor-pointer"><input type="checkbox" id="comp-v" class="h-5 w-5 mr-2" style="accent-color: var(--gold-glow);">V</label>
                        <label class="inline-flex items-center cursor-pointer"><input type="checkbox" id="comp-s" class="h-5 w-5 mr-2" style="accent-color: var(--gold-glow);">S</label>
                        <label class="inline-flex items-center cursor-pointer"><input type="checkbox" id="comp-m" class="h-5 w-5 mr-2" style="accent-color: var(--gold-glow);">M</label>
                        <input type="text" id="spell-material-desc-input" class="gothic-input text-sm flex-grow" placeholder="Descrição Material (Opcional)">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">Descrição</label>
                    <textarea id="spell-description-input" class="gothic-textarea text-base h-32" placeholder="Descreva os efeitos da magia"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">Imagem da Magia (Opcional)</label>
                    <input type="file" id="spell-image-upload" class="hidden" accept="image/*">
                    <button class="gothic-btn w-full text-base" onclick="document.getElementById('spell-image-upload').click()">Carregar Imagem</button>
                </div>
            </div>
            <div class="flex justify-end gap-5 mt-5">
                <button class="gothic-btn text-lg" onclick="closeModal('spellEditModal')">Cancelar</button>
                <button class="gothic-btn text-lg" onclick="saveSpell()">Salvar Magia</button>
            </div>
        </div>
    </div>

    <div id="itemDetailModal" class="modal">
        <div class="modal-content !max-w-lg gothic-card p-6 flex flex-col">
            <h2 id="item-detail-name" class="text-3xl text-center mb-4" style="color: var(--header-gold-text);">Nome do Item</h2>
            <div class="flex-grow overflow-y-auto pr-3 space-y-4">
                <div class="flex flex-col items-center mb-4">
                    <img id="item-detail-image" src="" class="w-32 h-32 object-cover rounded-lg border-2 border-border-gold mb-2">
                </div>
                <div class="grid grid-cols-2 gap-3 text-base">
                    <div><span class="font-bold">Quantidade:</span> <span id="item-detail-qty"></span></div>
                    <div><span class="font-bold">Tipo:</span> <span id="item-detail-type"></span></div>
                    <div><span class="font-bold">Raridade:</span> <span id="item-detail-rarity"></span></div>
                    <div id="item-detail-damage-row" class="col-span-2 hidden"><span class="font-bold">Dano:</span> <span id="item-detail-damage"></span></div>
                    <div id="item-detail-vinculo-row" class="col-span-2 hidden"><span class="font-bold">Vínculo:</span> <span id="item-detail-vinculo"></span></div>
                </div>
                <div class="mt-4">
                    <p class="font-bold text-lg mb-2" style="color: var(--header-gold-text);">Notas:</p>
                    <p id="item-detail-notes" class="text-sm p-3"></p> </div>
                <div class="mt-4">
                    <p class="font-bold text-lg mb-2" style="color: var(--header-gold-text);">Bônus:</p>
                    <div id="item-detail-bonuses" class="text-sm space-y-1">
                        </div>
                    <p id="no-bonuses-message" class="text-sm opacity-70 italic hidden">Nenhum bônus para este item.</p>
                </div>
            </div>
            <div class="flex justify-end gap-5 mt-5">
                <button class="gothic-btn text-lg" onclick="openEditInventoryItemModal(currentDetailItemId)">Editar</button>
                <button class="gothic-btn text-lg" onclick="closeModal('itemDetailModal')">Fechar</button>
            </div>
        </div>
    </div>

    <div id="editInventoryItemModal" class="modal">
        <div class="modal-content gothic-card p-6 flex flex-col">
            <h2 id="edit-item-modal-title" class="text-3xl text-center mb-5" style="color: var(--header-gold-text);">Editar Item</h2>
            <div class="flex-grow overflow-y-auto pr-3 space-y-4">
                <div class="flex flex-col items-center justify-center space-y-2">
                    <img id="edit-item-image" src="https://placehold.co/192x192/000000/ffd700?text=?" class="w-24 h-24 object-cover rounded-lg border-2 border-border-gold">
                    <input type="file" id="edit-item-upload" class="hidden" accept="image/*">
                    <button class="gothic-btn text-xs py-1 px-2" onclick="document.getElementById('edit-item-upload').click()">Alterar Imagem</button>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">Nome do Item</label>
                    <input type="text" id="edit-item-name" class="gothic-input text-base" placeholder="Nome do Item">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold mb-1">Quantidade</label>
                        <div class="flex items-center gap-2">
                            <input type="number" id="edit-item-qty" class="gothic-input text-base flex-grow" value="1" min="1">
                            <label class="inline-flex items-center cursor-pointer text-sm">
                                <input type="checkbox" id="edit-item-is-single" class="h-4 w-4 mr-1" style="accent-color: var(--gold-glow);" onchange="toggleItemIsSingle(this.checked)">
                                Único
                            </label>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1">Tipo</label>
                        <select id="edit-item-type" class="gothic-select text-base" onchange="toggleEditItemDamageField()">
                            <option value="outro">Outro</option>
                            <option value="arma">Arma</option>
                            <option value="armadura">Armadura</option>
                            <option value="magico">Item Mágico</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">Raridade</label>
                    <select id="edit-item-rarity" class="gothic-select text-base">
                        <option value="comum">Comum</option>
                        <option value="incomum">Incomum</option>
                        <option value="raro">Raro</option>
                        <option value="muito raro">Muito Raro</option>
                        <option value="lendario">Lendário</option>
                        <option value="artefato">Artefato</option>
                    </select>
                </div>
                <div id="edit-item-damage-container" class="hidden">
                    <label class="block text-sm font-bold mb-1">Dano</label>
                    <input type="text" id="edit-item-damage" class="gothic-input text-base" placeholder="Dano (ex: 1d8 + MOD)">
                </div>
                <div id="edit-item-vinculo-container">
                    <label class="block text-sm font-bold mb-1">Vincular a Vínculo (Itens Chave)</label>
                    <select id="edit-item-linked-vinculo" class="gothic-select text-base">
                        <option value="">Nenhum</option>
                        </select>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">Notas</label>
                    <textarea id="edit-item-notes" class="gothic-textarea text-base h-24" placeholder="Notas sobre o item..."></textarea>
                </div>
                <div class="mt-4">
                    <h4 class="text-lg font-bold mb-2" style="color: var(--header-gold-text);">Bônus do Item:</h4>
                    <div id="edit-item-bonuses-list" class="text-sm space-y-2 mb-3">
                        </div>
                    <button class="gothic-btn text-base w-full" onclick="openItemBonusModal(currentEditingItemId)">Adicionar Novo Bônus</button>
                </div>
            </div>
            <div class="flex justify-end gap-5 mt-5">
                <button class="gothic-btn text-lg" onclick="closeModal('editInventoryItemModal')">Cancelar</button>
                <button class="gothic-btn text-lg" onclick="saveInventoryItem()">Salvar Item</button>
            </div>
        </div>
    </div>


    <div id="currencyModal" class="modal">
        <div class="modal-content !max-w-md gothic-card p-6 flex flex-col">
            <div id="currency-card"></div>
            <button class="gothic-btn mt-6 self-center text-lg" onclick="closeModal('currencyModal')">Fechar</button>
        </div>
    </div>

    <div id="vinculosModal" class="modal">
        <div class="modal-content gothic-card p-6 flex flex-col">
            <h2 class="text-3xl text-center mb-5" style="color: var(--header-gold-text);">Meus Vínculos</h2>
            <div class="text-right mb-4">
                <button onclick="addVinculo()" class="gothic-btn text-base">Adicionar Vínculo</button>
            </div>
            <div id="vinculosContainer" class="flex-grow overflow-y-auto space-y-5 pr-3"></div>
            <button class="gothic-btn mt-6 self-center text-lg" onclick="closeModal('vinculosModal')">Fechar</button>
        </div>
    </div>

    <div id="journalModal" class="modal">
        <div class="modal-content gothic-card p-6 flex flex-col">
            <h2 class="text-3xl text-center mb-5" style="color: var(--header-gold-text);">Diário de Bordo</h2>
            <textarea id="journalContent" class="gothic-textarea w-full flex-grow text-base" style="min-height: 400px;"></textarea>
            <button class="gothic-btn mt-6 self-center text-lg" onclick="closeModal('journalModal')">Fechar</button>
        </div>
    </div>

    <div id="diceRollerModal" class="modal">
        <div class="modal-content !max-w-md gothic-card p-6 flex flex-col">
            <h2 class="text-xl text-center mb-3" style="color: var(--header-gold-text);">Rolador de Dados</h2>
            <div class="grid grid-cols-3 gap-3 mb-3">
                <button class="gothic-btn text-base" onclick="selectDie(4)">D4</button>
                <button class="gothic-btn text-base" onclick="selectDie(6)">D6</button>
                <button class="gothic-btn text-base" onclick="selectDie(8)">D8</button>
                <button class="gothic-btn text-base" onclick="selectDie(10)">D10</button>
                <button class="gothic-btn text-base" onclick="selectDie(12)">D12</button>
                <button class="gothic-btn text-base" onclick="selectDie(20)">D20</button>
            </div>
            <div class="flex items-center gap-3 mb-3">
                <input id="diceQty" type="number" class="gothic-input w-1/3 text-center text-lg" value="1">
                <span id="diceType" class="text-2xl font-bold w-1/3 text-center">D20</span>
                <input id="diceMod" type="number" class="gothic-input w-1/3 text-center text-lg" value="0">
            </div>
            <div class="text-center mb-3">
                <label class="inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="addProficiencyToRoll" class="h-5 w-5 mr-2" style="accent-color: var(--gold-glow);">
                    <span class="text-base">Adicionar Proficiência?</span>
                </label>
            </div>
            <button class="gothic-btn w-full text-lg" onclick="rollDice()"><i data-lucide="dice-5" class="w-6 h-6"></i>Rolar</button>
            <div class="mt-3 text-center">
                <p class="text-lg">Resultado: <span id="rollResult" class="text-3xl font-bold" style="color: var(--header-gold-text);">0</span></p>
                <p class="text-sm opacity-75">Detalhes: <span id="rollDetail"></span></p>
            </div>
            <div class="mt-3 border-t border-yellow-800 pt-3">
                <h3 class="text-center text-base">Histórico</h3>
                <div id="rollHistory" class="text-sm text-center h-48 overflow-y-auto space-y-1 p-2"></div>
            </div>
            <button class="gothic-btn mt-6 self-center text-lg" onclick="closeModal('diceRollerModal')">Fechar</button>
        </div>
    </div>


    <div id="itemBonusModal" class="modal">
        <div class="modal-content !max-w-md gothic-card p-6 flex flex-col">
            <h2 class="text-3xl text-center mb-5" style="color: var(--header-gold-text);">Adicionar Bônus de Item</h2>
            <div class="space-y-4">
                <select id="bonus-type-select" class="gothic-select text-base" onchange="updateBonusTarget()">
                    <option value="attribute">Atributo</option>
                    <option value="skill">Perícia</option>
                    <option value="savingThrow">Teste de Resistência</option>
                    <option value="spellSaveDc">CD de Magia</option>
                    <option value="spellAttackBonus">Ataque de Magia</option>
                    <option value="ac">Classe de Armadura</option>
                    <option value="maxHp">HP Máximo</option>
                </select>
                <select id="bonus-target-select" class="gothic-select text-base"></select>
                <input id="bonus-value-input" type="number" class="gothic-input text-base" placeholder="Valor do Bônus (ex: 2 ou -1)">
            </div>
            <div class="flex justify-end gap-5 mt-5">
                <button class="gothic-btn text-lg" onclick="closeModal('itemBonusModal')">Cancelar</button>
                <button class="gothic-btn text-lg" onclick="saveItemBonus()">Salvar Bônus</button>
            </div>
        </div>
    </div>

    <div id="imageViewerModal" class="modal">
        <div class="modal-content">
            <img id="imageViewerImage" src="" alt="Imagem Ampliada">
            <button class="gothic-btn absolute top-4 right-4 !p-2" onclick="closeModal('imageViewerModal')">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
    </div>

    <div id="attackEditModal" class="modal">
        <div class="modal-content !max-w-lg gothic-card p-6 flex flex-col">
            <h2 id="attack-modal-title" class="text-3xl text-center mb-5" style="color: var(--header-gold-text);">Adicionar Ataque</h2>
            <div class="flex-grow overflow-y-auto pr-3 space-y-4">
                <div>
                    <label class="block text-sm font-bold mb-1">Nome do Ataque</label>
                    <input type="text" id="attack-name-input" class="gothic-input text-base" placeholder="Ex: Espada Longa, Raio de Fogo">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold mb-1">Bônus de Ataque</label>
                        <input type="text" id="attack-bonus-input" class="gothic-input text-base" placeholder="Ex: +5, +FOR, +DEST + PROF">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1">Dano</label>
                        <input type="text" id="attack-damage-input" class="gothic-input text-base" placeholder="Ex: 1d8 + 3 Perfurante">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">Tipo de Ataque</label>
                    <select id="attack-type-input" class="gothic-select text-base">
                        <option value="arma corpo a corpo">Arma Corpo a Corpo</option>
                        <option value="arma a distancia">Arma à Distância</option>
                        <option value="magia">Magia</option>
                        <option value="desarmado">Desarmado</option>
                        <option value="habilidade">Habilidade</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">Notas/Propriedades Especiais</label>
                    <textarea id="attack-notes-input" class="gothic-textarea text-base h-24" placeholder="Ex: Versátil (1d10), Duas Mãos"></textarea>
                </div>
            </div>
            <div class="flex justify-end gap-5 mt-5">
                <button class="gothic-btn text-lg" onclick="closeModal('attackEditModal')">Cancelar</button>
                <button class="gothic-btn text-lg" onclick="saveAttack()">Salvar Ataque</button>
            </div>
        </div>
    </div>

    <div id="spendHitDiceModal" class="modal">
        <div class="modal-content !max-w-sm gothic-card p-6 flex flex-col">
            <h2 class="text-3xl text-center mb-5" style="color: var(--header-gold-text);">Gastar Dados de Vida</h2>
            <div class="space-y-4">
                <p class="text-center">Dados de Vida Disponíveis: <span id="available-hd-count" class="font-bold">0</span> (<span id="hd-type-display">d8</span>)</p>
                <div>
                    <label class="block text-sm font-bold mb-1">Quantos Dados de Vida Gastar?</label>
                    <input type="number" id="num-hd-to-spend" class="gothic-input text-center text-xl" value="1" min="1">
                </div>
                <p id="hd-roll-result" class="text-center text-lg mt-2 font-bold" style="color: var(--success-text);"></p>
            </div>
            <div class="flex justify-end gap-5 mt-5">
                <button class="gothic-btn text-lg" onclick="closeModal('spendHitDiceModal')">Cancelar</button>
                <button class="gothic-btn text-lg" onclick="performSpendHitDice()">Gastar!</button>
            </div>
        </div>
    </div>

    <div id="resourceEditModal" class="modal">
        <div class="modal-content !max-w-lg gothic-card p-6 flex flex-col">
            <h2 id="resource-modal-title" class="text-3xl text-center mb-5" style="color: var(--header-gold-text);">Adicionar Recurso</h2>
            <div class="flex-grow overflow-y-auto pr-3 space-y-4">
                <div>
                    <label class="block text-sm font-bold mb-1">Nome do Recurso/Habilidade</label>
                    <input type="text" id="resource-name-input" class="gothic-input text-base" placeholder="Ex: Fúria, Rajada Mística">
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">Descrição</label>
                    <textarea id="resource-description-input" class="gothic-textarea text-base h-24" placeholder="Descreva o efeito e como funciona..."></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold mb-1">Tipo</label>
                        <select id="resource-type-input" class="gothic-select text-base">
                            <option value="class-feature">Característica de Classe</option>
                            <option value="racial-trait">Traço Racial</option>
                            <option value="feat">Talento</option>
                            <option value="other">Outro</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1">Redefine em</label>
                        <select id="resource-reset-input" class="gothic-select text-base" onchange="toggleResourceUses()">
                            <option value="at-will">À Vontade (At-Will)</option>
                            <option value="short-rest">Descanso Curto</option>
                            <option value="long-rest">Descanso Longo</option>
                            <option value="once-per-day">Uma Vez por Dia</option>
                            <option value="other">Outro</option>
                        </select>
                    </div>
                </div>
                <div id="resource-uses-container" class="grid grid-cols-2 gap-4 hidden">
                    <div>
                        <label class="block text-sm font-bold mb-1">Usos Atuais</label>
                        <input type="number" id="resource-uses-current-input" class="gothic-input text-base" value="0" min="0">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1">Usos Máximos</label>
                        <input type="number" id="resource-uses-max-input" class="gothic-input text-base" value="0" min="0">
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-5 mt-5">
                <button class="gothic-btn text-lg" onclick="closeModal('resourceEditModal')">Cancelar</button>
                <button class="gothic-btn text-lg" onclick="saveResource()">Salvar Recurso</button>
            </div>
        </div>
    </div>

    <div id="conditionModal" class="modal">
        <div class="modal-content !max-w-md gothic-card p-6 flex flex-col">
            <h2 class="text-3xl text-center mb-5" style="color: var(--header-gold-text);">Gerenciar Condições</h2>
            <div id="allConditionsList" class="flex-grow overflow-y-auto pr-3 space-y-3">
                </div>
            <button class="gothic-btn mt-6 self-center text-lg" onclick="closeModal('conditionModal')">Fechar</button>
        </div>
    </div>

    <div id="nowPlayingPopup"></div>
    <div id="messagePopup" class="message-popup"></div>

    <script>
        // --- FUNÇÃO DE DEBOUNCE ---
        // Prevê que uma função seja executada várias vezes em um curto período,
        // aguardando o término de um tempo de 'inactividade' antes de chamá-la.
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        // --- ESTRUTURA DE DADOS E VALORES PADRÃO ---
        let characterData = {};
        let currentItemBonusId = null; // Usado para adicionar bônus a um item específico
        let currentEditingItemId = null; // Usado para a edição do item no modal
        let currentDetailItemId = null; // Usado para o item exibido no modal de detalhes
        let currentEditingAttackIndex = null; // Para edição de ataques
        let currentEditingResourceIndex = null; // NOVO: Para edição de recursos
        let currentInventoryListTab = 'equip';
        let tempSpellImage = null;
        let tempEditItemImage = null; // Para a imagem temporária no modal de edição de item
        let audioPlayer = new Audio();
        let currentTrackIndex = -1;
        let localPlaylist = [];
        let nowPlayingTimeout; // Para o pop-up de 'Tocando Agora'
        let messageTimeout; // Para o pop-up de mensagens gerais

        const defaultImagePlaceholder = "https://placehold.co/192x192/000000/ffd700?text=?";
        const ATTRIBUTES = [
            { id: 'str', name: 'Força', abbr: 'FOR' },
            { id: 'dex', name: 'Destreza', abbr: 'DES' },
            { id: 'con', name: 'Constituição', abbr: 'CON' },
            { id: 'int', name: 'Inteligência', abbr: 'INT' },
            { id: 'wis', name: 'Sabedoria', abbr: 'SAB' },
            { id: 'cha', name: 'Carisma', abbr: 'CAR' }
        ];
        const SKILLS = [
            { name: 'Acrobacia', attr: 'dex', passive: false },
            { name: 'Arcanismo', attr: 'int', passive: false },
            { name: 'Atletismo', attr: 'str', passive: false },
            { name: 'Atuação', attr: 'cha', passive: false },
            { name: 'Enganação', attr: 'cha', passive: false },
            { name: 'Furtividade', attr: 'dex', passive: false },
            { name: 'História', attr: 'int', passive: false },
            { name: 'Intimidação', attr: 'cha', passive: false },
            { name: 'Intuição', attr: 'wis', passive: true, slug: 'insight' },
            { name: 'Investigação', attr: 'int', passive: true, slug: 'investigation' },
            { name: 'Lidar com Animais', attr: 'wis', passive: false },
            { name: 'Medicina', attr: 'wis', passive: false },
            { name: 'Natureza', attr: 'int', passive: false },
            { name: 'Percepção', attr: 'wis', passive: true, slug: 'perception' },
            { name: 'Persuasão', attr: 'cha', passive: false },
            { name: 'Prestidigitação', attr: 'dex', passive: false },
            { name: 'Religião', attr: 'int', passive: false },
            { name: 'Sobrevivência', attr: 'wis', passive: false }
        ];
        // NOVO: Lista de condições de status D&D 5e
        const CONDITIONS = [
            { name: 'Amedrontado', description: 'Desvantagem em testes de habilidade e ataques, não pode se aproximar da fonte do medo.' },
            { name: 'Cego', description: 'O alvo não pode ver e falha automaticamente em qualquer teste de característica que exija visão. Ataques contra o alvo têm vantagem, e os ataques do alvo têm desvantagem.' },
            { name: 'Enfeitiçado', description: 'Não pode atacar o enfeitiçador, e o enfeitiçador tem vantagem em qualquer teste de característica para interagir socialmente com o alvo.' },
            { name: 'Exausto (Nível 1)', description: 'Desvantagem em testes de característica.' },
            { name: 'Exausto (Nível 2)', description: 'Velocidade reduzida pela metade.' },
            { name: 'Exausto (Nível 3)', description: 'Desvantagem em testes de ataque e testes de resistência.' },
            { name: 'Exausto (Nível 4)', description: 'PV máximos reduzidos pela metade.' },
            { name: 'Exausto (Nível 5)', description: 'Velocidade de movimento 0.' },
            { name: 'Exausto (Nível 6)', description: 'Morte.' },
            { name: 'Envenenado', description: 'Desvantagem em testes de ataque e habilidades.' },
            { name: 'Incapacitado', description: 'Não pode realizar ações ou reações, deslocamento é zero.' },
            { name: 'Invisível', description: 'Ataques têm vantagem e defensores têm desvantagem, mas ainda pode ser detectado de outras formas (Ex: por ruídos ou rastros).' },
            { name: 'Paralisado', description: 'Incapacitado, não pode se mover ou falar, desvantagem em salvaguardas de Força e Destreza, ataques contra o alvo têm vantagem e são acertos críticos se a 1.5m.' },
            { name: 'Petrificado', description: 'Transformado em pedra, incapacitado e com deslocamento zero, resistente a todos os danos, exceto àqueles que podem afetar pedra. Imune a veneno e doença. Não se cura naturalmente ou magicamente.' },
            { name: 'Surdo', description: 'Falha automática em testes de percepção baseados em audição.' },
            { name: 'Caído', description: 'A única ação que um alvo caído pode realizar é se levantar, o que consome metade de seu movimento. Ataques à distância contra o alvo têm desvantagem. Ataques corpo a corpo contra o alvo têm vantagem.' },
            { name: 'Agarrado', description: 'Deslocamento é zero. A condição termina se o agarrador estiver incapacitado ou se o alvo estiver fora do alcance do agarrador.' },
            { name: 'Impedido', description: 'Deslocamento é zero.' },
            { name: 'Inconsciente', description: 'Incapacitado e caído, deslocamento é zero, não pode ser afetado por reações. Ataques contra o alvo têm vantagem e são acertos críticos se o atacante estiver a até 1,5 metro do alvo.' },
            { name: 'Amordaçado', description: 'O alvo não pode falar ou fornecer componentes verbais de magias.' }, // Moved and updated description from original
            { name: 'Contido', description: 'A velocidade do alvo se torna 0 e não pode se beneficiar de qualquer bônus em sua velocidade. Desvantagem em testes de ataque e testes de Destreza. Ataques contra o alvo têm vantagem.' }, // Kept existing
            { name: 'Atordoado', description: 'Um alvo atordoado está incapacitado, não pode se mover e só pode falar de forma limitada. O alvo falha automaticamente em testes de resistência de Força e Destreza.' } // Kept existing
        ];


        const portugueseAttr = {str: 'FOR', dex: 'DES', con: 'CON', int: 'INT', wis: 'SAB', cha: 'CAR'};

        // Lista de todas as cores personalizáveis
        const THEME_COLORS = [
            { label: 'Brilho Principal', var: '--gold-glow' },
            { label: 'Brilho Hover', var: '--gold-glow-hover' },
            { label: 'Texto Principal', var: '--text-primary' },
            { label: 'Fundo Escuro', var: '--bg-dark-transparent' },
            { label: 'Borda Dourada', var: '--border-gold' },
            { label: 'Cor do Sucesso', var: '--green-success' },
            { label: 'Cor da Falha', var: '--red-failure' },
            { label: 'Fundo Transparente', var: '--black-transparent' },
            { label: 'HP Grad. Início', var: '--hp-gradient-start' },
            { label: 'HP Grad. Fim', var: '--hp-gradient-end' },
            { label: 'Cor dos Títulos', var: '--header-gold-text' },
            { label: 'Cor do Texto de Sucesso', var: '--success-text' },
            { label: 'Cor do Texto de Falha', var: '--failure-text' }
        ];

        // Cores específicas para o brilho etéreo (chamas)
        const FLAME_COLORS = [
            { label: 'Cor Principal Chama', var: '--flame-orange' },
            { label: 'Cor Secundária Chama', var: '--flame-yellow' },
            { label: 'Cor Terciária Chama', var: '--flame-red' },
            { label: 'Intensidade Brilho Etéreo', var: '---flame-spread-factor', type: 'range', min: 0.1, max: 2.0, step: 0.05 }
        ];

        // Paletas de cores para modos Radiante e Necrótico
        const COLOR_PALETTES = {
            'radiant': {
                '--gold-glow': '#ffd700',
                '--gold-glow-hover': '#ffec80',
                '--text-primary': '#f0f0f0',
                '--border-gold': 'rgba(255, 215, 0, 0.6)',
                '--green-success': '#22c55e',
                '--red-failure': '#ef4444',
                '--black-transparent': 'rgba(0, 0, 0, 0.6)',
                '--hp-gradient-start': '#6b0000',
                '--hp-gradient-end': '#ff0000',
                '--flame-orange': 'rgba(255, 165, 0, 0.7)',
                '--flame-yellow': 'rgba(255, 200, 0, 0.5)',
                '--flame-red': 'rgba(255, 100, 0, 0.3)',
                '--flame-orange-alt': 'rgba(255, 180, 0, 0.8)',
                '--flame-yellow-alt': 'rgba(255, 210, 0, 0.6)',
                '--flame-red-alt': 'rgba(255, 80, 0, 0.4)',
                '--header-gold-text': '#ffd700',
                '--success-text': '#22c55e',
                '--failure-text': '#ef4444'
            },
            'necrotic': {
                '--gold-glow': '#00E6E6', /* Bright Cyan */
                '--gold-glow-hover': '#00FFFF', /* Even brighter Cyan */
                '--text-primary': '#A0A0A0', /* Darker grey for readability on dark backgrounds */
                '--border-gold': 'rgba(0, 150, 150, 0.6)', /* Darker teal for borders */
                '--green-success': '#7CFC00', /* Lime Green */
                '--red-failure': '#8B008B', /* Dark Magenta/Purple */
                '--black-transparent': 'rgba(0, 0, 0, 0.7)',
                '--hp-gradient-start': '#4B0082', /* Indigo - deep purple */
                '--hp-gradient-end': '#800080', /* Purple */
                '--flame-orange': 'rgba(0, 180, 180, 0.7)', /* Teal flame start */
                '--flame-yellow': 'rgba(0, 220, 220, 0.5)', /* Lighter teal flame */
                '--flame-red': 'rgba(0, 120, 120, 0.3)', /* Darker teal flame */
                '--flame-orange-alt': 'rgba(0, 190, 190, 0.8)',
                '--flame-yellow-alt': 'rgba(0, 230, 230, 0.6)',
                '--flame-red-alt': 'rgba(0, 130, 130, 0.4)',
                '--header-gold-text': '#00E6E6',
                '--success-text': '#7CFC00',
                '--failure-text': '#8B008B'
            }
        };

        const ITEM_RARITIES = [
            'comum', 'incomum', 'raro', 'muito raro', 'lendario', 'artefato'
        ];

        function initializeDefaultData() {
            characterData = {
                name: '', characterClass: '', characterLevel: 1, race: '', image: defaultImagePlaceholder, spellcastingAbility: 'int',
                ac: 10, speed: '9m',
                hp: { current: 10, max: 10, temp: 0, hitDice: { current: 1, max: 1, type: 'd8' } }, // Default 1d8 for level 1
                deathSaves: { successes: [false, false, false], failures: [false, false, false] },
                attributes: { str: 10, dex: 10, con: 10, int: 10, wis: 10, cha: 10 },
                savingThrows: {}, skills: {}, inventory: [], keyInventory: [], spells: [], spellSlots: {},
                journal: '', rollHistory: [], vinculos: [], currency: { cp: 0, sp: 0, ep: 0, gp: 0, pp: 0 },
                theme: {
                    colors: {},
                    wallpaper: '',
                    musicPlayerEnabled: false,
                    flameGlowEnabled: true,
                    mode: 'radiant',
                    currentTab: 'character-tab', // NEW: Default active tab
                    sectionVisibility: { // NEW: To store visibility of major sections
                        attacks: true,
                        resources: true,
                        conditions: true,
                        personality: true,
                        musicPlayer: false
                    }
                },
                // Proficiências Adicionais
                proficiencies: {
                    armors: '',
                    weapons: '',
                    tools: ''
                },
                // Sentidos Passivos (calculados, não salvos diretamente)
                passiveSenses: {
                    perception: 0,
                    investigation: 0,
                    insight: 0
                },
                // Dados de Combate
                combat: {
                    attacks: [], // Array de objetos de ataque
                    resources: [], // NOVO: Array de recursos de classe/habilidades
                    conditions: [] // NOVO: Array de condições ativas (apenas nomes ou IDs)
                },
                // NOVO: Registro de Descansos
                rests: {
                    short: 0,
                    long: 0
                },
                // NOVO: Personalidade e Antecedentes
                personality: { // Adicionado para Personalidade e Antecedentes
                    traits: '',
                    ideals: '',
                    flaws: '',
                    history: '',
                    organizations: ''
                }
            };
            ATTRIBUTES.forEach(attr => { characterData.savingThrows[attr.id] = { proficient: false, advantage: false }; });
            SKILLS.forEach(skill => { characterData.skills[skill.name.toLowerCase().replace(/ /g, '-')] = { proficient: false, advantage: false }; });
            for(let i=1; i<=9; i++) { characterData.spellSlots[i] = { current: 0, max: 0 }; }

            // Define as cores padrão do tema Radiante ao inicializar
            Object.assign(characterData.theme.colors, COLOR_PALETTES['radiant']);
            // Define a intensidade padrão do brilho etéreo
            characterData.theme.colors['--flame-spread-factor'] = 1.0;
        }

        // --- PERSISTÊNCIA DE DADOS ---
        function saveData() { localStorage.setItem('dndGothicSheetV13', JSON.stringify(characterData)); }

        function loadData() {
            const savedData = localStorage.getItem('dndGothicSheetV13');
            if (savedData) {
                characterData = JSON.parse(savedData);
                // Migrações e valores padrão para novos campos, se necessário
                if (!characterData.vinculos) characterData.vinculos = [];
                if (!characterData.spellcastingAbility) characterData.spellcastingAbility = 'int';
                if (!characterData.currency) characterData.currency = { cp: 0, sp: 0, ep: 0, gp: 0, pp: 0 };
                if (!characterData.keyInventory) characterData.keyInventory = [];
                if (!characterData.theme) characterData.theme = { colors: {}, wallpaper: '', musicPlayerEnabled: false, flameGlowEnabled: true, mode: 'radiant' };
                if (characterData.theme.musicPlayerEnabled === undefined) characterData.theme.musicPlayerEnabled = false;
                if (characterData.theme.flameGlowEnabled === undefined) characterData.theme.flameGlowEnabled = true;
                if (characterData.theme.mode === undefined) characterData.theme.mode = 'radiant';

                // NOVO: Migração para currentTab
                if (!characterData.theme.currentTab) characterData.theme.currentTab = 'character-tab';

                // Garante que todas as cores da paleta atual estejam no characterData.theme.colors
                Object.assign(characterData.theme.colors, COLOR_PALETTES[characterData.theme.mode], characterData.theme.colors);
                // Garante que flame-spread-factor esteja presente
                if (characterData.theme.colors['--flame-spread-factor'] === undefined) characterData.theme.colors['--flame-spread-factor'] = 1.0;
                
                if (!characterData.savingThrows) {
                    characterData.savingThrows = {};
                    ATTRIBUTES.forEach(attr => { characterData.savingThrows[attr.id] = { proficient: false, advantage: false }; });
                }
                Object.values(characterData.savingThrows).forEach(s => { if(s.advantage === undefined) s.advantage = false; });
                Object.values(characterData.skills).forEach(s => { if(s.advantage === undefined) s.advantage = false; });

                // Migração para novos campos de item (rarity, isSingle)
                ['inventory', 'keyInventory'].forEach(invType => {
                    characterData[invType].forEach(item => {
                        if (item.rarity === undefined) item.rarity = 'comum';
                        if (item.isSingle === undefined) item.isSingle = false;
                    });
                });

                // Migração para proficiências adicionais
                if (!characterData.proficiencies) {
                    characterData.proficiencies = { armors: '', weapons: '', tools: '' };
                }
                // Inicializa passiveSenses (não precisa migrar dados antigos, pois é calculado)
                characterData.passiveSenses = { perception: 0, investigation: 0, insight: 0 };

                // Migração para dados de combate
                if (!characterData.combat) {
                    characterData.combat = { attacks: [], resources: [], conditions: [] }; // Incluindo resources e conditions
                } else {
                    if (!characterData.combat.attacks) characterData.combat.attacks = [];
                    if (!characterData.combat.resources) {
                        characterData.combat.resources = [];
                    } else {
                        // Migração de estrutura para recursos antigos
                        characterData.combat.resources.forEach(res => {
                            if (res.uses === undefined) {
                                // Adiciona usos padrão se não existir (para compatibilidade com dados antigos)
                                res.uses = { current: 0, max: 0, reset: 'other' };
                                if (res.name.toLowerCase().includes('fúria')) { // Exemplo de migração inteligente
                                    res.uses.current = 2; // Exemplo
                                    res.uses.max = 2; // Exemplo
                                    res.uses.reset = 'long-rest';
                                }
                            }
                            if (res.uses.reset === undefined) res.uses.reset = 'other';
                        });
                    }
                    if (!characterData.combat.conditions) characterData.combat.conditions = []; // NOVO: Migração de condições
                }

                // NOVO: Migração para dados de vida e descansos
                if (!characterData.hp.hitDice) characterData.hp.hitDice = { current: characterData.characterLevel, max: characterData.characterLevel, type: 'd8' };
                if (!characterData.rests) characterData.rests = { short: 0, long: 0 };

                // NOVO: Migração para Personalidade e Antecedentes
                if (!characterData.personality) {
                    characterData.personality = { traits: '', ideals: '', flaws: '', history: '', organizations: '' };
                }

                // NOVO: Migração para Layout da Ficha
                if (!characterData.theme.sectionVisibility) {
                    const defaultSectionVisibility = {
                        attacks: true,
                        resources: true,
                        conditions: true,
                        personality: true,
                        musicPlayer: characterData.theme.musicPlayerEnabled || false
                    };
                    characterData.theme.sectionVisibility = defaultSectionVisibility;
                } else {
                    // Ensure all sections have a visibility state, set to true if not defined
                    const defaultSectionVisibility = {
                        attacks: true,
                        resources: true,
                        conditions: true,
                        personality: true,
                        musicPlayer: characterData.theme.musicPlayerEnabled || false
                    };
                    for (const section in defaultSectionVisibility) {
                        if (characterData.theme.sectionVisibility[section] === undefined) {
                            characterData.theme.sectionVisibility[section] = defaultSectionVisibility[section];
                        }
                    }
                }

            } else { initializeDefaultData(); }
        }

        function populateUIFromData() {
            document.getElementById('characterName').value = characterData.name;
            document.getElementById('characterClass').value = characterData.characterClass;
            const characterLevelDisplay = document.getElementById('characterLevelDisplay');
            if (characterLevelDisplay) characterLevelDisplay.textContent = characterData.characterLevel;

            document.getElementById('characterRace').value = characterData.race;
            document.getElementById('charImage').src = characterData.image;
            document.getElementById('hpCurrent').value = characterData.hp.current;
            document.getElementById('hpMax').value = characterData.hp.max;
            document.getElementById('hpTemp').value = characterData.hp.temp;
            document.getElementById('journalContent').value = characterData.journal;
            
            const spellcastingAbilitySelect = document.getElementById('spellcasting-ability');
            if (spellcastingAbilitySelect) {
                spellcastingAbilitySelect.value = characterData.spellcastingAbility;
            } else {
                characterData.spellcastingAbility = characterData.spellcastingAbility || 'int';
            }
            document.getElementById('ac').value = characterData.ac;

            // Popular proficiências adicionais
            document.getElementById('prof-armors').value = characterData.proficiencies.armors;
            document.getElementById('prof-weapons').value = characterData.proficiencies.weapons;
            document.getElementById('prof-tools').value = characterData.proficiencies.tools;

            // NOVO: Popular Dados de Vida e Descansos
            document.getElementById('hit-dice-current').value = characterData.hp.hitDice.current;
            document.getElementById('hit-dice-max').value = characterData.hp.hitDice.max;
            document.getElementById('hit-dice-type').value = characterData.hp.hitDice.type;
            document.getElementById('short-rests-count').textContent = characterData.rests.short;
            document.getElementById('long-rests-count').textContent = characterData.rests.long;

            // NOVO: Popular Personalidade e Antecedentes
            document.getElementById('personalityTraits').value = characterData.personality.traits;
            document.getElementById('ideals').value = characterData.personality.ideals;
            document.getElementById('flaws').value = characterData.personality.flaws;
            document.getElementById('characterHistory').value = characterData.personality.history;
            document.getElementById('organizations').value = characterData.personality.organizations;


            applyTheme();
            renderAttributeBar();
            renderAbilitySkillGroups();
            renderSpells();
            renderInventory(); // Agora renderiza a visualização em grid
            renderCurrency();
            renderVinculos();
            renderDeathSaves();
            renderRollHistory();
            renderThemeSettings(); // Atualiza os checkboxes de layout
            renderAttacks(); // Renderiza os ataques
            renderResources(); // NOVO: Renderiza os recursos
            renderActiveConditions(); // NOVO: Renderiza as condições ativas
            updateAllCalculations(); // Chamar aqui para garantir que os sentidos passivos sejam calculados

            // Set initial active tab and apply section visibility
            switchTab(characterData.theme.currentTab);
            for (const section in characterData.theme.sectionVisibility) {
                // Ensure musicPlayer visibility is synced with its dedicated toggle
                if (section === 'musicPlayer') {
                    const musicPlayerToggleCheckbox = document.getElementById('toggle-section-musicPlayer');
                    if (musicPlayerToggleCheckbox) {
                        musicPlayerToggleCheckbox.checked = characterData.theme.sectionVisibility[section];
                    }
                    toggleMusicPlayerVisibility(characterData.theme.sectionVisibility[section], false); // Don't save again
                } else {
                    const checkbox = document.getElementById(`toggle-section-${section}`);
                    if (checkbox) {
                        checkbox.checked = characterData.theme.sectionVisibility[section];
                    }
                    toggleSectionVisibility(section, characterData.theme.sectionVisibility[section], false); // Don't save again
                }
            }
            updateCharImageDisplay(); // Initial call to set image and overlay state
        }

        // Debounced function for general UI data collection and calculation updates
        const debouncedCollectDataAndRecalculate = debounce(() => {
            collectDataFromUI();
            updateAllCalculations();
        }, 300);

        // Debounced para proficiências adicionais
        const debouncedUpdateProficiencies = debounce((type, value) => {
            characterData.proficiencies[type] = value;
            saveData();
        }, 300);

        // NOVO: Debounced para Dados de Vida
        const debouncedUpdateHitDice = debounce(() => {
            characterData.hp.hitDice.current = parseInt(document.getElementById('hit-dice-current').value) || 0;
            characterData.hp.hitDice.max = parseInt(document.getElementById('hit-dice-max').value) || 0;
            characterData.hp.hitDice.type = document.getElementById('hit-dice-type').value;
            saveData();
            updateAllCalculations(); // Recalcular caso afete algo (ex: Max HP por Talentos)
        }, 300);


        function collectDataFromUI() {
            characterData.name = document.getElementById('characterName').value;
            characterData.characterClass = document.getElementById('characterClass').value;
            characterData.race = document.getElementById('characterRace').value;
            characterData.ac = parseInt(document.getElementById('ac').value) || 10;
            characterData.hp.current = parseInt(document.getElementById('hpCurrent').value) || 0;
            characterData.hp.max = parseInt(document.getElementById('hpMax').value) || 0;
            characterData.hp.temp = parseInt(document.getElementById('hpTemp').value) || 0;
            characterData.journal = document.getElementById('journalContent').value;
            
            const spellcastingAbilitySelect = document.getElementById('spellcasting-ability');
            if (spellcastingAbilitySelect) {
                characterData.spellcastingAbility = spellcastingAbilitySelect.value;
            } else {
                characterData.spellcastingAbility = characterData.spellcastingAbility || 'int';
            }
            // NOVO: Coleta de dados da seção Personalidade e Antecedentes
            characterData.personality.traits = document.getElementById('personalityTraits').value;
            characterData.personality.ideals = document.getElementById('ideals').value;
            characterData.personality.flaws = document.getElementById('flaws').value;
            characterData.personality.history = document.getElementById('characterHistory').value;
            characterData.personality.organizations = document.getElementById('organizations').value;

            saveData();
        }

        function adjustLevel(delta) {
            let newLevel = characterData.characterLevel + delta;
            if (newLevel < 1) newLevel = 1;
            if (newLevel > 20) newLevel = 20;
            characterData.characterLevel = newLevel;
            document.getElementById('characterLevelDisplay').textContent = characterData.characterLevel;
            collectDataFromUI();
            updateAllCalculations();
        }

        let currentAttrModalId = '';
        function adjustAttributeScore(delta) {
            if (!currentAttrModalId) return;
            let currentScore = characterData.attributes[currentAttrModalId];
            let newScore = currentScore + delta;
            if (newScore < 1) newScore = 1;

            characterData.attributes[currentAttrModalId] = newScore;
            const input = document.getElementById('attribute-modal-input');
            const modifierSpan = document.getElementById('attribute-modal-modifier');
            input.value = newScore;
            modifierSpan.textContent = calculateModifier(newScore) >= 0 ? `+${calculateModifier(newScore)}` : calculateModifier(newScore);
            updateAllCalculations();
            saveData();
        }

        // --- CÁLCULOS E ATUALIZAÇÕES DA UI ---
        const getLevel = () => parseInt(characterData.characterLevel || 1);
        const calculateProficiencyBonus = () => Math.ceil(1 + getLevel() / 4);
        const calculateModifier = (score) => Math.floor((score - 10) / 2);

        function calculateAllItemBonuses() {
            const allItems = [...characterData.inventory, ...characterData.keyInventory];
            const totalBonuses = { attributes: {}, skills: {}, savingThrows: {}, spellSaveDc: 0, spellAttackBonus: 0, ac: 0, maxHp: 0 };
            for (const item of allItems) {
                if (!item.bonuses) continue;
                for (const bonus of item.bonuses) {
                    switch (bonus.type) {
                        case 'attribute':
                        case 'skill':
                        case 'savingThrow':
                            const category = bonus.type === 'attribute' ? 'attributes' : (bonus.type === 'skill' ? 'skills' : 'savingThrows');
                            totalBonuses[category][bonus.target] = (totalBonuses[category][bonus.target] || 0) + bonus.value;
                            break;
                        default:
                            totalBonuses[bonus.type] = (totalBonuses[bonus.type] || 0) + bonus.value;
                            break;
                    }
                }
            }
            return totalBonuses;
        }

        function updateAllCalculations() {
            const profBonus = calculateProficiencyBonus();
            const itemBonuses = calculateAllItemBonuses();
            
            const proficiencyBonusDisplayEl = document.getElementById('proficiencyBonusDisplay');
            if (proficiencyBonusDisplayEl) proficiencyBonusDisplayEl.textContent = `+${profBonus}`;

            const finalMaxHp = (parseInt(characterData.hp.max) || 0) + itemBonuses.maxHp;
            document.getElementById('hpMax').value = finalMaxHp;
            const finalAC = (parseInt(characterData.ac) || 10) + itemBonuses.ac;
            document.getElementById('ac').value = finalAC;

            ATTRIBUTES.forEach(attr => {
                const baseScore = characterData.attributes[attr.id] || 10;
                const finalScore = baseScore + (itemBonuses.attributes[attr.id] || 0);
                const modifier = calculateModifier(finalScore);

                const scoreDisplayEl = document.querySelector(`.attribute-item[data-attr='${attr.id}'] .attr-score-display`);
                if(scoreDisplayEl) scoreDisplayEl.textContent = finalScore;

                const modifierPopupEl = document.querySelector(`.attribute-item[data-attr='${attr.id}'] .attr-modifier`);
                if(modifierPopupEl) modifierPopupEl.textContent = `${modifier >= 0 ? '+' : ''}${modifier}`;

                if (attr.id === 'dex') {
                    const initiativeEl = document.getElementById('initiative');
                    if (initiativeEl) {
                        initiativeEl.textContent = modifier >= 0 ? `+${modifier}` : modifier;
                    }
                }

                const saveProf = characterData.savingThrows[attr.id]?.proficient || false;
                const totalSave = modifier + (saveProf ? profBonus : 0) + (itemBonuses.savingThrows[attr.id] || 0);
                const saveTotalEl = document.getElementById(`save-total-${attr.id}`);
                if (saveTotalEl) saveTotalEl.textContent = totalSave >= 0 ? `+${totalSave}` : totalSave;
            });

            SKILLS.forEach(skill => {
                const skillId = skill.name.toLowerCase().replace(/ /g, '-');
                const baseAttrScore = characterData.attributes[skill.attr] || 10;
                const itemAttrBonus = itemBonuses.attributes[skill.attr] || 0;
                const modifier = calculateModifier(baseAttrScore + itemAttrBonus);
                const skillProf = characterData.skills[skillId]?.proficient || false;
                const totalSkill = modifier + (skillProf ? profBonus : 0) + (itemBonuses.skills[skillId] || 0);
                const skillTotalEl = document.getElementById(`skill-total-${skillId}`);
                if(skillTotalEl) skillTotalEl.textContent = totalSkill >= 0 ? `+${totalSkill}` : totalSkill;

                // Cálculo dos Sentidos Passivos
                if (skill.passive) {
                    const passiveScore = 10 + totalSkill; // Fórmula Padrão: 10 + Modificador de Perícia Total
                    // Usa skill.slug se definido, caso contrário, tenta a conversão para minúsculas
                    const passiveElementId = `passive-${skill.slug || skill.name.toLowerCase().replace(/[^a-z0-9]/g, '')}`;
                    const passiveElement = document.getElementById(passiveElementId);
                    if (passiveElement) {
                        passiveElement.textContent = passiveScore;
                        characterData.passiveSenses[skill.slug || skill.name.toLowerCase().replace(/[^a-z0-9]/g, '')] = passiveScore;
                    }
                }
            });

            updateHpBar();
            updateSpellSlots();
            updateSpellcastingStats();
        }

        function updateSpellcastingStats() {
            const itemBonuses = calculateAllItemBonuses();
            const ability = characterData.spellcastingAbility;
            const baseScore = characterData.attributes[ability] || 10;
            const itemAttrBonus = itemBonuses.attributes[ability] || 0;
            const modifier = calculateModifier(baseScore + itemAttrBonus);
            const profBonus = calculateProficiencyBonus();
            const dc = 8 + profBonus + modifier + itemBonuses.spellSaveDc;
            const attackBonus = profBonus + modifier + itemBonuses.spellAttackBonus;
            
            const spellSaveDcEl = document.getElementById('spell-save-dc');
            if (spellSaveDcEl) spellSaveDcEl.textContent = dc;
            
            const spellAttackBonusEl = document.getElementById('spell-attack-bonus');
            if (spellAttackBonusEl) spellAttackBonusEl.textContent = attackBonus >= 0 ? `+${attackBonus}` : attackBonus;
        }

        function updateHpBar() {
            const current = parseInt(document.getElementById('hpCurrent').value) || 0;
            const max = parseInt(document.getElementById('hpMax').value) || 1;
            const percentage = Math.max(0, Math.min(100, (current / max) * 100));
            const bar = document.getElementById('hpBar');
            bar.style.width = `${percentage}%`;
            bar.textContent = `${current} / ${max}`;
        }

        // --- FUNÇÕES DE RENDERIZAÇÃO ---
        function renderAttributeBar() {
            const container = document.getElementById('attribute-bar');
            if (!container) return;

            container.innerHTML = '';

            ATTRIBUTES.forEach(attr => {
                const item = document.createElement('div');
                item.className = 'attribute-item';
                item.dataset.attr = attr.id;
                item.innerHTML = `
                    <div class="attr-score-display" onclick="openAttributeModal('${attr.id}')"></div>
                    <div class="attr-modifier"></div>
                    <div class="attr-name">${attr.abbr}</div>
                `;
                container.appendChild(item);
            });
            lucide.createIcons();
        }

        function renderAbilitySkillGroups() {
            const container = document.getElementById('ability-skill-groups');
            if (!container) return; // Adicionado null check

            container.innerHTML = '';

            ATTRIBUTES.forEach(attr => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'ability-group';

                const saveSkillData = characterData.savingThrows[attr.id] || { proficient: false, advantage: false };
                groupDiv.innerHTML += `
                    <div class="ability-row">
                        <label class="font-bold" style="color: var(--header-gold-text);">${attr.name}</label>
                        <div class="advantage-dot ${saveSkillData.advantage ? 'toggled' : ''}" onclick="toggleAdvantage(event, 'savingThrows', '${attr.id}')"></div>
                        <div class="proficiency-dot ${saveSkillData.proficient ? 'toggled' : ''}" onclick="toggleProficiency(event, 'savingThrows', '${attr.id}')"></div>
                        <span id="save-total-${attr.id}" class="font-bold text-lg">+0</span>
                    </div>
                `;

                const associatedSkills = SKILLS.filter(skill => skill.attr === attr.id);
                associatedSkills.forEach(skill => {
                    const skillId = skill.name.toLowerCase().replace(/ /g, '-');
                    const skillData = characterData.skills[skillId] || { proficient: false, advantage: false };
                    groupDiv.innerHTML += `
                        <div class="ability-row">
                            <label>${skill.name}</label>
                            <div class="advantage-dot ${skillData.advantage ? 'toggled' : ''}" onclick="toggleAdvantage(event, 'skills', '${skillId}')"></div>
                            <div class="proficiency-dot ${skillData.proficient ? 'toggled' : ''}" onclick="toggleProficiency(event, 'skills', '${skillId}')"></div>
                            <span id="skill-total-${skillId}" class="font-bold text-lg">+0</span>
                        </div>
                    `;
                });
                container.appendChild(groupDiv);
            });
            lucide.createIcons(); // Garante que os ícones sejam criados
        }

        // --- LISTENERS DE EVENTOS E CONFIGURAÇÃO INICIAL ---
        function setupEventListeners() {
            document.querySelectorAll('#characterName, #characterClass, #characterRace, #hpCurrent, #hpMax, #hpTemp, #journalContent, #ac').forEach(el => {
                el.addEventListener('input', debouncedCollectDataAndRecalculate);
            });
            // NOVO: Listeners para Personalidade e Antecedentes
            document.querySelectorAll('#personalityTraits, #ideals, #flaws, #characterHistory, #organizations').forEach(el => {
                el.addEventListener('input', debouncedCollectDataAndRecalculate);
            });
            
            document.getElementById('imageUpload').addEventListener('change', handleImageUpload);
            document.getElementById('wallpaperUpload').addEventListener('change', handleWallpaperUpload);
            
            // Listener para a imagem da magia no modal de magia
            document.getElementById('spell-image-upload').addEventListener('change', handleTempSpellImage);
            // Listener para a imagem do item no modal de edição de item
            document.getElementById('edit-item-upload').addEventListener('change', handleEditItemImageUpload);
            
            // Global Tabs Listeners
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });

            // Spellbook internal tabs listeners
            document.querySelectorAll('.spell-modal-tabs .spell-modal-tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    const tabId = this.dataset.tabTarget;
                    switchSpellModalTab(tabId);
                });
            });

            const localMusicInput = document.getElementById('localMusicInput');
            if (localMusicInput) {
                localMusicInput.addEventListener('change', handleLocalMusicFiles);
            }

            const localMusicDropArea = document.getElementById('localMusicDropArea');
            if (localMusicDropArea) {
                localMusicDropArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    localMusicDropArea.classList.add('drag-over');
                });
                localMusicDropArea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    localMusicDropArea.classList.remove('drag-over');
                });
                localMusicDropArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    localMusicDropArea.classList.remove('drag-over');
                    if (e.dataTransfer && e.dataTransfer.files) {
                        handleLocalMusicFiles({ target: { files: e.dataTransfer.files } });
                    }
                });
                localMusicDropArea.addEventListener('click', () => localMusicInput.click());
            }

            if (audioPlayer) {
                audioPlayer.addEventListener('ended', nextTrack);
                audioPlayer.addEventListener('play', () => {
                    document.getElementById('playPauseIcon').setAttribute('data-lucide', 'pause');
                    lucide.createIcons();
                    if (localPlaylist[currentTrackIndex]) {
                        showNowPlaying(localPlaylist[currentTrackIndex].name, "Música Local");
                    }
                });
                audioPlayer.addEventListener('pause', () => {
                    document.getElementById('playPauseIcon').setAttribute('data-lucide', 'play');
                    lucide.createIcons();
                });
            }

            // Listeners para proficiências adicionais
            document.getElementById('prof-armors').addEventListener('input', (e) => debouncedUpdateProficiencies('armors', e.target.value));
            document.getElementById('prof-weapons').addEventListener('input', (e) => debouncedUpdateProficiencies('weapons', e.target.value));
            document.getElementById('prof-tools').addEventListener('input', (e) => debouncedUpdateProficiencies('tools', e.target.value));

        }

        window.onload = () => { loadData(); populateUIFromData(); setupEventListeners(); lucide.createIcons(); };

        // --- FUNÇÕES DE MODAL E RECURSOS ---
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        // General message display function
        function showMessage(message, duration = 3000) {
            const popup = document.getElementById('messagePopup');
            if (!popup) return;

            clearTimeout(messageTimeout);

            popup.textContent = message;
            popup.classList.add('show');

            messageTimeout = setTimeout(() => {
                popup.classList.remove('show');
            }, duration);
        }

        // NEW: Global Tab Switching Logic
        function switchTab(tabId) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            // Deactivate all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            // Activate the selected tab content and button
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('active');

            // Save the current tab to character data
            characterData.theme.currentTab = tabId;
            saveData();
        }

        function switchSpellModalTab(tabId) {
            document.querySelectorAll('.spell-modal-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.spell-modal-tab-button').forEach(button => {
                button.classList.remove('active');
            });

            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.spell-modal-tab-button[data-tab-target="${tabId}"]`).classList.add('active');

            if (tabId === 'conjuration-tab-content') {
                updateSpellcastingStats();
                updateAllCalculations();
            }
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                characterData.image = e.target.result;
                document.getElementById('charImage').src = characterData.image;
                updateCharImageDisplay(); // Update image and overlay state
                saveData();
            };
            reader.readAsDataURL(file);
        }

        // NEW: Function to manage character image display and overlay
        function updateCharImageDisplay() {
            const charImage = document.getElementById('charImage');
            const overlay = document.getElementById('char-image-overlay');
            if (charImage.src === defaultImagePlaceholder || !characterData.image || characterData.image === defaultImagePlaceholder) {
                // If no custom image, show overlay and make placeholder semi-transparent
                overlay.classList.remove('opacity-0', 'invisible');
                charImage.style.opacity = '0.5';
            } else {
                // If custom image, hide overlay and make image fully opaque
                overlay.classList.add('opacity-0', 'invisible');
                charImage.style.opacity = '1';
            }
            lucide.createIcons(); // To ensure the icon in the overlay appears
        }


        function toggleAdvantage(event, type, id) {
            const target = type === 'skills' ? characterData.skills[id] : characterData.savingThrows[id];
            target.advantage = !target.advantage;
            event.currentTarget.classList.toggle('toggled', target.advantage);
            saveData();
        }
        function toggleProficiency(event, type, id) {
            const target = type === 'skills' ? characterData.skills[id] : characterData.savingThrows[id];
            target.proficient = !target.proficient;
            event.currentTarget.classList.toggle('toggled', target.proficient);
            updateAllCalculations();
            saveData();
        }

        function openAttributeModal(attrId) {
            currentAttrModalId = attrId;
            const attr = ATTRIBUTES.find(a => a.id === attrId);
            const score = characterData.attributes[attrId];
            document.getElementById('attribute-modal-title').textContent = `Editar ${attr.name}`;
            const input = document.getElementById('attribute-modal-input');
            const modifierSpan = document.getElementById('attribute-modal-modifier');
            input.value = score;
            modifierSpan.textContent = calculateModifier(newScore) >= 0 ? `+${calculateModifier(newScore)}` : calculateModifier(newScore);
            
            // Listener for direct input in the modal (if user types)
            input.oninput = () => {
                const newScore = parseInt(input.value) || 0;
                characterData.attributes[currentAttrModalId] = newScore;
                modifierSpan.textContent = calculateModifier(newScore) >= 0 ? `+${calculateModifier(newScore)}` : calculateModifier(newScore);
                updateAllCalculations();
                saveData();
            };
            openModal('attributeEditModal');
        }

        function renderDeathSaves(){
            for(let i = 0; i < 3; i++) {
                if(characterData.deathSaves.successes[i]) document.getElementById(`dss-${i+1}`).classList.add('checked');
                else document.getElementById(`dss-${i+1}`).classList.remove('checked');
                if(characterData.deathSaves.failures[i]) document.getElementById(`dsf-${i+1}`).classList.add('checked');
                else document.getElementById(`dsf-${i+1}`).classList.remove('checked');
            }
        }
        function toggleDeathSave(type, index) {
            characterData.deathSaves[type][index] = !characterData.deathSaves[type][index];
            document.getElementById(`${type === 'successes' ? 'dss' : 'dsf'}-${index+1}`).classList.toggle('checked');
            saveData();
        }

        let currentEditingSpellIndex = null;
        function openSpellEditModal(index) {
            currentEditingSpellIndex = index;
            tempSpellImage = null; // Reinicia a imagem temporária ao abrir o modal
            if (index !== null) {
                const spell = characterData.spells[index];
                document.getElementById('spell-modal-title').textContent = 'Editar Magia';
                document.getElementById('spell-name-input').value = spell.name;
                document.getElementById('spell-level-input').value = spell.level;
                document.getElementById('spell-casting-time-input').value = spell.castingTime;
                document.getElementById('spell-range-input').value = spell.range;
                document.getElementById('comp-v').checked = spell.components.V;
                document.getElementById('comp-s').checked = spell.components.S;
                document.getElementById('comp-m').checked = spell.components.M;
                document.getElementById('spell-material-desc-input').value = spell.components.materialDesc;
                document.getElementById('spell-duration-input').value = spell.duration;
                document.getElementById('spell-description-input').value = spell.description;
            } else {
                document.getElementById('spell-modal-title').textContent = 'Criar Magia';
                document.getElementById('spell-name-input').value = '';
                document.getElementById('spell-level-input').value = 0;
                document.getElementById('spell-casting-time-input').value = '';
                document.getElementById('spell-range-input').value = '';
                document.getElementById('comp-v').checked = false;
                document.getElementById('comp-s').checked = false;
                document.getElementById('comp-m').checked = false;
                document.getElementById('spell-material-desc-input').value = '';
                document.getElementById('spell-duration-input').value = '';
                document.getElementById('spell-description-input').value = '';
            }
            openModal('spellEditModal');
        }
        function handleTempSpellImage(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => { tempSpellImage = e.target.result; };
            reader.readAsDataURL(file);
        }
        function closeSpellEditModal() { closeModal('spellEditModal'); }
        function saveSpell() {
            const spell = {
                name: document.getElementById('spell-name-input').value,
                level: parseInt(document.getElementById('spell-level-input').value),
                castingTime: document.getElementById('spell-casting-time-input').value,
                range: document.getElementById('spell-range-input').value,
                components: {
                    V: document.getElementById('comp-v').checked,
                    S: document.getElementById('comp-s').checked,
                    M: document.getElementById('comp-m').checked,
                    materialDesc: document.getElementById('spell-material-desc-input').value
                },
                duration: document.getElementById('spell-duration-input').value,
                description: document.getElementById('spell-description-input').value,
                image: tempSpellImage || ''
            };
            if (!spell.name) return;
            if (currentEditingSpellIndex !== null) {
                characterData.spells[currentEditingSpellIndex] = spell;
            } else {
                characterData.spells.push(spell);
            }
            characterData.spells.sort((a,b) => a.level - b.level || a.name.localeCompare(b.name));
            renderSpells();
            saveData();
            closeModal('spellEditModal'); // Close spell creation modal
        }
        function deleteSpell(index) {
            characterData.spells.splice(index, 1);
            renderSpells();
            saveData();
        }
        function renderSpells() {
            const list = document.getElementById('spellList');
            list.innerHTML = '';
            let currentLevel = -1;
            characterData.spells.forEach((spell, index) => {
                if (spell.level !== currentLevel) {
                    currentLevel = spell.level;
                    const levelTitle = currentLevel == 0 ? "Truques" : `${currentLevel}º Nível`;
                    list.innerHTML += `<h3 class="text-xl border-b-2 border-yellow-800/30 mt-4 pb-1" style="color: var(--header-gold-text);">${levelTitle}</h3>`;
                }
                const components = `${spell.components.V ? 'V ' : ''}${spell.components.S ? 'S ' : ''}${spell.components.M ? 'M ' : ''}`.trim();
                list.innerHTML += `
                    <div class="gothic-card p-3 mt-2 flex gap-4">
                        <div class="flex-grow">
                            <div class="flex justify-between items-start">
                                <h4 class="text-lg font-bold">${spell.name}</h4>
                                <div class="flex gap-2">
                                    <button class="gothic-btn text-xs py-1 px-2" onclick="openSpellEditModal(${index})">Editar</button>
                                    <button class="gothic-btn text-xs py-1 px-2 !border-red-500 !text-red-500 hover:!bg-red-500 hover:!text-black" onclick="deleteSpell(${index})">X</button>
                                </div>
                            </div>
                            <div class="text-xs opacity-70 mt-1">
                                <span>${spell.castingTime} | ${spell.range} | ${spell.duration} | ${components}</span>
                            </div>
                            <p class="text-sm mt-2 pt-2 border-t border-yellow-800/30">${spell.description}</p>
                        </div>
                        ${spell.image ? `<img src="${spell.image}" class="w-24 h-24 object-cover rounded-lg border-2 border-border-gold flex-shrink-0">` : ''}
                    </div>`;
            });
        }
        // Debounced function for spell slot updates
        const debouncedUpdateSpellSlot = debounce((level, type, value) => {
            characterData.spellSlots[level][type] = parseInt(value) || 0; // Garante que seja um número
            saveData();
        }, 300);

        function updateSpellSlots() {
            const container = document.getElementById('spellSlots');
            container.innerHTML = '';
            for(let i=1; i<=9; i++) {
                container.innerHTML += `
                    <div class="text-center">
                        <label class="text-xs">Nível ${i}</label>
                        <div class="flex gap-1">
                            <input value="${characterData.spellSlots[i]?.current || 0}" class="gothic-input w-full text-center p-1 text-sm" oninput="debouncedUpdateSpellSlot(${i}, 'current', this.value);">
                            <span class="p-1">/</span>
                            <input value="${characterData.spellSlots[i]?.max || 0}" class="gothic-input w-full text-center p-1 text-sm" oninput="debouncedUpdateSpellSlot(${i}, 'max', this.value);">
                        </div>
                    </div>`;
            }
        }

        // --- FUNÇÕES DO INVENTÁRIO (MODIFICADAS) ---
        function switchInventoryListTab(tab) {
            currentInventoryListTab = tab;
            document.getElementById('inventory-tab-equip').classList.toggle('opacity-50', tab !== 'equip');
            document.getElementById('inventory-tab-key').classList.toggle('opacity-50', tab !== 'key');
            document.getElementById('add-item-btn').textContent = tab === 'equip' ? 'Adicionar Equipamento' : 'Adicionar Item Chave';
            renderInventory();
        }

        // Nova função para abrir o modal de edição/criação de item
        function openEditInventoryItemModal(itemId = null) {
            currentEditingItemId = itemId;
            tempEditItemImage = null; // Reseta a imagem temporária
            const item = itemId !== null ? 
                               (currentInventoryListTab === 'equip' ? characterData.inventory : characterData.keyInventory).find(i => i.id === itemId) :
                               { id: Date.now(), name: 'Novo Item', qty: 1, isSingle: false, image: defaultImagePlaceholder, type: 'outro', notes: '', damage: '', bonuses: [], linkedVinculoId: '', rarity: 'comum' }; // Adicionado isSingle e rarity aqui

            document.getElementById('edit-item-modal-title').textContent = itemId !== null ? 'Editar Item' : 'Criar Novo Item';
            document.getElementById('edit-item-image').src = item.image;
            document.getElementById('edit-item-name').value = item.name;
            document.getElementById('edit-item-qty').value = item.qty;
            document.getElementById('edit-item-type').value = item.type;
            document.getElementById('edit-item-rarity').value = item.rarity || 'comum'; // Define a raridade
            document.getElementById('edit-item-damage').value = item.damage || '';
            document.getElementById('edit-item-notes').value = item.notes;
            document.getElementById('edit-item-is-single').checked = item.isSingle; // Define o estado do checkbox "Único"
            toggleItemIsSingle(item.isSingle); // Atualiza o input de quantidade com base no estado de "Único"


            // Preencher opções de vínculo para itens chave
            const vinculoSelect = document.getElementById('edit-item-linked-vinculo');
            vinculoSelect.innerHTML = '<option value="">Nenhum</option>' + 
                                       characterData.vinculos.map(v => `<option value="${v.id}" ${item.linkedVinculoId == v.id ? 'selected' : ''}>${v.name}</option>`).join('');
            
            // Gerencia visibilidade do campo de dano e vínculo
            toggleEditItemDamageField();
            document.getElementById('edit-item-vinculo-container').style.display = (currentInventoryListTab === 'key' ? 'block' : 'none');

            renderEditItemBonusesList(item.bonuses);
            openModal('editInventoryItemModal');
            // Ao abrir o modal, limpa o ID do item de detalhes para evitar confusão se o usuário editou e depois tentou ver os detalhes.
            currentDetailItemId = null; 
        }

        // Função auxiliar para controlar a visibilidade do campo de dano
        function toggleEditItemDamageField() {
            const itemType = document.getElementById('edit-item-type').value;
            document.getElementById('edit-item-damage-container').style.display = (itemType === 'arma' ? 'block' : 'none');
        }

        // NOVO: Função para controlar o estado "Único" do item
        function toggleItemIsSingle(isChecked) {
            const qtyInput = document.getElementById('edit-item-qty');
            if (isChecked) {
                qtyInput.value = 1;
                qtyInput.disabled = true;
            } else {
                qtyInput.disabled = false;
            }
        }


        function handleEditItemImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => { 
                tempEditItemImage = e.target.result; 
                document.getElementById('edit-item-image').src = tempEditItemImage; // Atualiza a pré-visualização no modal
            };
            reader.readAsDataURL(file);
        }

        // Função para salvar o item do modal de edição
        function saveInventoryItem() {
            const isSingle = document.getElementById('edit-item-is-single').checked;
            const itemToSave = {
                id: currentEditingItemId || Date.now(), // Se for novo, gera um ID
                name: document.getElementById('edit-item-name').value,
                qty: isSingle ? 1 : (parseInt(document.getElementById('edit-item-qty').value) || 1), // Qty é 1 se for único
                isSingle: isSingle, // Salva o estado de 'único'
                image: tempEditItemImage || document.getElementById('edit-item-image').src,
                type: document.getElementById('edit-item-type').value,
                rarity: document.getElementById('edit-item-rarity').value, // Salva a raridade
                notes: document.getElementById('edit-item-notes').value,
                damage: document.getElementById('edit-item-damage').value,
                linkedVinculoId: document.getElementById('edit-item-linked-vinculo').value,
                bonuses: characterData.tempItemBonuses || [] // Usa os bônus temporários
            };

            const inventoryArray = currentInventoryListTab === 'equip' ? characterData.inventory : characterData.keyInventory;
            const existingItemIndex = inventoryArray.findIndex(i => i.id === itemToSave.id);

            if (existingItemIndex !== -1) {
                // Edita item existente: atualiza o objeto no array
                inventoryArray[existingItemIndex] = itemToSave;
                // Atualiza o DOM do item específico sem re-renderizar tudo
                const existingCard = document.querySelector(`.inventory-item-card[data-item-id="${itemToSave.id}"]`);
                if (existingCard) {
                    existingCard.querySelector('img').src = itemToSave.image;
                    existingCard.querySelector('.item-name').textContent = itemToSave.name;
                    existingCard.querySelector('.item-qty').textContent = itemToSave.isSingle ? 'Único' : `Qtd: ${itemToSave.qty}`;
                }
            } else {
                // Adiciona novo item ao início do array
                inventoryArray.unshift(itemToSave);
                // Cria e adiciona o novo elemento ao DOM
                const list = document.getElementById('inventoryList');
                const newItemHtml = `
                    <div class="inventory-item-card" data-item-id="${itemToSave.id}" onclick="openItemDetailModal(${itemToSave.id})">
                        <button class="delete-item-btn" onclick="event.stopPropagation(); removeInventoryItem(${itemToSave.id})">X</button>
                        <img src="${itemToSave.image}" alt="${itemToSave.name}" onerror="this.src='${defaultImagePlaceholder}'">
                        <span class="item-name">${item.isSingle ? 'Único' : `Qtd: ${item.qty}`}</span>
                    </div>
                `;
                list.insertAdjacentHTML('afterbegin', newItemHtml);
                lucide.createIcons(); // Recriar ícones para o novo elemento
            }
            
            characterData.tempItemBonuses = []; // Limpa os bônus temporários após salvar

            saveData();
            // renderInventory(); // Removido para otimização
            updateAllCalculations();
            closeModal('editInventoryItemModal');
        }

        // Redesenha a lista de bônus dentro do modal de edição de item
        function renderEditItemBonusesList(bonuses) {
            const listContainer = document.getElementById('edit-item-bonuses-list');
            listContainer.innerHTML = ''; // Limpa a lista existente

            // Garante que characterData.tempItemBonuses contenha os bônus atuais do item que está sendo editado
            // ou uma array vazia se for um novo item.
            characterData.tempItemBonuses = bonuses ? [...bonuses] : [];

            if (characterData.tempItemBonuses.length === 0) {
                listContainer.innerHTML = '<p class="opacity-70 italic text-center">Nenhum bônus adicionado ainda.</p>';
            } else {
                characterData.tempItemBonuses.forEach((b, i) => {
                    const bonusDiv = document.createElement('div');
                    bonusDiv.className = 'flex justify-between items-center bg-black/20 p-1 rounded';
                    bonusDiv.innerHTML = `
                        <span>${b.label}: ${b.value > 0 ? '+' : ''}${b.value}</span>
                        <button class="text-red-500" onclick="removeEditItemBonus(${i})">×</button>
                    `;
                    listContainer.appendChild(bonusDiv);
                });
            }
        }

        // Remove um bônus da lista temporária no modal de edição
        function removeEditItemBonus(bonusIndex) {
            if (characterData.tempItemBonuses) {
                characterData.tempItemBonuses.splice(bonusIndex, 1);
                renderEditItemBonusesList(characterData.tempItemBonuses); // Redesenha a lista no modal
            }
        }

        // CORRIGIDO: Função para remover item do inventário
        function removeInventoryItem(itemId) {
            const inventory = currentInventoryListTab === 'equip' ? characterData.inventory : characterData.keyInventory;
            const itemIndex = inventory.findIndex(i => i.id === itemId);
            if (itemIndex !== -1) {
                inventory.splice(itemIndex, 1); // Remove do array de dados
                saveData(); // Salva os dados atualizados
                // Remove o elemento do DOM diretamente
                const itemElement = document.querySelector(`.inventory-item-card[data-item-id="${itemId}"]`);
                if (itemElement) {
                    itemElement.remove();
                }
                updateAllCalculations(); // Recalcula bônus se o item removido os tinha
            }
        }

        // Função para exibir detalhes do item em um modal separado
        function openItemDetailModal(itemId) {
            currentDetailItemId = itemId; // Salva o ID do item que está sendo visualizado
            const inventory = currentInventoryListTab === 'equip' ? characterData.inventory : characterData.keyInventory;
            const item = inventory.find(i => i.id === itemId);

            if (!item) return;

            document.getElementById('item-detail-name').textContent = item.name;
            const itemDetailImage = document.getElementById('item-detail-image');
            itemDetailImage.src = item.image;
            itemDetailImage.onclick = () => openImageViewerModal(item.image); // Adiciona o listener de clique à imagem

            document.getElementById('item-detail-qty').textContent = item.isSingle ? 'Único' : item.qty; // Exibe 'Único' ou a quantidade
            document.getElementById('item-detail-type').textContent = item.type;
            document.getElementById('item-detail-rarity').textContent = item.rarity ? item.rarity.charAt(0).toUpperCase() + item.rarity.slice(1) : 'Comum'; // Exibe a raridade
            document.getElementById('item-detail-notes').textContent = item.notes || 'Nenhuma nota.';

            // Exibir ou esconder campo de dano
            const damageRow = document.getElementById('item-detail-damage-row');
            if (item.type === 'arma' && item.damage) {
                document.getElementById('item-detail-damage').textContent = item.damage;
                damageRow.classList.remove('hidden');
            } else {
                damageRow.classList.add('hidden');
            }

            // Exibir ou esconder campo de vínculo
            const vinculoRow = document.getElementById('item-detail-vinculo-row');
            if (currentInventoryListTab === 'key' && item.linkedVinculoId) {
                const linkedVinculo = characterData.vinculos.find(v => v.id == item.linkedVinculoId);
                document.getElementById('item-detail-vinculo').textContent = linkedVinculo ? linkedVinculo.name : 'Vínculo Desconhecido';
                vinculoRow.classList.remove('hidden');
            } else {
                vinculoRow.classList.add('hidden');
            }


            // Renderizar bônus do item
            const bonusesContainer = document.getElementById('item-detail-bonuses');
            const noBonusesMessage = document.getElementById('no-bonuses-message');
            bonusesContainer.innerHTML = '';
            if (item.bonuses && item.bonuses.length > 0) {
                item.bonuses.forEach(b => {
                    const bonusDiv = document.createElement('div');
                    bonusDiv.textContent = `${b.label}: ${b.value > 0 ? '+' : ''}${b.value}`;
                    bonusesContainer.appendChild(bonusDiv);
                });
                noBonusesMessage.classList.add('hidden');
            } else {
                noBonusesMessage.classList.remove('hidden');
            }

            openModal('itemDetailModal');
        }

        // NOVO: Função para abrir o visualizador de imagem em tela cheia
        function openImageViewerModal(imageUrl) {
            const imageViewerImage = document.getElementById('imageViewerImage');
            imageViewerImage.src = imageUrl;
            openModal('imageViewerModal');
        }


        function renderInventory() {
            const list = document.getElementById('inventoryList');
            if(!list) return;
            const inventory = currentInventoryListTab === 'equip' ? characterData.inventory : characterData.keyInventory;
            // Adiciona data-item-id para fácil seleção de elementos no DOM
            list.innerHTML = inventory.map(item => `
                <div class="inventory-item-card" data-item-id="${item.id}" onclick="openItemDetailModal(${item.id})">
                    <button class="delete-item-btn" onclick="event.stopPropagation(); removeInventoryItem(${item.id})">X</button>
                    <img src="${item.image}" alt="${item.name}" onerror="this.src='${defaultImagePlaceholder}'">
                    <span class="item-name">${item.isSingle ? 'Único' : `Qtd: ${item.qty}`}</span>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // Funções relacionadas aos bônus (permanecem as mesmas, mas agora interagem com o modal de edição de item)
        function openItemBonusModal(itemId) {
            currentItemBonusId = itemId; // O ID do item ao qual o bônus será adicionado
            updateBonusTarget();
            openModal('itemBonusModal');
        }
        function updateBonusTarget() {
            const type = document.getElementById('bonus-type-select').value;
            const targetSelect = document.getElementById('bonus-target-select');
            let options = '';
            if (type === 'attribute' || type === 'savingThrow') options = ATTRIBUTES.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
            else if (type === 'skill') options = SKILLS.map(s => `<option value="${s.name.toLowerCase().replace(/ /g, '-')}">${s.name}</option>`).join('');
            targetSelect.innerHTML = options;
            targetSelect.style.display = options ? 'block' : 'none';
        }
        function saveItemBonus() {
            const type = document.getElementById('bonus-type-select').value;
            const target = document.getElementById('bonus-target-select').value;
            const value = parseInt(document.getElementById('bonus-value-input').value);
            if (!currentItemBonusId || isNaN(value)) return;

            const targetLabel = document.getElementById('bonus-type-select').selectedOptions[0]?.text;
            const targetSubLabel = target ? document.getElementById('bonus-target-select').selectedOptions[0]?.text : '';
            let bonusLabel = targetSubLabel ? `${targetLabel}: ${targetSubLabel}` : targetLabel;

            const newBonus = { type, target, value, label: bonusLabel };
            
            // Adiciona o bônus à lista temporária do modal de edição de item
            if (!characterData.tempItemBonuses) {
                characterData.tempItemBonuses = [];
            }
            characterData.tempItemBonuses.push(newBonus);
            
            renderEditItemBonusesList(characterData.tempItemBonuses); // Atualiza a lista de bônus no modal de edição

            // Limpa os campos do modal de bônus
            document.getElementById('bonus-type-select').value = 'attribute';
            document.getElementById('bonus-value-input').value = '';
            updateBonusTarget(); // Reseta o seletor de alvo

            closeModal('itemBonusModal');
            // Não chama saveData() ou renderInventory() aqui, pois o save final será feito pelo modal de edição de item
        }
        // Nota: removeItemBonus agora interage com characterData.tempItemBonuses (no modal de edição)
        // A função original removeItemBonus que manipulava o item diretamente no characterData.inventory foi removida
        // pois a manipulação de bônus agora ocorre no modal de edição e é salva quando o item é salvo.


        function addVinculo() {
            characterData.vinculos.unshift({ id: Date.now(), image: defaultImagePlaceholder, name: "Novo Vínculo", type: "", description: "" });
            renderVinculos();
            saveData();
        }
        function deleteVinculo(id) {
            characterData.vinculos = characterData.vinculos.filter(v => v.id !== id);
            renderVinculos();
            saveData();
        }
        function handleVinculoImageUpload(event, id) {
            const reader = new FileReader();
            reader.onload = function() {
                const vinculo = characterData.vinculos.find(v => v.id === id);
                if (vinculo) {
                    vinculo.image = reader.result;
                    document.getElementById(`vinculo-image-${id}`).src = vinculo.image;
                    saveData();
                }
            };
            reader.readAsDataURL(event.target.files[0]);
        }
        function renderVinculos() {
            const container = document.getElementById('vinculosContainer');
            if(!container) return;
            container.innerHTML = characterData.vinculos.map(v => `
                <div class="gothic-card p-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="flex flex-col items-center space-y-2">
                        <img id="vinculo-image-${v.id}" src="${v.image}" class="w-24 h-24 object-cover rounded-full border-2 border-border-gold">
                        <input type="file" id="vinculo-upload-${v.id}" class="hidden" accept="image/*">
                        <button class="gothic-btn text-xs py-1 px-2" onclick="document.getElementById('vinculo-upload-${v.id}').click()">Alterar</button>
                    </div>
                    <div class="md:col-span-2 space-y-2">
                        <input type="text" class="gothic-input" placeholder="Nome" value="${v.name}" oninput="debouncedUpdateVinculoName(${v.id}, this.value)">
                        <input type="text" class="gothic-input" placeholder="Tipo (Ex: Amigo, Rival)" value="${v.type}" oninput="debouncedUpdateVinculoType(${v.id}, this.value)">
                        <textarea class="gothic-textarea h-24" placeholder="Descrição..." oninput="debouncedUpdateVinculoDescription(${v.id}, this.value)">${v.description}</textarea>
                        <div class="text-right">
                            <button class="text-red-500 hover:text-red-300 text-sm" onclick="deleteVinculo(${v.id})">Remover</button>
                        </div>
                    </div>
                </div>`).join('');
            lucide.createIcons();
        }

        // Debounced functions for Vinculo updates
        const debouncedUpdateVinculoName = debounce((vinculoId, value) => {
            const vinculo = characterData.vinculos.find(v => v.id === vinculoId);
            if (vinculo) { vinculo.name = value; saveData(); }
        }, 300);
        const debouncedUpdateVinculoType = debounce((vinculoId, value) => {
            const vinculo = characterData.vinculos.find(v => v.id === vinculoId);
            if (vinculo) { vinculo.type = value; saveData(); }
        }, 300);
        const debouncedUpdateVinculoDescription = debounce((vinculoId, value) => {
            const vinculo = characterData.vinculos.find(v => v.id === vinculoId);
            if (vinculo) { vinculo.description = value; saveData(); }
        }, 300);


        // Debounced function for currency updates
        const debouncedUpdateCurrency = debounce((coinId, value) => {
            characterData.currency[coinId] = parseInt(value) || 0;
            saveData();
        }, 300);

        function renderCurrency() {
            const container = document.getElementById('currency-card');
            if (!container) return;
            const coins = [{id:'cp', name:'Cobre'}, {id:'sp', name:'Prata'}, {id:'ep', name:'Electro'}, {id:'gp', name:'Ouro'}, {id:'pp', name:'Platina'}];
            container.innerHTML = `
                <h2 class="text-xl mb-2" style="color: var(--header-gold-text);">Moedas</h2>
                <div class="space-y-2">
                    ${coins.map(coin => `
                        <div class="flex items-center justify-between">
                            <label class="text-sm">${coin.name} (${coin.id.toUpperCase()})</label>
                            <input type="number" id="currency-${coin.id}" class="gothic-input !w-24 text-center" value="${characterData.currency[coin.id] || 0}" oninput="debouncedUpdateCurrency('${coin.id}', this.value);">
                        </div>`).join('')}
                </div>
                <button class="gothic-btn w-full mt-4 text-sm" onclick="consolidateCurrency()"><i data-lucide="coins"></i>Consolidar</button>`;
            lucide.createIcons();
        }
        function consolidateCurrency() {
            let { cp, sp, ep, gp, pp } = characterData.currency;
            sp += Math.floor(cp / 10); cp %= 10;
            gp += Math.floor(sp / 10); sp %= 10;
            gp += Math.floor(ep / 2);  ep %= 2;
            pp += Math.floor(gp / 10); gp %= 10;
            characterData.currency = { cp, sp, ep, gp, pp };
            saveData();
            renderCurrency();
        }

        let selectedDie = 20;
        function selectDie(sides) {
            selectedDie = sides;
            document.getElementById('diceType').textContent = `D${sides}`;
        }
        function rollDice() {
            const qty = parseInt(document.getElementById('diceQty').value) || 1;
            const mod = parseInt(document.getElementById('diceMod').value) || 0;
            const addProf = document.getElementById('addProficiencyToRoll').checked;
            const profBonus = addProf ? calculateProficiencyBonus() : 0;
            let total = 0;
            let rolls = [];
            for(let i = 0; i < qty; i++) {
                const roll = Math.floor(Math.random() * selectedDie) + 1;
                rolls.push(roll);
                total += roll;
            }
            total += mod + profBonus;
            const detail = `${qty}d${selectedDie} (${rolls.join(', ')}) + ${mod}` + (addProf ? ` + ${profBonus}(P)` : '');
            document.getElementById('rollResult').textContent = total;
            document.getElementById('rollDetail').textContent = detail;
            characterData.rollHistory.unshift({result: total, detail: detail});
            if(characterData.rollHistory.length > 20) characterData.rollHistory.pop();
            renderRollHistory();
            saveData();
        }
        function renderRollHistory() {
            const container = document.getElementById('rollHistory');
            container.innerHTML = characterData.rollHistory.map(r => `<p><span class="font-bold" style="color: var(--header-gold-text);">${r.result}</span> = ${r.detail}</p>`).join('');
        }

        // Theme Settings
        function renderThemeSettings() {
            const colorPickersContainer = document.getElementById('color-pickers');
            colorPickersContainer.innerHTML = THEME_COLORS.map(c => {
                let inputHtml = '';
                if (c.type === 'range') {
                    const currentValue = parseFloat(getComputedStyle(document.documentElement).getPropertyValue(c.var).trim());
                    inputHtml = `<input type="range" min="${c.min}" max="${c.max}" step="${c.step}" value="${currentValue}" oninput="updateThemeColor('${c.var}', this.value)">`;
                } else {
                    inputHtml = `<input type="color" value="${getComputedStyle(document.documentElement).getPropertyValue(c.var).trim()}" oninput="updateThemeColor('${c.var}', this.value)">`;
                }
                return `
                    <div class="color-picker-item">
                        <label>${c.label}</label>
                        ${inputHtml}
                    </div>`;
            }).join('');

            const flameColorPickersContainer = document.getElementById('flame-color-pickers');
            flameColorPickersContainer.innerHTML = FLAME_COLORS.map(c => {
                let inputHtml = '';
                if (c.type === 'range') {
                    const currentValue = parseFloat(getComputedStyle(document.documentElement).getPropertyValue(c.var).trim());
                    inputHtml = `<input type="range" min="${c.min}" max="${c.max}" step="${c.step}" value="${currentValue}" oninput="updateThemeColor('${c.var}', this.value)">`;
                } else {
                    inputHtml = `<input type="color" value="${getComputedStyle(document.documentElement).getPropertyValue(c.var).trim()}" oninput="updateThemeColor('${c.var}', this.value)">`;
                }
                return `
                    <div class="color-picker-item">
                        <label>${c.label}</label>
                        ${inputHtml}
                    </div>`;
            }).join('');

            // Set state for global theme settings (like flame glow and theme mode)
            document.getElementById('toggleFlameGlow').checked = characterData.theme.flameGlowEnabled;
            document.getElementById('themeModeSwitch').checked = (characterData.theme.mode === 'necrotic');

            // Set state for section visibility checkboxes in the "Layout da Ficha" section
            for (const sectionKey in characterData.theme.sectionVisibility) {
                const checkbox = document.getElementById(`toggle-section-${sectionKey}`);
                if (checkbox) { // Check if the element actually exists before trying to set 'checked'
                    checkbox.checked = characterData.theme.sectionVisibility[sectionKey];
                } else {
                    console.warn(`Checkbox for section '${sectionKey}' not found.`)
                }
            }
        }

        function updateThemeColor(cssVar, value) {
            document.documentElement.style.setProperty(cssVar, value);
            characterData.theme.colors[cssVar] = value;
            saveData();
        }

        function applyTheme() {
            const root = document.documentElement;
            const currentPalette = COLOR_PALETTES[characterData.theme.mode];

            for (const [cssVar, value] of Object.entries(currentPalette)) {
                root.style.setProperty(cssVar, value);
            }

            for (const [cssVar, value] of Object.entries(characterData.theme.colors)) {
                if (value !== undefined) {
                    root.style.setProperty(cssVar, value);
                }
            }
            
            root.style.setProperty('--flame-spread-factor', characterData.theme.colors['--flame-spread-factor'] || 1.0);

            if(characterData.theme.wallpaper) {
                document.body.style.backgroundImage = `linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.85)), url('${characterData.theme.wallpaper}')`;
            }

            if (characterData.theme.mode === 'necrotic') {
                document.body.classList.add('theme-necrotic');
            } else {
                document.body.classList.remove('theme-necrotic');
            }

            if (characterData.theme.flameGlowEnabled) {
                document.body.classList.remove('no-flame-glow');
            } else {
                document.body.classList.add('no-flame-glow');
            }
        }
        
        function handleWallpaperUpload(event){
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                characterData.theme.wallpaper = e.target.result;
                applyTheme();
                saveData();
            };
            reader.readAsDataURL(file);
        }

        function toggleFlameGlow(checked) {
            characterData.theme.flameGlowEnabled = checked;
            applyTheme();
            saveData();
        }

        function toggleThemeMode(checked) {
            characterData.theme.mode = checked ? 'necrotic' : 'radiant';
            characterData.theme.colors = {};
            Object.assign(characterData.theme.colors, COLOR_PALETTES[characterData.theme.mode]);
            characterData.theme.colors['--flame-spread-factor'] = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--flame-spread-factor').trim()) || 1.0;

            applyTheme();
            renderThemeSettings();
            saveData();
        }

        // NOVO: Função para alternar visibilidade das seções da ficha
        function toggleSectionVisibility(sectionId, isVisible, save = true) {
            let cardElement;
            switch (sectionId) {
                case 'attacks':
                    cardElement = document.getElementById('attacksCard');
                    break;
                case 'resources':
                    cardElement = document.getElementById('resourcesCard');
                    break;
                case 'conditions':
                    cardElement = document.getElementById('conditionsCard');
                    break;
                case 'personality':
                    cardElement = document.getElementById('personalityCard');
                    break;
                case 'musicPlayer':
                    // This case is handled by toggleMusicPlayerVisibility for direct control and UI sync
                    toggleMusicPlayerVisibility(isVisible, save);
                    return; // Exit to avoid re-saving and duplicate logic
                default:
                    return;
            }
            if (cardElement) {
                cardElement.style.display = isVisible ? 'block' : 'none';
                if (save) {
                    characterData.theme.sectionVisibility[sectionId] = isVisible;
                    saveData();
                }
            }
        }

        // --- MUSIC PLAYER FUNCTIONS ---
        function setupMusicPlayer() {
            audioPlayer = document.getElementById('backgroundMusicPlayer');
            const volumeControl = document.getElementById('volumeControl');
            if (volumeControl) {
                audioPlayer.volume = parseFloat(volumeControl.value);
            }

            renderLocalPlaylist();
        }

        // Updated toggleMusicPlayerVisibility to accept a save flag
        function toggleMusicPlayerVisibility(enabled, save = true) {
            const musicPlayerCard = document.getElementById('musicPlayerCard');
            if (musicPlayerCard) {
                musicPlayerCard.style.display = enabled ? 'block' : 'none';
                // Only update characterData if 'save' is true, or if called directly from its own control
                if (save) {
                    characterData.theme.musicPlayerEnabled = enabled;
                    characterData.theme.sectionVisibility.musicPlayer = enabled; // Ensure consistency
                    saveData();
                }
                if (!enabled) {
                    audioPlayer.pause();
                }
            }
        }


        function handleLocalMusicFiles(event) {
            const files = event.target.files;
            if (!files.length) return;

            localPlaylist = [];
            currentTrackIndex = -1;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file.type.startsWith('audio/')) {
                    localPlaylist.push({
                        name: file.name,
                        url: URL.createObjectURL(file)
                    });
                }
            }
            renderLocalPlaylist();
            if (localPlaylist.length > 0 && characterData.theme.musicPlayerEnabled) {
                currentTrackIndex = 0;
                playTrack(currentTrackIndex);
            }
        }

        function renderLocalPlaylist() {
            const playlistEl = document.getElementById('localPlaylist');
            if (!playlistEl) return; // Added null check

            playlistEl.innerHTML = '';
            if (localPlaylist.length === 0) {
                playlistEl.innerHTML = '<li class="text-center opacity-75">Nenhuma música adicionada.</li>';
                return;
            }

            localPlaylist.forEach((track, index) => {
                const li = document.createElement('li');
                li.textContent = track.name;
                li.className = (index === currentTrackIndex && !audioPlayer.paused) ? 'active-track' : '';
                li.onclick = () => {
                    currentTrackIndex = index;
                    playTrack(currentTrackIndex);
                };
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'X';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    removeTrack(index);
                };
                li.appendChild(deleteBtn);
                playlistEl.appendChild(li);
            });
        }

        function playTrack(index) {
            if (index >= 0 && index < localPlaylist.length) {
                audioPlayer.src = localPlaylist[index].url;
                audioPlayer.play();
                currentTrackIndex = index;
                renderLocalPlaylist();
                showNowPlaying(localPlaylist[currentTrackIndex].name.split('.').slice(0, -1).join('.'), "Música Local");
            } else {
                audioPlayer.pause();
                currentTrackIndex = -1;
                renderLocalPlaylist();
            }
        }

        function togglePlayPause() {
            if (audioPlayer.paused) {
                if (audioPlayer.src && localPlaylist.length > 0) {
                    audioPlayer.play();
                } else if (localPlaylist.length > 0) {
                    currentTrackIndex = 0;
                    playTrack(currentTrackIndex);
                }
            } else {
                audioPlayer.pause();
            }
        }

        function nextTrack() {
            if (localPlaylist.length === 0) return;
            currentTrackIndex = (currentTrackIndex + 1) % localPlaylist.length;
            playTrack(currentTrackIndex);
        }

        function prevTrack() {
            if (localPlaylist.length === 0) return;
            currentTrackIndex = (currentTrackIndex - 1 + localPlaylist.length) % localPlaylist.length;
            playTrack(currentTrackIndex);
        }

        function setVolume(value) {
            audioPlayer.volume = parseFloat(value);
        }

        function removeTrack(index) {
            if (index === currentTrackIndex) {
                audioPlayer.pause();
                audioPlayer.src = '';
                currentTrackIndex = -1;
            }
            localPlaylist.splice(index, 1);
            if (currentTrackIndex > index) {
                currentTrackIndex--;
            } else if (currentTrackIndex === index && localPlaylist.length > 0) {
                currentTrackIndex = currentTrackIndex % localPlaylist.length;
                playTrack(currentTrackIndex);
            } else if (localPlaylist.length === 0) {
                currentTrackIndex = -1;
            }
            renderLocalPlaylist();
        }

        function showNowPlaying(title, artist = "Desconhecido") {
            const popup = document.getElementById('nowPlayingPopup');
            if (!popup) return;

            clearTimeout(nowPlayingTimeout);

            popup.textContent = `${title} - ${artist}`;
            popup.classList.add('show');

            nowPlayingTimeout = setTimeout(() => {
                popup.classList.remove('show');
            }, 5000);
        }

        // --- FUNÇÕES DE COMBATE (NOVAS) ---
        function openAttackEditModal(index = null) {
            currentEditingAttackIndex = index;
            const attack = index !== null ? 
                               characterData.combat.attacks[index] :
                               { name: '', attackBonus: '', damage: '', type: 'arma corpo a corpo', notes: '' };
            
            document.getElementById('attack-modal-title').textContent = index !== null ? 'Editar Ataque' : 'Adicionar Novo Ataque';
            document.getElementById('attack-name-input').value = attack.name;
            document.getElementById('attack-bonus-input').value = attack.attackBonus;
            document.getElementById('attack-damage-input').value = attack.damage;
            document.getElementById('attack-type-input').value = attack.type;
            document.getElementById('attack-notes-input').value = attack.notes;

            openModal('attackEditModal');
        }

        function saveAttack() {
            const attackToSave = {
                name: document.getElementById('attack-name-input').value,
                attackBonus: document.getElementById('attack-bonus-input').value,
                damage: document.getElementById('attack-damage-input').value,
                type: document.getElementById('attack-type-input').value,
                notes: document.getElementById('attack-notes-input').value
            };

            if (!attackToSave.name) return; // Ataque precisa ter um nome

            if (currentEditingAttackIndex !== null) {
                characterData.combat.attacks[currentEditingAttackIndex] = attackToSave;
            } else {
                characterData.combat.attacks.push(attackToSave);
            }

            saveData();
            renderAttacks();
            closeModal('attackEditModal');
        }

        function deleteAttack(index) {
            characterData.combat.attacks.splice(index, 1);
            saveData();
            renderAttacks();
        }

        function renderAttacks() {
            const attackListContainer = document.getElementById('attackList');
            if (!attackListContainer) return;

            attackListContainer.innerHTML = ''; // Limpa a lista antes de renderizar

            if (characterData.combat.attacks.length === 0) {
                attackListContainer.innerHTML = '<p class="opacity-70 italic text-center">Nenhum ataque adicionado ainda.</p>';
            } else {
                characterData.combat.attacks.forEach((attack, index) => {
                    const attackItemDiv = document.createElement('div');
                    attackItemDiv.className = 'attack-item';
                    attackItemDiv.innerHTML = `
                        <div class="attack-item-header">
                            <h4>${attack.name}</h4>
                            <div class="flex gap-2">
                                <button class="gothic-btn text-xs py-1 px-2" onclick="openAttackEditModal(${index})">Editar</button>
                                <button class="gothic-btn text-xs py-1 px-2 !border-red-500 !text-red-500 hover:!bg-red-500 hover:!text-black" onclick="deleteAttack(${index})">X</button>
                            </div>
                        </div>
                        <div class="attack-details">
                            <span>Bônus: ${attack.attackBonus || '--'}</span> | 
                            <span>Dano: ${attack.damage || '--'}</span> | 
                            <span>Tipo: ${attack.type || '--'}</span>
                        </div>
                        ${attack.notes ? `<p class="attack-notes">${attack.notes}</p>` : ''}
                    `;
                    attackListContainer.appendChild(attackItemDiv);
                });
            }
            lucide.createIcons();
        }

        // NOVO: Funções de Gestão de Saúde e Descansos
        // Renomeada para evitar conflito com a função rollDice do rolo de dados
        function rollIndividualDie(dieType) {
            const sides = parseInt(dieType.substring(1)); // 'd8' -> 8
            return Math.floor(Math.random() * sides) + 1;
        }

        function openSpendHitDicePrompt() {
            const currentHD = characterData.hp.hitDice.current;
            const hdType = characterData.hp.hitDice.type;

            document.getElementById('available-hd-count').textContent = currentHD;
            document.getElementById('hd-type-display').textContent = hdType;
            document.getElementById('num-hd-to-spend').value = Math.min(1, currentHD); // Default to 1 or 0 if none
            document.getElementById('num-hd-to-spend').max = currentHD; // Max selectable is current available
            document.getElementById('hd-roll-result').textContent = ''; // Clear previous result

            openModal('spendHitDiceModal');
        }

        function performSpendHitDice() {
            const numDiceToSpend = parseInt(document.getElementById('num-hd-to-spend').value) || 0;
            const currentHD = characterData.hp.hitDice.current;
            const hdType = characterData.hp.hitDice.type;
            const conModifier = calculateModifier(characterData.attributes.con);

            if (numDiceToSpend <= 0 || numDiceToSpend > currentHD) {
                document.getElementById('hd-roll-result').textContent = 'Número inválido de Dados de Vida!';
                return;
            }

            let totalHealed = 0;
            let rolls = [];
            for (let i = 0; i < numDiceToSpend; i++) {
                const roll = rollIndividualDie(hdType); // Usa a função auxiliar
                const healAmount = roll + conModifier;
                rolls.push(`${roll}${conModifier >= 0 ? '+' : ''}${conModifier}`);
                totalHealed += Math.max(1, healAmount); // Cura mínima de 1 por dado
            }

            characterData.hp.hitDice.current -= numDiceToSpend;
            characterData.hp.current = Math.min(characterData.hp.max, characterData.hp.current + totalHealed);

            document.getElementById('hd-roll-result').textContent = `Curado ${totalHealed} PV! (${rolls.join(' + ')})`;
            document.getElementById('hit-dice-current').value = characterData.hp.hitDice.current; // Update main UI
            document.getElementById('available-hd-count').textContent = characterData.hp.hitDice.current; // Update modal UI

            updateHpBar();
            saveData();
            // Keep modal open briefly to show result, then close automatically after a delay
            setTimeout(() => closeModal('spendHitDiceModal'), 2000);
        }

        function takeShortRest() {
            characterData.rests.short++;
            // Recupera pelo menos metade dos Dados de Vida (arredondado para baixo)
            characterData.hp.hitDice.current = Math.min(characterData.hp.hitDice.max, characterData.hp.hitDice.current + Math.max(1, Math.floor(characterData.hp.hitDice.max / 2)));
            
            // NOVO: Redefine recursos que se recuperam em Descanso Curto
            resetResources('short-rest');

            document.getElementById('short-rests-count').textContent = characterData.rests.short;
            document.getElementById('hit-dice-current').value = characterData.hp.hitDice.current; // Update main UI

            saveData();
            updateAllCalculations(); // Recalcula tudo para garantir consistência
            showMessage("Descanso Curto Concluído! Seus Dados de Vida foram recuperados e recursos de Descanso Curto redefinidos. Você pode gastá-los agora.");
        }

        function takeLongRest() {
            characterData.rests.long++;
            characterData.hp.current = characterData.hp.max; // Full HP
            characterData.hp.hitDice.current = characterData.hp.hitDice.max; // All Hit Dice restored
            
            // NOVO: Redefine todos os recursos que se recuperam em Descanso Longo ou Uma Vez por Dia
            resetResources('long-rest');
            resetResources('once-per-day');

            // Limpa todas as condições de status ativas (geralmente acontece em descanso longo)
            characterData.combat.conditions = []; // NOVO: Limpa as condições
            renderActiveConditions(); // Atualiza a exibição das condições

            document.getElementById('long-rests-count').textContent = characterData.rests.long;
            document.getElementById('hpCurrent').value = characterData.hp.current; // Update main UI HP
            document.getElementById('hit-dice-current').value = characterData.hp.hitDice.current; // Update main UI Hit Dice

            saveData();
            updateAllCalculations(); // Recalcula tudo para garantir consistência
            showMessage("Descanso Longo Concluído! HP, Dados de Vida e a maioria dos recursos totalmente restaurados. Condições limpas.");
        }

        // NOVO: Funções para Recursos de Classe e Habilidades Especiais
        function toggleResourceUses() {
            const resetType = document.getElementById('resource-reset-input').value;
            const usesContainer = document.getElementById('resource-uses-container');
            if (resetType === 'at-will' || resetType === 'other') {
                usesContainer.classList.add('hidden');
            } else {
                usesContainer.classList.remove('hidden');
            }
        }

        function openResourceEditModal(resourceId = null) {
            currentEditingResourceIndex = resourceId !== null ? characterData.combat.resources.findIndex(r => r.id === resourceId) : null;
            
            const resource = resourceId !== null && currentEditingResourceIndex !== -1 ?
                characterData.combat.resources[currentEditingResourceIndex] :
                { id: Date.now(), name: '', description: '', type: 'class-feature', uses: { current: 0, max: 0, reset: 'at-will' } };

            document.getElementById('resource-modal-title').textContent = resourceId !== null ? 'Editar Recurso' : 'Adicionar Novo Recurso';
            document.getElementById('resource-name-input').value = resource.name;
            document.getElementById('resource-description-input').value = resource.description;
            document.getElementById('resource-type-input').value = resource.type;
            document.getElementById('resource-reset-input').value = resource.uses.reset;
            document.getElementById('resource-uses-current-input').value = resource.uses.current;
            document.getElementById('resource-uses-max-input').value = resource.uses.max;

            toggleResourceUses(); // Atualiza a visibilidade dos campos de usos
            openModal('resourceEditModal');
        }

        function saveResource() {
            const name = document.getElementById('resource-name-input').value;
            const description = document.getElementById('resource-description-input').value;
            const type = document.getElementById('resource-type-input').value;
            const reset = document.getElementById('resource-reset-input').value;
            let currentUses = 0;
            let maxUses = 0;

            if (reset !== 'at-will' && reset !== 'other') {
                currentUses = parseInt(document.getElementById('resource-uses-current-input').value) || 0;
                maxUses = parseInt(document.getElementById('resource-uses-max-input').value) || 0;
            }

            if (!name) {
                showMessage("O nome do recurso/habilidade não pode estar vazio.", 3000);
                return;
            }

            const resourceToSave = {
                id: currentEditingResourceIndex !== null && currentEditingResourceIndex !== -1 ? characterData.combat.resources[currentEditingResourceIndex].id : Date.now(),
                name,
                description,
                type,
                uses: { current: currentUses, max: maxUses, reset }
            };

            if (currentEditingResourceIndex !== null && currentEditingResourceIndex !== -1) {
                characterData.combat.resources[currentEditingResourceIndex] = resourceToSave;
            } else {
                characterData.combat.resources.push(resourceToSave);
            }
            saveData();
            renderResources();
            closeModal('resourceEditModal');
            showMessage("Recurso/Habilidade salva com sucesso!", 2000);
        }

        function deleteResource(resourceId) {
            characterData.combat.resources = characterData.combat.resources.filter(res => res.id !== resourceId);
            saveData();
            renderResources();
            showMessage("Recurso/Habilidade removida.", 2000);
        }

        function useResource(resourceId) {
            const resource = characterData.combat.resources.find(res => res.id === resourceId);
            if (resource && resource.uses.reset !== 'at-will' && resource.uses.current > 0) {
                resource.uses.current--;
                saveData();
                renderResources(); // Re-renderiza para atualizar o contador
                showMessage(`Recurso "${resource.name}" usado. Usos restantes: ${resource.uses.current}`, 1500);
            } else if (resource && resource.uses.current <= 0) {
                showMessage(`Você não tem usos restantes para "${resource.name}".`, 1500);
            }
        }

        function resetResource(resourceId) {
            const resource = characterData.combat.resources.find(res => res.id === resourceId);
            if (resource && resource.uses.reset !== 'at-will') {
                resource.uses.current = resource.uses.max;
                saveData();
                renderResources(); // Re-renderiza para atualizar o contador
                showMessage(`Recurso "${resource.name}" redefinido.`, 1500);
            }
        }
        
        function resetResources(resetType) {
            characterData.combat.resources.forEach(res => {
                if (res.uses.reset === resetType) {
                    res.uses.current = res.uses.max;
                }
            });
            saveData();
            renderResources();
        }

        function renderResources() {
            const resourcesListContainer = document.getElementById('resourcesList');
            if (!resourcesListContainer) return;

            resourcesListContainer.innerHTML = '';

            if (characterData.combat.resources.length === 0) {
                resourcesListContainer.innerHTML = '<p class="opacity-70 italic text-center">Nenhum recurso ou habilidade adicionada ainda.</p>';
            } else {
                characterData.combat.resources.forEach((resource) => { // Removido o index daqui
                    const resourceItemDiv = document.createElement('div');
                    resourceItemDiv.className = 'resource-item';
                    let usesDisplay = '';
                    let useButton = '';
                    let resetButton = '';

                    if (resource.uses.reset !== 'at-will' && resource.uses.reset !== 'other') {
                        usesDisplay = `<div class="flex items-center gap-1"><span>Usos: ${resource.uses.current} / ${resource.uses.max}</span></div>`;
                        useButton = `<button class="resource-use-btn" onclick="useResource(${resource.id})"><i data-lucide="minus" class="w-4 h-4"></i></button>`;
                        resetButton = `<button class="resource-use-btn" onclick="resetResource(${resource.id})"><i data-lucide="rotate-ccw" class="w-4 h-4"></i></button>`;
                    } else {
                        usesDisplay = `Usos: ${resource.uses.reset === 'at-will' ? 'À Vontade' : 'Outro'}`;
                    }

                    resourceItemDiv.innerHTML = `
                        <div class="resource-item-header">
                            <h4>${resource.name}</h4>
                            <div class="flex gap-2">
                                <button class="gothic-btn text-xs py-1 px-2" onclick="openResourceEditModal(${resource.id})">Editar</button>
                                <button class="gothic-btn text-xs py-1 px-2 !border-red-500 !text-red-500 hover:!bg-red-500 hover:!text-black" onclick="deleteResource(${resource.id})">X</button>
                            </div>
                        </div>
                        <div class="resource-details">
                            <span>Tipo: ${resource.type}</span> | 
                            <span>Redefine: ${resource.uses.reset}</span>
                        </div>
                        <p class="resource-notes">${resource.description || 'Nenhuma descrição.'}</p>
                        <div class="flex items-center justify-end gap-2 mt-2">
                            ${usesDisplay}
                            ${useButton}
                            ${resetButton}
                        </div>
                    `;
                    resourcesListContainer.appendChild(resourceItemDiv);
                });
            }
            lucide.createIcons();
        }

        // NOVO: Funções para Gerenciamento de Condições de Status
        function openConditionModal() {
            const allConditionsListContainer = document.getElementById('allConditionsList');
            if (!allConditionsListContainer) return;

            allConditionsListContainer.innerHTML = ''; // Limpa a lista antes de renderizar

            // Itera sobre a lista MESTRA de CONDIÇÕES para criar todos os checkboxes
            CONDITIONS.forEach(condition => {
                // Verifica se esta condição está ativa no personagem
                const isChecked = characterData.combat.conditions.includes(condition.name);
                const conditionDiv = document.createElement('div');
                conditionDiv.className = 'condition-item p-2 flex items-center justify-between';
                if (isChecked) conditionDiv.classList.add('active'); // Adiciona classe 'active' se estiver marcada

                conditionDiv.innerHTML = `
                    <label class="flex items-center flex-grow cursor-pointer">
                        <input type="checkbox" class="condition-checkbox" ${isChecked ? 'checked' : ''} onchange="toggleCondition('${condition.name}', this.checked)">
                        <span class="text-base font-bold">${condition.name}</span>
                    </label>
                    <div class="text-sm opacity-80 max-w-[60%] text-right">${condition.description}</div>
                `;
                allConditionsListContainer.appendChild(conditionDiv);
            });
            lucide.createIcons(); // Garante que os ícones (se houver no futuro) sejam criados

            openModal('conditionModal');
        }

        function toggleCondition(conditionName, isChecked) {
            const index = characterData.combat.conditions.indexOf(conditionName);
            if (isChecked && index === -1) {
                characterData.combat.conditions.push(conditionName);
            } else if (!isChecked && index !== -1) {
                characterData.combat.conditions.splice(index, 1);
            }
            saveData();
            renderActiveConditions(); // Atualiza a lista na tela principal
            // Re-renderiza o modal de condições para atualizar a classe 'active' visualmente
            const checkboxEl = document.querySelector(`#allConditionsList input[type="checkbox"][onchange*="toggleCondition('${conditionName}', this.checked)"]`);
            if (checkboxEl) {
                checkboxEl.closest('.condition-item').classList.toggle('active', isChecked);
            }
        }

        function renderActiveConditions() {
            const activeConditionsListContainer = document.getElementById('activeConditionsList');
            if (!activeConditionsListContainer) return;

            activeConditionsListContainer.innerHTML = '';

            if (characterData.combat.conditions.length === 0) {
                activeConditionsListContainer.innerHTML = '<p class="opacity-70 italic text-center">Nenhuma condição ativa.</p>';
            } else {
                characterData.combat.conditions.forEach(conditionName => {
                    const conditionData = CONDITIONS.find(c => c.name === conditionName);
                    if (conditionData) {
                        const conditionItemDiv = document.createElement('div');
                        conditionItemDiv.className = 'condition-item active p-2';
                        conditionItemDiv.innerHTML = `
                            <div class="condition-item-header">
                                <h4 style="color: var(--red-failure);">${conditionData.name}</h4>
                                <button class="gothic-btn text-xs py-1 px-2 !border-red-500 !text-red-500 hover:!bg-red-500 hover:!text-black" onclick="toggleCondition('${conditionData.name}', false)">Remover</button>
                            </div>
                            <p class="condition-notes">${conditionData.description}</p>
                        `;
                        activeConditionsListContainer.appendChild(conditionItemDiv);
                    }
                });
            }
            lucide.createIcons();
        }
    </script>
</body>
</html>
