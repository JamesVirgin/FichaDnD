<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FichaDnD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* A fonte 'Optimus Princeps' precisa ser carregada localmente ou de um CDN.
            Para este exemplo, o caminho 'path/to/OptimusPrinceps.woff2' é um placeholder.
            Você precisaria hospedar esses arquivos de fonte e atualizar os caminhos. */
        @font-face {
            font-family: 'Optimus Princeps';
            src: url('path/to/OptimusPrinceps.woff2') format('woff2'),
                 url('path/to/OptimusPrinceps.woff') format('woff');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        :root {
            /* Cores base da lore: Dourado para a luz da redenção, cinzas e preto para as sombras */
            --gold-glow: #ffd700; /* Dourado vibrante para brilhos e destaques */
            --gold-glow-hover: #ffec80; /* Dourado mais claro para hover */
            --text-primary: #f0f0f0; /* Branco/Prateado muito claro para texto principal (almas purificadas) */
            --bg-dark-transparent: rgba(10, 5, 5, 0.85); /* Fundo escuro semitransparente, mantendo a profundidade */
            --border-gold: rgba(255, 215, 0, 0.6); /* Borda dourada com mais presença */
            --green-success: #22c55e; /* Verde para sucesso */
            --red-failure: #ef4444; /* Vermelho para falha */
            --black-transparent: rgba(0, 0, 0, 0.6); /* Fundo ainda mais transparente para elementos internos */
            --hp-gradient-start: #6b0000; /* Gradiente de HP: escuro para claro */
            --hp-gradient-end: #ff0000;
            --ethereal-blue: rgba(48, 64, 80, 0.5); /* Azul etéreo sutil para elementos de fundo */

            /* Variáveis para cores de chama (default Radiant) */
            --flame-orange: rgba(255, 165, 0, 0.7);
            --flame-yellow: rgba(255, 200, 0, 0.5);
            --flame-red: rgba(255, 100, 0, 0.3);
            --flame-orange-alt: rgba(255, 180, 0, 0.8);
            --flame-yellow-alt: rgba(255, 210, 0, 0.6);
            --flame-red-alt: rgba(255, 80, 0, 0.4);

            /* Nova variável para intensidade do brilho etéreo/chama */
            --flame-spread-factor: 1.0; /* Fator para controlar o "espalha" (spread) da box-shadow */

            /* Novas variáveis para cores de texto específicas */
            --header-gold-text: #ffd700; /* Cor padrão para títulos e cabeçalhos */
            --success-text: #22c55e; /* Cor padrão para texto de sucesso */
            --failure-text: #ef4444; /* Cor padrão para texto de falha */
        }

        /* Tema Necrótico */
        body.theme-necrotic {
            --gold-glow: #00E6E6; /* Bright Cyan */
            --gold-glow-hover: #00FFFF; /* Even brighter Cyan */
            --text-primary: #A0A0A0; /* Darker grey for readability on dark backgrounds */
            --border-gold: rgba(0, 150, 150, 0.6); /* Darker teal for borders */
            --green-success: #7CFC00; /* Lime Green */
            --red-failure: #8B008B; /* Dark Magenta/Purple */
            --black-transparent: rgba(0, 0, 0, 0.7);
            --hp-gradient-start: #4B0082; /* Indigo - deep purple */
            --hp-gradient-end: #800080; /* Purple */
            --flame-orange: rgba(0, 180, 180, 0.7); /* Teal flame start */
            --flame-yellow: rgba(0, 220, 220, 0.5); /* Lighter teal flame */
            --flame-red: rgba(0, 120, 120, 0.3); /* Darker teal flame */
            --flame-orange-alt: rgba(0, 190, 190, 0.8);
            --flame-yellow-alt: rgba(0, 230, 230, 0.6);
            --flame-red-alt: rgba(0, 130, 130, 0.4);
            --header-gold-text: #00E6E6;
            --success-text: #7CFC00;
            --failure-text: #8B008B;
        }

        body {
            font-family: 'Optimus Princeps', serif;
            background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0.7), rgba(10, 5, 5, 0.95)), url('https://storage.googleapis.com/gemini-prod-us-west1-assets/user/uploaded_file_517e3f88-4c9b-4401-b66e-c533c3937777.jpg'); /* Updated placeholder background image */
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text-primary);
            overflow-y: auto;
            overflow-x: hidden;
            min-height: 1080px;
            padding-bottom: 2rem;
            transition: background-color 0.5s ease;
        }

        /* Custom Scrollbar - mantém o dourado como um filete de luz */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #080404; }
        ::-webkit-scrollbar-thumb { background: var(--gold-glow); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--gold-glow-hover); }

        .gothic-card {
            background-color: var(--bg-dark-transparent);
            border: 1px solid var(--border-gold);
            border-radius: 8px;
            box-shadow: 0 0 18px rgba(255, 215, 0, 0.25);
            backdrop-filter: blur(6px);
            position: relative;
            z-index: 1;
            overflow: visible; /* Allows child elements (like toggle button) to stick out */
        }

        /* Class for cards that will have the subtle flame effect */
        .glowing-card::before {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border-radius: 10px;
            z-index: -1;
            pointer-events: none;
            animation: flame-flicker 2s infinite alternate;
            opacity: var(--flame-glow-opacity, 0.8); /* Adjusted default opacity */
        }

        /* Desabilita o brilho etéreo quando a classe no-flame-glow está presente no body */
        body.no-flame-glow .glowing-card::before,
        body.no-flame-glow .aura-gold {
            animation: none !important;
            box-shadow: none !important;
            opacity: 0 !important;
        }

        /* Keyframes for the subtle flame effect */
        @keyframes flame-flicker {
            0% {
                box-shadow:
                    0 0 8px calc(3px * var(--flame-spread-factor)) var(--flame-orange),
                    0 0 16px calc(6px * var(--flame-spread-factor)) var(--flame-yellow),
                    0 0 24px calc(9px * var(--flame-spread-factor)) var(--flame-red);
                opacity: 0.7;
            }
            50% {
                box-shadow:
                    0 0 10px calc(4px * var(--flame-spread-factor)) var(--flame-orange-alt),
                    0 0 20px calc(8px * var(--flame-spread-factor)) var(--flame-yellow-alt),
                    0 0 28px calc(11px * var(--flame-spread-factor)) var(--flame-red-alt);
                opacity: 0.9;
            }
            100% {
                box-shadow:
                    0 0 8px calc(3px * var(--flame-spread-factor)) var(--flame-orange),
                    0 0 16px calc(6px * var(--flame-spread-factor)) var(--flame-yellow),
                    0 0 24px calc(9px * var(--flame-spread-factor)) var(--flame-red);
                opacity: 0.7;
            }
        }

        /* Brilho etéreo para a imagem do personagem - also more subtle */
        .aura-gold {
            border: none;
            animation: image-flame-glow 2s infinite alternate;
            position: relative;
            z-index: 10;
        }

        @keyframes image-flame-glow {
            0% {
                box-shadow:
                    0 0 10px calc(5px * var(--flame-spread-factor)) var(--flame-orange),
                    0 0 20px calc(10px * var(--flame-spread-factor)) var(--flame-yellow),
                    0 0 30px calc(15px * var(--flame-spread-factor)) var(--flame-red);
                opacity: 0.8;
            }
            50% {
                box-shadow:
                    0 0 12px calc(6px * var(--flame-spread-factor)) var(--flame-orange-alt),
                    0 0 25px calc(12px * var(--flame-spread-factor)) var(--flame-yellow-alt),
                    0 0 35px calc(18px * var(--flame-spread-factor)) var(--flame-red-alt);
                opacity: 1;
            }
            100% {
                box-shadow:
                    0 0 10px calc(5px * var(--flame-spread-factor)) var(--flame-orange),
                    0 0 20px calc(10px * var(--flame-spread-factor)) var(--flame-yellow),
                    0 0 30px calc(15px * var(--flame-spread-factor)) var(--flame-red);
                opacity: 0.8;
            }
        }

        .gothic-input, .gothic-select, .gothic-textarea {
            background-color: var(--black-transparent);
            border: 1px solid var(--border-gold);
            color: var(--text-primary); border-radius: 4px; transition: all 0.3s ease;
            width: 100%; padding: 0.5rem;
        }
        .gothic-input:focus, .gothic-select:focus, .gothic-textarea:focus {
            outline: none;
            box-shadow: 0 0 12px var(--gold-glow);
            border-color: var(--gold-glow);
        }

        /* Hide number input arrows (spinners) for Webkit (Chrome, Safari) */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Hide number input arrows (spinners) for Firefox */
        input[type="number"] {
            -moz-appearance: textfield;
        }

        .action-button-group { position: relative; }
        .action-button-group .action-button-name {
            position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%);
            background-color: #000; color: var(--gold-glow); padding: 2px 8px;
            border-radius: 4px; font-size: 0.75rem; opacity: 0; visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s; white-space: nowrap;
        }
        .action-button-group:hover .action-button-name { opacity: 1; visibility: visible; }

        .gothic-btn {
            background-color: transparent; border: 1px solid var(--gold-glow); color: var(--gold-glow);
            padding: 8px 16px; border-radius: 4px; font-weight: bold; text-transform: uppercase;
            letter-spacing: 1px; transition: all 0.3s ease; text-shadow: 0 0 5px var(--gold-glow);
            cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        .gothic-btn:hover {
            background-color: var(--gold-glow);
            color: #000;
            box-shadow: 0 0 18px var(--gold-glow);
        }

        .hp-bar-container { background-color: var(--black-transparent); border: 1px solid var(--border-gold); border-radius: 5px; padding: 2px; }
        #hpBar { background: linear-gradient(to right, var(--hp-gradient-start), var(--hp-gradient-end)); height: 20px; border-radius: 3px; transition: width 0.5s ease-in-out; text-shadow: 1px 1px 2px #000; }

        /* Aumentado o tamanho dos death saves para melhor clique em mobile */
        .death-save { 
            width: 1.5rem; /* Aumentado */
            height: 1.5rem; /* Aumentado */
            border: 1px solid var(--border-gold); 
            border-radius: 50%; 
            cursor: pointer; 
            transition: all 0.2s; 
        }
        .death-save.success.checked { background-color: var(--green-success); border-color: var(--green-success); box-shadow: 0 0 8px var(--green-success); }
        .death-save.failure.checked { background-color: var(--red-failure); border-color: var(--red-failure); box-shadow: 0 0 8px var(--red-failure); }

        .advantage-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            border: 1px solid var(--border-gold);
            cursor: pointer;
            transition: all 0.2s;
            justify-self: center;
            opacity: 0.4; /* Make them less prominent when not toggled */
        }
        .advantage-dot.toggled {
            background-color: var(--gold-glow);
            box-shadow: 0 0 5px var(--gold-glow);
            opacity: 1; /* Full opacity when toggled */
        }

        .proficiency-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1px solid var(--border-gold);
            cursor: pointer;
            transition: all 0.2s;
            justify-self: center;
            opacity: 0.4; /* Make them less prominent when not toggled */
        }
        .proficiency-dot.toggled {
            background-color: var(--text-primary);
            box-shadow: 0 0 8px var(--text-primary);
            border-color: var(--text-primary);
            opacity: 1; /* Full opacity when toggled */
        }

        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7); backdrop-filter: blur(8px);
            display: none; justify-content: center; align-items: center; z-index: 50; padding: 1rem;
        }
        /* Ajuste do z-index para o modal de edição de magia */
        #spellEditModal {
            z-index: 55; /* Deve ser maior que o spellModal */
        }
        /* Novo modal de visualização de imagem em tela cheia */
        #imageViewerModal {
            z-index: 60; /* Maior que todos os outros modais */
        }
        #imageViewerModal .modal-content {
            background: none; /* Sem fundo ou borda gótica para foco na imagem */
            border: none;
            box-shadow: none;
            backdrop-filter: none;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            max-width: 90vw;
            max-height: 90vh;
        }
        #imageViewerModal img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; /* Garante que a imagem se ajuste sem cortar */
            border-radius: 8px;
            border: 2px solid var(--gold-glow);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .modal-content { width: 90%; max-width: 800px; max-height: 90vh; }

        /* Attribute Item Styles (for attributes below image) */
        #attribute-bar {
            display: flex;
            justify-content: center;
            gap: 2.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        .attribute-item {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            width: 70px;
        }
        .attr-score-display {
            width: 50px;
            height: 50px;
            background: var(--black-transparent);
            border-radius: 50%;
            border: 1px solid var(--border-gold);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease-in-out;
            font-size: 1.5rem;
            font-weight: bold;
        }
        .attr-name {
            font-size: 0.9rem;
            margin-top: 0.25rem;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .attr-modifier { /* Popup on hover */
            position: absolute;
            background: #000;
            color: var(--gold-glow);
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 0.8rem;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            white-space: nowrap;
            pointer-events: none;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: bold;
        }
        .attribute-item:hover .attr-modifier { opacity: 1; visibility: visible; }
        .attribute-item:hover .attr-score-display { transform: scale(1.1); background: var(--gold-glow); color: #000; }

        /* Settings Icon */
        #settings-btn {
            position: absolute;
            top: 1rem;
            left: 1rem;
            opacity: 0.5;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        #settings-btn:hover { opacity: 1; transform: scale(1.1) rotate(45deg); }
        input[type="color"] {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            width: 44px; height: 44px; background-color: transparent;
            border: none; cursor: pointer; padding: 0;
        }
        input[type="color"]::-webkit-color-swatch { border-radius: 50%; border: 2px solid var(--border-gold); }
        input[type="color"]::-moz-color-swatch { border-radius: 50%; border: 2px solid var(--border-gold); }

        /* Estilo para agrupar habilidades e perícias */
        .ability-group {
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid rgba(255, 215, 0, 0.1);
        }
        .ability-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        /* Alinhamento geral para habilidades e perícias */
        .ability-row {
            display: grid;
            grid-template-columns: 2.5fr auto auto 1fr; /* Nome, Ponto Vantagem, Ponto Proficiência, Total */
            align-items: center;
            gap: 0.5rem;
            min-height: 2rem;
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }

        .ability-row label {
            text-align: left;
            white-space: normal;
            overflow: visible;
            text-overflow: clip;
            font-size: 1rem;
        }

        .ability-row span.font-bold.text-lg {
            justify-self: center;
            font-size: 1.1rem;
        }

        /* GLOBAL TABS STYLING */
        #global-tabs {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border-gold);
            padding-bottom: 0.5rem;
            flex-wrap: wrap; /* Allow tabs to wrap on smaller screens */
        }
        .tab-button {
            background-color: var(--black-transparent);
            border: 1px solid var(--border-gold);
            color: var(--text-primary);
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap; /* Prevent text wrapping within button */
        }
        .tab-button:hover {
            background-color: rgba(255, 215, 0, 0.1); /* Subtle hover */
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
            color: var(--gold-glow);
        }
        .tab-button.active {
            background-color: var(--gold-glow);
            color: #000;
            box-shadow: 0 0 15px var(--gold-glow);
            border-color: var(--gold-glow);
            transform: translateY(-2px); /* Slight lift for active tab */
        }

        .tab-content {
            display: none; /* Hidden by default */
        }
        .tab-content.active {
            display: block; /* Show active tab content */
        }


        /* Spell Modal Tabs (still used within Grimório tab) */
        .spell-modal-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-gold);
            padding-bottom: 0.5rem;
            gap: 1rem;
        }
        .spell-modal-tab-button {
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: 'Optimus Princeps', serif;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        .spell-modal-tab-button.active {
            color: var(--gold-glow);
            background-color: rgba(255, 215, 0, 0.1);
            box-shadow: 0 0 8px rgba(255, 215, 0, 0.2);
        }
        .spell-modal-tab-button:hover:not(.active) {
            background-color: rgba(255, 215, 0, 0.05);
        }
        .spell-modal-tab-content {
            display: none;
        }
        .spell-modal-tab-content.active {
            display: block;
        }

        /* Music Player Styling */
        #musicPlayerCard {
            margin-top: 1.5rem;
        }

        /* Removemos as abas, então esses estilos não são mais estritamente necessários aqui */
        .music-player-tabs {
            display: none;
        }
        .music-player-tab-button {
            display: none;
        }

        .music-player-tab-content {
            display: block;
            padding: 1rem;
        }
        .music-player-tab-content.hidden {
            display: none;
        }

        #localMusicDropArea {
            border: 2px dashed var(--border-gold);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        #localMusicDropArea.drag-over {
            background-color: rgba(255, 215, 0, 0.1);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }
        #localMusicInput {
            display: none;
        }

        #localPlaylist {
            list-style: none;
            padding: 0;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 1rem;
        }
        #localPlaylist li {
            background-color: var(--black-transparent);
            padding: 0.5rem;
            margin-bottom: 0.25rem;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }
        #localPlaylist li.active-track {
            background-color: rgba(255, 215, 0, 0.25);
            border: 1px solid var(--gold-glow);
        }
        #localPlaylist li button {
            background: none;
            border: none;
            color: var(--red-failure);
            cursor: pointer;
            font-size: 1rem;
        }

        #musicControls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
        }
        #musicControls button {
            background-color: var(--black-transparent);
            border: 1px solid var(--border-gold);
            color: var(--gold-glow);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        #musicControls button:hover {
            background-color: var(--gold-glow);
            color: #000;
            box-shadow: 0 0 8px var(--gold-glow);
        }
        #volumeControl {
            width: 100px;
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: var(--black-transparent);
            outline: none;
            border-radius: 4px;
            transition: opacity .2s;
        }
        #volumeControl::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--gold-glow);
            cursor: pointer;
            box-shadow: 0 0 5px var(--gold-glow);
        }
        #volumeControl::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--gold-glow);
            cursor: pointer;
            box-shadow: 0 0 5px var(--gold-glow);
        }

        /* Now Playing Pop-up */
        #nowPlayingPopup {
            position: fixed;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.85);
            border: 1px solid var(--gold-glow);
            border-radius: 0 0 8px 8px;
            color: var(--text-primary);
            padding: 0.75rem 1.5rem;
            font-family: 'Optimus Princeps', serif;
            font-size: 1.1rem;
            text-align: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: top 0.5s ease-out, opacity 0.5s ease-out;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            max-width: 90%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #nowPlayingPopup.show {
            top: 0;
            opacity: 1;
            visibility: visible;
        }

        /* Message Pop-up (for alerts) */
        .message-popup {
            position: fixed;
            top: -100px; /* Start off-screen */
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.85);
            border: 1px solid; /* Border will change based on success/failure */
            border-radius: 0 0 8px 8px;
            padding: 0.75rem 1.5rem;
            font-family: 'Optimus Princeps', serif;
            font-size: 1.1rem;
            text-align: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: top 0.5s ease-out, opacity 0.5s ease-out;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            max-width: 90%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .message-popup.show {
            top: 0; /* Slide in */
            opacity: 1;
            visibility: visible;
        }
        .message-popup.success {
            color: var(--success-text);
            border-color: var(--green-success);
        }
        .message-popup.error {
            color: var(--failure-text);
            border-color: var(--red-failure);
        }


        /* Inventory Item Grid Display */
        .inventory-item-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); /* Imagens um pouco maiores */
            gap: 1rem;
            /* Adicionado padding para garantir que a sombra do hover não seja cortada pelos limites do overflow */
            padding: 5px; /* Pequeno padding para evitar clipping superior/inferior da sombra */
            margin: -5px; /* Compensar o padding para manter o layout original */
        }
        .inventory-item-card {
            background-color: var(--black-transparent);
            border: 1px solid var(--border-gold);
            border-radius: 8px;
            padding: 0.75rem;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        .inventory-item-card:hover {
            box-shadow: 0 0 10px var(--gold-glow);
            transform: translateY(-2px);
            /* Garante que o item em hover fique acima dos outros, se houver sobreposição */
            z-index: 2;
        }
        .inventory-item-card img {
            width: 100px; /* Imagem maior no grid */
            height: 100px; /* Imagem maior no grid */
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid rgba(255, 215, 0, 0.4);
        }
        .inventory-item-card .item-name { /* Mudei de .item-qty para .item-name para a exibição principal */
            font-weight: bold;
            font-size: 0.9rem;
            color: var(--text-primary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            width: 100%;
        }
        .inventory-item-card .delete-item-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            color: var(--red-failure);
            cursor: pointer;
            font-size: 1rem;
            padding: 0;
            line-height: 1;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .inventory-item-card .delete-item-btn:hover {
            opacity: 1;
        }
        #item-detail-image {
            width: 160px; /* Imagem ainda maior no modal de detalhes */
            height: 160px; /* Imagem ainda maior no modal de detalhes */
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid var(--gold-glow);
            cursor: pointer; /* Indica que a imagem é clicável */
        }
        /* Corrigido: Removido gothic-card do #item-detail-notes para evitar brilho cortado */
        #item-detail-notes {
            background-color: var(--black-transparent); /* Mantém o fundo transparente */
            border: 1px solid var(--border-gold); /* Mantém a borda */
            border-radius: 8px; /* Mantém as bordas arredondadas */
            padding: 0.75rem; /* Mantém o padding */
        }

        /* Estilos para a seção de ataques */
        .attack-item {
            background-color: var(--black-transparent);
            border: 1px solid var(--border-gold);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }
        .attack-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .attack-item-header h4 {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--header-gold-text);
        }
        .attack-details {
            font-size: 0.85rem;
            opacity: 0.8;
        }
        .attack-notes {
            font-size: 0.9rem;
            margin-top: 0.5rem;
            border-top: 1px solid rgba(255, 215, 0, 0.1);
            padding-top: 0.5rem;
        }

        /* Estilos para recursos e condições */
        .resource-item, .condition-item {
            background-color: var(--black-transparent);
            border: 1px solid var(--border-gold);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }
        .resource-item-header, .condition-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .resource-item-header h4, .condition-item-header h4 {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--header-gold-text);
        }
        .resource-details, .condition-details {
            font-size: 0.85rem;
            opacity: 0.8;
        }
        .resource-notes, .condition-notes {
            font-size: 0.9rem;
            margin-top: 0.5rem;
            border-top: 1px solid rgba(255, 215, 0, 0.1);
            padding-top: 0.5rem;
        }
        .resource-uses {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: bold;
            color: var(--gold-glow);
        }
        .resource-use-btn {
            background-color: var(--black-transparent);
            border: 1px solid var(--border-gold);
            color: var(--gold-glow);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .resource-use-btn:hover {
            background-color: var(--gold-glow);
            color: #000;
            box-shadow: 0 0 8px var(--gold-glow);
        }
        .condition-checkbox {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border: 2px solid var(--border-gold);
            border-radius: 4px;
            cursor: pointer;
            display: inline-block;
            vertical-align: middle;
            position: relative;
            margin-right: 8px;
            transition: all 0.2s ease;
        }

        .condition-checkbox:checked {
            background-color: var(--red-failure);
            border-color: var(--red-failure);
            box-shadow: 0 0 8px var(--red-failure);
        }

        .condition-checkbox:checked::before {
            content: '\2713'; /* Checkmark unicode character */
            display: block;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 16px;
            line-height: 1;
        }

        .condition-item.active {
            background-color: rgba(255, 0, 0, 0.1);
            border-color: var(--red-failure);
            box-shadow: 0 0 10px var(--red-failure);
        }

        /* Styling for the collapsible quick access bar */
        /* The main container now also serves as the gothic-card */
        #global-quick-access-container {
            /* Inherits gothic-card styles */
            position: fixed;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 30;
            width: 95%;
            max-width: 500px;
            display: flex;
            flex-direction: column; /* Stack vertically */
            align-items: center;
            padding: 0; /* Remove default padding for internal control */
            transition: all 0.3s ease-in-out; /* For smooth overall height adjustment */
            /* gothic-card already has overflow: visible */
            /* Transparência adicionada aqui */
            background-color: rgba(10, 5, 5, 0.7); /* Mais transparente */
            box-shadow: 0 0 18px rgba(255, 215, 0, 0.15); /* Sombra mais sutil */
        }

        /* The toggle button is now positioned within the card, but sticking out */
        #quick-access-toggle-btn {
            background-color: var(--gold-glow);
            color: #000;
            border: 1px solid var(--gold-glow);
            border-radius: 50%;
            width: 40px; /* Increased size for mobile touch target */
            height: 40px; /* Increased size for mobile touch target */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: absolute; /* Positioned relative to #global-quick-access-container */
            top: -20px; /* Pull it up from the top edge by half its height to center it visually on the border */
            left: 50%;
            transform: translateX(-50%);
            z-index: 31; /* Ensure it's above other elements */
            box-shadow: 0 0 10px var(--gold-glow);
            transition: all 0.3s ease;
        }

        #quick-access-toggle-btn:hover {
            transform: translateX(-50%) scale(1.1);
            box-shadow: 0 0 15px var(--gold-glow);
        }

        #quick-access-toggle-btn i {
            transition: transform 0.3s ease;
        }
        #global-quick-access-container.collapsed #quick-access-toggle-btn i {
            transform: rotate(180deg); /* Rotate icon when collapsed */
        }

        /* This wrapper contains the actual quick access buttons and collapses */
        #quick-access-content-wrapper {
            width: 100%;
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
            overflow: hidden; /* Crucial for max-height animation to clip content */
            padding-top: 0.5rem; /* Space below the toggle button visually */
            padding-bottom: 0.5rem; /* Standard padding for content */
        }

        #global-quick-access-container.collapsed #quick-access-content-wrapper {
            max-height: 0 !important; /* Collapse to 0 height, making content invisible and occupying no space */
            opacity: 0;
            pointer-events: none; /* Disable interaction when collapsed */
            padding-top: 0; /* Remove padding when fully collapsed */
            padding-bottom: 0; /* Remove padding when fully collapsed */
        }

        /* Styling for Initiative and Proficiency when relocated */
        .stat-relocated {
            position: absolute;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            background-color: rgba(0, 0, 0, 0.7);
            border: 1px solid var(--border-gold);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            z-index: 11; /* Ensure it's above the image */
        }
        #initiative-relocated {
            right: 10px; /* Adjust as needed */
            top: 10px; /* Adjust as needed */
            color: var(--gold-glow);
            font-size: 1.5rem;
            font-weight: bold;
        }
        #proficiency-relocated {
            right: 10px; /* Adjust as needed */
            top: 90px; /* Position below initiative, adjust to avoid overlap */
            color: var(--text-primary);
            font-size: 1.2rem;
            font-weight: bold;
        }
        #initiative-relocated .stat-label, #proficiency-relocated .stat-label {
            font-size: 0.8rem;
            color: var(--text-primary);
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <input type="file" id="imageUpload" class="hidden" accept="image/*">
    <input type="file" id="wallpaperUpload" class="hidden" accept="image/*">
    <input type="file" id="importFileInput" class="hidden" accept="application/json">


    <div class="main-container space-y-6">

        <div id="settings-btn" onclick="openModal('settingsModal')" class="absolute top-4 left-4 z-20">
            <i data-lucide="settings" class="w-8 h-8"></i>
        </div>

        <div id="global-tabs">
            <button class="tab-button" data-tab="character-tab">Personagem</button>
            <button class="tab-button" data-tab="combat-tab">Combate</button>
            <button class="tab-button" data-tab="spellbook-tab">Grimório</button>
            <button class="tab-button" data-tab="inventory-tab">Inventário</button>
            <button class="tab-button" data-tab="history-tab">História</button>
            <button class="tab-button" data-tab="tools-tab">Ferramentas</button>
        </div>

        <div id="character-tab" class="tab-content space-y-6">
            <div class="gothic-card p-6 relative flex items-center header-section">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full">
                    <input id="characterName" class="gothic-input text-2xl col-span-1" placeholder="Nome do Personagem">
                    <input id="characterClass" class="gothic-input text-2xl col-span-1" placeholder="Classe">
                    <input id="characterRace" class="gothic-input text-2xl col-span-1" placeholder="Raça">
                </div>
            </div>

            <div class="gothic-card glowing-card top-central-section-container flex flex-col items-center p-6">
                <div class="flex items-center justify-center w-full relative" style="margin-bottom: 2rem;">
                    <div id="char-image-container" class="aura-gold flex-shrink-0 overflow-hidden mx-auto" style="width: 192px; height: 192px; border-radius: 50%;" onclick="document.getElementById('imageUpload').click()">
                        <img id="charImage" src="https://placehold.co/192x192/000000/ffd700?text=?" alt="Retrato" class="w-full h-full object-cover">
                        <div id="char-image-overlay" class="absolute inset-0 flex flex-col items-center justify-center text-center bg-black/50 text-text-primary text-sm font-bold transition-opacity duration-300 opacity-0">
                            Clique para Adicionar Imagem
                            <i data-lucide="image-plus" class="w-8 h-8 mt-2"></i>
                        </div>
                    </div>
                    
                    <div id="character-level-in-image-card" class="absolute z-10 flex flex-col items-center justify-center bg-black/60 border border-border-gold rounded-full p-4 shadow-md flex-shrink-0" style="width: 100px; height: 100px; left: calc(50% - 160px); top: 50%; transform: translateY(-50%);">
                        <label class="text-sm font-bold text-text-primary">Nível</label>
                        <div class="level-controls flex items-center gap-1">
                            <button class="level-btn !w-6 !h-6 !text-base" onclick="adjustLevel(-1)"><i data-lucide="minus" class="w-4 h-4"></i></button>
                            <span id="characterLevelDisplay" class="level-display text-3xl font-bold text-gold-glow" style="text-shadow: 0 0 8px var(--gold-glow);">1</span>
                            <button class="level-btn !w-6 !h-6 !text-base" onclick="adjustLevel(1)"><i data-lucide="plus" class="w-4 h-4"></i></button>
                        </div>
                    </div>

                    <div id="initiative-relocated" class="stat-relocated">
                        <span class="stat-label">Iniciativa</span>
                        <span id="initiative" class="block">+0</span>
                    </div>
                    <div id="proficiency-relocated" class="stat-relocated">
                        <span class="stat-label">Proficiência</span>
                        <span id="proficiencyBonusDisplay" class="block">+0</span>
                    </div>

                </div>

                <div id="attribute-bar">
                    </div>
            </div>

            <div class="middle-grid">
                <div class="col-span-1 space-y-6">
                    <div class="gothic-card p-6">
                        <h2 class="text-2xl text-center mb-4" style="color: var(--header-gold-text);">Habilidades e Perícias</h2>
                        <div id="ability-skill-groups" class="grid grid-cols-1 gap-0"></div>
                    </div>
                </div>

                <div class="col-span-full md:col-span-1 lg:col-span-1 space-y-6">
                    <div class="gothic-card p-4">
                        <h3 class="text-xl text-center mb-3" style="color: var(--header-gold-text);">Testes de Morte</h3>
                        <div class="flex justify-around items-center">
                            <div class="flex items-center gap-2">
                                <span class="text-lg" style="color: var(--success-text);">Sucessos:</span>
                                <div id="dss-1" class="death-save success" onclick="toggleDeathSave('successes', 0)"></div>
                                <div id="dss-2" class="death-save success" onclick="toggleDeathSave('successes', 1)"></div>
                                <div id="dss-3" class="death-save success" onclick="toggleDeathSave('successes', 2)"></div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-lg" style="color: var(--failure-text);">Falhas:</span>
                                <div id="dsf-1" class="death-save failure" onclick="toggleDeathSave('failures', 0)"></div>
                                <div id="dsf-2" class="death-save failure" onclick="toggleDeathSave('failures', 1)"></div>
                                <div id="dsf-3" class="death-save failure" onclick="toggleDeathSave('failures', 2)"></div>
                            </div>
                        </div>
                    </div>
                    <div class="gothic-card p-4">
                        <label class="text-xl text-center block mb-2" style="color: var(--header-gold-text);">Pontos de Vida</label>
                        <div class="flex items-center gap-3 my-2">
                            <input id="hpCurrent" type="number" class="gothic-input text-center text-lg" value="10"><span>/</span><input id="hpMax" type="number" class="gothic-input text-center text-lg" value="10">
                        </div>
                        <div class="hp-bar-container">
                            <div id="hpBar" class="text-center font-bold text-white text-base">100%</div>
                        </div>
                    </div>
                    <div class="gothic-card p-4 grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-lg text-center block" style="color: var(--header-gold-text);">PV Temporários</label>
                            <input id="hpTemp" type="number" class="gothic-input text-center text-xl" value="0">
                        </div>
                        <div>
                            <label class="text-lg text-center block" style="color: var(--header-gold-text);">Classe de Armadura</label>
                            <input id="ac" type="number" class="gothic-input text-center text-xl" value="10">
                        </div>
                    </div>
                    <div class="gothic-card p-4 space-y-4">
                        <h3 class="text-xl text-center" style="color: var(--header-gold-text);">Dados de Vida</h3>
                        <div class="grid grid-cols-3 gap-2 items-center">
                            <div>
                                <label class="block text-sm font-bold mb-1">Atual</label>
                                <input type="number" id="hit-dice-current" class="gothic-input text-center text-lg" value="1" min="0" oninput="debouncedUpdateHitDice()">
                            </div>
                            <div class="text-center text-xl font-bold">/</div>
                            <div>
                                <label class="block text-sm font-bold mb-1">Máx</label>
                                <input type="number" id="hit-dice-max" class="gothic-input text-center text-lg" value="1" min="0" oninput="debouncedUpdateHitDice()">
                            </div>
                        </div>
                        <div class="mt-2">
                            <label class="block text-sm font-bold mb-1">Tipo de Dado</label>
                            <select id="hit-dice-type" class="gothic-select text-base" onchange="debouncedUpdateHitDice()">
                                <option value="d6">d6</option>
                                <option value="d8" selected>d8</option>
                                <option value="d10">d10</option>
                                <option value="d12">d12</option>
                            </select>
                        </div>
                        <button class="gothic-btn w-full mt-3" onclick="openSpendHitDicePrompt()">Gastar Dados de Vida</button>
                        <p id="spend-hd-result" class="text-center text-sm mt-2 opacity-80"></p>

                        <h3 class="text-xl text-center mt-6" style="color: var(--header-gold-text);">Descansos</h3>
                        <div class="flex justify-around gap-4">
                            <button class="gothic-btn flex-1" onclick="takeShortRest()">Descanso Curto</button>
                            <button class="gothic-btn flex-1" onclick="takeLongRest()">Descanso Longo</button>
                        </div>
                        <p class="text-center text-sm opacity-80 mt-2">Descansos Curtos: <span id="short-rests-count">0</span> | Descansos Longos: <span id="long-rests-count">0</span></p>
                    </div>
                    
                    <div class="gothic-card p-4 space-y-4" id="proficienciesCard">
                        <div class="flex justify-between items-center mb-3 cursor-pointer" onclick="toggleSectionVisibility('proficiencies', !characterData.theme.sectionVisibility.proficiencies)">
                            <h3 class="text-xl" style="color: var(--header-gold-text);">Outras Proficiências</h3>
                            <i id="proficiencies-toggle-icon" data-lucide="chevron-down" class="w-6 h-6 transform transition-transform"></i>
                        </div>
                        <div id="proficiencies-content" class="space-y-4">
                            <div>
                                <label class="block text-sm font-bold mb-1">Armaduras</label>
                                <textarea id="prof-armors" class="gothic-textarea text-base h-16" placeholder="Ex: Armadura Leve, Média"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-1">Armas</label>
                                <textarea id="prof-weapons" class="gothic-textarea text-base h-16" placeholder="Ex: Simples, Marciais"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-1">Ferramentas</label>
                                <textarea id="prof-tools" class="gothic-textarea text-base h-16" placeholder="Ex: Ferramentas de Ladrão"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="gothic-card p-4 space-y-4">
                        <h3 class="text-xl text-center mt-6" style="color: var(--header-gold-text);">Sentidos Passivos</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="flex flex-col items-center gothic-card p-3">
                                <label class="block text-base">Percepção Passiva</label>
                                <span id="passive-perception" class="block text-2xl font-bold text-center" style="color: var(--header-gold-text);">0</span>
                            </div>
                            <div class="flex flex-col items-center gothic-card p-3">
                                <label class="block text-base">Investigação Passiva</label>
                                <span id="passive-investigation" class="block text-2xl font-bold text-center" style="color: var(--header-gold-text);">0</span>
                            </div>
                            <div class="col-span-full flex flex-col items-center gothic-card p-3">
                                <label class="block text-base">Intuição Passiva</label>
                                <span id="passive-insight" class="block text-2xl font-bold text-center" style="color: var(--header-gold-text);">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="combat-tab" class="tab-content space-y-6">
            <div class="gothic-card p-4 space-y-4" id="attacksCard">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xl" style="color: var(--header-gold-text);">Ataques e Habilidades</h3>
                    <button class="gothic-btn text-base" onclick="openAttackEditModal(null)">Adicionar Ataque</button>
                </div>
                <div id="attackList" class="space-y-3">
                </div>
            </div>
            <div class="gothic-card p-4 space-y-4" id="resourcesCard">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xl" style="color: var(--header-gold-text);">Recursos de Classe e Habilidades</h3>
                    <button class="gothic-btn text-base" onclick="openResourceEditModal(null)">Adicionar Recurso</button>
                </div>
                <div id="resourcesList" class="space-y-3">
                </div>
            </div>
            <div class="gothic-card p-4 space-y-4" id="conditionsCard">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xl" style="color: var(--header-gold-text);">Condições de Status</h3>
                    <button class="gothic-btn text-base" onclick="openConditionModal()">Gerenciar Condições</button>
                </div>
                <div id="activeConditionsList" class="space-y-3">
                </div>
            </div>
        </div>

        <div id="spellbook-tab" class="tab-content space-y-6">
            <div class="gothic-card p-6 flex flex-col">
                <div class="spell-modal-tabs">
                    <button class="spell-modal-tab-button active" data-tab-target="conjuration-tab-content">Conjuração</button>
                    <button class="spell-modal-tab-button" data-tab-target="spells-list-tab-content">Magias</button>
                </div>

                <div id="conjuration-tab-content" class="spell-modal-tab-content active space-y-4">
                    <h2 class="text-xl mb-3 text-center" style="color: var(--header-gold-text);">Estatísticas de Conjuração</h2>
                    <div class="flex items-center gap-3">
                        <label class="text-base flex-1 text-left">Atributo Chave:</label>
                        <select id="spellcasting-ability" class="gothic-select flex-2 text-base" oninput="collectDataFromUI(); updateAllCalculations();">
                            <option value="int">Inteligência</option>
                            <option value="wis">Sabedoria</option>
                            <option value="cha">Carisma</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-3">
                        <div>
                            <label class="block text-base" style="color: var(--header-gold-text);">CD da Magia</label>
                            <div id="spell-save-dc" class="text-4xl font-bold p-2">0</div>
                        </div>
                        <div>
                            <label class="block text-base" style="color: var(--header-gold-text);">Ataque de Magia</label>
                            <div id="spell-attack-bonus" class="text-4xl font-bold p-2">+0</div>
                        </div>
                    </div>
                </div>

                <div id="spells-list-tab-content" class="spell-modal-tab-content space-y-4">
                    <h2 class="text-3xl text-center mb-5" style="color: var(--header-gold-text);">Grimório</h2>
                    <div class="flex justify-between items-center mb-5">
                        <h3 class="text-xl" style="color: var(--header-gold-text);">Espaços de Magia</h3>
                        <button onclick="openSpellEditModal(null)" class="gothic-btn text-base">Criar Magia</button>
                    </div>
                    <div id="spellSlots" class="grid grid-cols-3 md:grid-cols-5 gap-5 mb-5 p-4 border border-border-gold rounded-lg"></div>
                    <div id="spellList" class="flex-grow overflow-y-auto space-y-5 pr-3"></div>
                </div>
            </div>
        </div>

        <div id="inventory-tab" class="tab-content space-y-6">
            <div class="gothic-card p-6 flex flex-col">
                <div class="flex justify-between items-center mb-5">
                    <h2 class="text-3xl text-center flex-grow" style="color: var(--header-gold-text);">Inventário</h2>
                    <div class="flex gap-3">
                        <button id="inventory-tab-equip" class="gothic-btn text-base !px-5" onclick="switchInventoryListTab('equip')">Equipamento</button>
                        <button id="inventory-tab-key" class="gothic-btn text-base !px-5 opacity-50" onclick="switchInventoryListTab('key')">Itens Chave</button>
                    </div>
                </div>
                <div class="text-right mb-4">
                    <button id="add-item-btn" onclick="openEditInventoryItemModal(null)" class="gothic-btn text-base">Adicionar Equipamento</button>
                </div>
                <div id="inventoryList" class="flex-grow overflow-y-auto space-y-5 pr-3 inventory-item-grid"></div>
            </div>

            <div class="gothic-card p-6 flex flex-col">
                <div id="currency-card"></div>
            </div>
        </div>

        <div id="history-tab" class="tab-content space-y-6">
            <div class="gothic-card p-4 space-y-4" id="personalityCard">
                <h3 class="text-xl text-center" style="color: var(--header-gold-text);">Personalidade e Antecedentes</h3>
                <div>
                    <label class="block text-sm font-bold mb-1">Traços de Personalidade</label>
                    <textarea id="personalityTraits" class="gothic-textarea text-base h-24" placeholder="Ex: Sou leal aos meus amigos, mas desconfiado de estranhos."></textarea>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">Ideais</label>
                    <textarea id="ideals" class="gothic-textarea text-base h-16" placeholder="Ex: A justiça deve prevalecer sobre tudo."></textarea>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">Defeitos</label>
                    <textarea id="flaws" class="gothic-textarea text-base h-16" placeholder="Ex: Tenho um temperamento explosivo e sou facilmente provocado."></textarea>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">História do Personagem</label>
                    <textarea id="characterHistory" class="gothic-textarea text-base h-32" placeholder="Descreva o passado do seu personagem."></textarea>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">Organizações/Facções</label>
                    <input type="text" id="organizations" class="gothic-input text-base" placeholder="Ex: Guilda dos Ladrões, Ordem dos Paladinos">
                </div>
            </div>
            
            <div class="gothic-card p-6 col-span-full">
                <h3 class="text-3xl font-bold mb-4 text-header-gold-text border-b-2 border-border-gold pb-2 text-center relative">
                    Vínculos e Ideais
                </h3>
                <div id="vinculos-ideais-content" class="text-text-primary text-base space-y-4">
                    <p class="mb-4">Vínculos representam as conexões do seu personagem com pessoas, lugares ou eventos. Eles podem ser fontes de força ou vulnerabilidade.</p>
                    <p class="mb-6">Preencha esta seção para dar profundidade à sua história e motivar suas escolhas em jogo.</p>

                    <button onclick="openVinculoModal(null)" class="w-full gothic-btn text-base flex items-center justify-center mb-6">
                        <i data-lucide="plus-circle" class="inline-block mr-2"></i>Adicionar Novo Vínculo
                    </button>

                    <div id="lista-vinculos" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        </div>
                </div>
            </div>
            <div class="gothic-card p-6 flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-3xl text-center flex-grow" style="color: var(--header-gold-text);">Diário de Bordo</h2>
                    <button class="gothic-btn text-base" onclick="openJournalEntryModal(null)"><i data-lucide="plus" class="w-4 h-4"></i> Adicionar Entrada</button>
                </div>
                <div id="journalEntriesList" class="flex-grow overflow-y-auto space-y-3 pr-3">
                    </div>
            </div>
        </div>

        <div id="tools-tab" class="tab-content space-y-6">
            <div class="gothic-card p-6 flex flex-col">
                <h2 class="text-xl text-center mb-3" style="color: var(--header-gold-text);">Rolador de Dados</h2>
                <div class="grid grid-cols-3 gap-3 mb-3">
                    <button class="gothic-btn text-base" onclick="selectDie(4)">D4</button>
                    <button class="gothic-btn text-base" onclick="selectDie(6)">D6</button>
                    <button class="gothic-btn text-base" onclick="selectDie(8)">D8</button>
                    <button class="gothic-btn text-base" onclick="selectDie(10)">D10</button>
                    <button class="gothic-btn text-base" onclick="selectDie(12)">D12</button>
                    <button class="gothic-btn text-base" onclick="selectDie(20)">D20</button>
                </div>
                <div class="flex items-center gap-3 mb-3">
                    <input id="diceQty" type="number" class="gothic-input w-1/3 text-center text-lg" value="1">
                    <span id="diceType" class="text-2xl font-bold w-1/3 text-center">D20</span>
                    <input id="diceMod" type="number" class="gothic-input w-1/3 text-center text-lg" value="0">
                </div>
                <div class="text-center mb-3">
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="addProficiencyToRoll" class="h-5 w-5 mr-2" style="accent-color: var(--gold-glow);">
                        <span class="text-base">Adicionar Proficiência?</span>
                    </label>
                </div>
                <button class="gothic-btn w-full text-lg" onclick="rollDice()"><i data-lucide="dice-5" class="w-6 h-6"></i>Rolar</button>
                <div class="mt-3 text-center">
                    <p class="text-lg">Resultado: <span id="rollResult" class="text-3xl font-bold" style="color: var(--header-gold-text);">0</span></p>
                    <p class="text-sm opacity-75">Detalhes: <span id="rollDetail"></span></p>
                </div>
                <div class="mt-3 border-t border-yellow-800 pt-3">
                    <h3 class="text-center text-base">Histórico</h3>
                    <div id="rollHistory" class="text-sm text-center h-48 overflow-y-auto space-y-1 p-2"></div>
                </div>
            </div>

            <div id="musicPlayerCard" class="gothic-card p-6">
                <h2 class="text-2xl text-center mb-4" style="color: var(--header-gold-text);">Tocador de Músicas</h2>
                <div id="localMusicTab" class="music-player-tab-content active">
                    <input type="file" id="localMusicInput" accept="audio/*" multiple>
                    <div id="localMusicDropArea" class="mt-4">
                        Arraste e solte arquivos de audio aqui ou clique para selecionar.
                    </div>
                    <ul id="localPlaylist" class="mt-4"></ul>
                    <div id="musicControls">
                        <button onclick="prevTrack()"><i data-lucide="skip-back" class="w-6 h-6"></i></button>
                        <button onclick="togglePlayPause()"><i id="playPauseIcon" data-lucide="play" class="w-8 h-8"></i></button>
                        <button onclick="nextTrack()"><i data-lucide="skip-forward" class="w-6 h-6"></i></button>
                        <input type="range" id="volumeControl" min="0" max="1" step="0.01" value="1" oninput="setVolume(this.value)">
                    </div>
                    <audio id="backgroundMusicPlayer" preload="auto"></audio>
                </div>
            </div>
        </div>

        <div id="global-quick-access-container" class="gothic-card fixed bottom-4 left-1/2 -translate-x-1/2 z-30 w-[95%] max-w-[500px]">
            <button id="quick-access-toggle-btn" class="gothic-btn !p-2 !w-10 !h-10 absolute top-0 left-1/2 -translate-x-1/2 z-31" onclick="toggleQuickAccessBar()">
                <i data-lucide="chevron-up" class="w-6 h-6"></i>
            </button>
            
            <div id="quick-access-content-wrapper" class="w-full transition-all duration-300 ease-in-out overflow-hidden" style="max-height: 200px;"> 
                <div class="quick-access-content flex justify-around items-center py-2 px-4">
                    <div class="action-button-group">
                        <button class="gothic-btn !p-4" onclick="switchTab('character-tab')"><i data-lucide="user" class="w-6 h-6"></i></button>
                        <span class="action-button-name">Personagem</span>
                    </div>
                    <div class="action-button-group">
                        <button class="gothic-btn !p-4" onclick="switchTab('combat-tab')"><i data-lucide="swords" class="w-6 h-6"></i></button>
                        <span class="action-button-name">Combate</span>
                    </div>
                    <div class="action-button-group">
                        <button class="gothic-btn !p-4" onclick="switchTab('spellbook-tab')"><i data-lucide="book-open" class="w-6 h-6"></i></button>
                        <span class="action-button-name">Grimório</span>
                    </div>
                    <div class="action-button-group">
                        <button class="gothic-btn !p-4" onclick="switchTab('inventory-tab')"><i data-lucide="backpack" class="w-6 h-6"></i></button>
                        <span class="action-button-name">Inventário</span>
                    </div>
                    <div class="action-button-group">
                        <button class="gothic-btn !p-4" onclick="switchTab('history-tab')"><i data-lucide="book" class="w-6 h-6"></i></button>
                        <span class="action-button-name">História</span>
                    </div>
                    <div class="action-button-group">
                        <button class="gothic-btn !p-4" onclick="switchTab('tools-tab')"><i data-lucide="wrench" class="w-6 h-6"></i></button>
                        <span class="action-button-name">Ferramentas</span>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content gothic-card p-6 flex flex-col">
            <h2 class="text-3xl text-center mb-5" style="color: var(--header-gold-text);">Configurações de Aparência</h2>
            <div class="space-y-5 overflow-y-auto pr-3">
                <h3 class="text-xl text-center mb-4" style="color: var(--header-gold-text);">Modo de Tema</h3>
                <div class="flex justify-center items-center gap-4 mb-4">
                    <span class="text-lg">Radiante</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="themeModeSwitch" class="sr-only peer" onchange="toggleThemeMode(this.checked)">
                        <div class="w-11 h-6 bg-yellow-500 rounded-full peer peer-focus:ring-4 peer-focus:ring-yellow-300 dark:peer-focus:ring-cyan-800 dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-cyan-500"></div>
                    </label>
                    <span class="text-lg">Necrótico</span>
                </div>

                <h3 class="text-xl text-center mb-4" style="color: var(--header-gold-text);">Brilho Etéreo (Chamas)</h3>
                <label class="inline-flex items-center cursor-pointer mb-4">
                    <input type="checkbox" id="toggleFlameGlow" class="h-5 w-5 mr-2" style="accent-color: var(--gold-glow);" onchange="toggleFlameGlow(this.checked)">
                    <span class="text-base">Ativar/Desativar Brilho Etéreo</span>
                </label>
                <div id="flame-color-pickers" class="color-picker-grid">
                </div>
                
                <h3 class="text-xl text-center mt-5" style="color: var(--header-gold-text);">Cores do Tema</h3>
                <div id="color-pickers" class="color-picker-grid"></div>

                <h3 class="text-xl text-center mt-5" style="color: var(--header-gold-text);">Plano de Fundo</h3>
                <button class="gothic-btn w-full text-lg" onclick="document.getElementById('wallpaperUpload').click()">
                    <i data-lucide="image-up" class="w-6 h-6"></i>Carregar Novo Papel de Parede
                </button>

                <h3 class="text-xl text-center mt-5" style="color: var(--header-gold-text);">Layout da Ficha</h3>
                <div class="space-y-2">
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="toggle-section-attacks" class="h-5 w-5 mr-2" style="accent-color: var(--gold-glow);" onchange="toggleSectionVisibility('attacks', this.checked)">
                        <span class="text-base">Seção de Ataques</span>
                    </label>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="toggle-section-resources" class="h-5 w-5 mr-2" style="accent-color: var(--gold-glow);" onchange="toggleSectionVisibility('resources', this.checked)">
                        <span class="text-base">Seção de Recursos</span>
                    </label>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="toggle-section-conditions" class="h-5 w-5 mr-2" style="accent-color: var(--gold-glow);" onchange="toggleSectionVisibility('conditions', this.checked)">
                        <span class="text-base">Seção de Condições</span>
                    </label>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="toggle-section-personality" class="h-5 w-5 mr-2" style="accent-color: var(--gold-glow);" onchange="toggleSectionVisibility('personality', this.checked)">
                        <span class="text-base">Seção de Personalidade</span>
                    </label>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="toggle-section-musicPlayer" class="h-5 w-5 mr-2" style="accent-color: var(--gold-glow);" onchange="toggleSectionVisibility('musicPlayer', this.checked)">
                        <span class="text-base">Tocador de Músicas</span>
                    </label>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="toggle-section-proficiencies" class="h-5 w-5 mr-2" style="accent-color: var(--gold-glow);" onchange="toggleSectionVisibility('proficiencies', this.checked)">
                        <span class="text-base">Seção de Proficiências</span>
                    </label>
                </div>
                <h3 class="text-xl text-center mt-5" style="color: var(--header-gold-text);">Gerenciamento de Dados</h3>
                <div class="space-y-2">
                    <button class="gothic-btn w-full text-lg" onclick="exportAllData()"><i data-lucide="download" class="w-6 h-6"></i>Exportar Ficha</button>
                    <button class="gothic-btn w-full text-lg" onclick="document.getElementById('importFileInput').click()"><i data-lucide="upload" class="w-6 h-6"></i>Importar Ficha</button>
                </div>
            </div>
            <button class="gothic-btn mt-8 self-center text-lg" onclick="closeModal('settingsModal')">Fechar</button>
        </div>
    </div>

    <div id="attributeEditModal" class="modal">
        <div class="modal-content !max-w-md gothic-card p-6 flex flex-col">
            <h2 id="attribute-modal-title" class="text-3xl text-center mb-5" style="color: var(--header-gold-text);">Editar Atributo</h2>
            <div class="flex-grow flex flex-col items-center justify-center space-y-5">
                <label class="text-lg">Valor Base do Atributo</label>
                <div class="flex items-center gap-3">
                    <button class="gothic-btn !p-2" onclick="adjustAttributeScore(-1)"><i data-lucide="minus" class="w-5 h-5"></i></button>
                    <input id="attribute-modal-input" type="number" class="gothic-input text-5xl text-center h-24 w-32">
                    <button class="gothic-btn !p-2" onclick="adjustAttributeScore(1)"><i data-lucide="plus" class="w-5 h-5"></i></button>
                </div>
                <p class="text-lg" style="color: var(--header-gold-text);">Modificador: <span id="attribute-modal-modifier" class="font-bold text-2xl"></span></p>
            </div>
            <div class="flex justify-end gap-5 mt-5">
                <button class="gothic-btn text-lg" onclick="closeModal('attributeEditModal')">Fechar</button>
            </div>
        </div>
    </div>

    <div id="spellEditModal" class="modal">
        <div class="modal-content gothic-card p-6 flex flex-col">
            <h2 id="spell-modal-title" class="text-3xl text-center mb-5" style="color: var(--header-gold-text);">Criar Magia</h2>
            <div class="flex-grow overflow-y-auto pr-3 space-y-4">
                <div>
                    <label class="block text-sm font-bold mb-1">Nome da Magia</label>
                    <input type="text" id="spell-name-input" class="gothic-input text-base" placeholder="Nome da Magia">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold mb-1">Nível</label>
                        <input type="number" id="spell-level-input" class="gothic-input text-base" value="0" min="0" max="9">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1">Tempo de Conjuração</label>
                        <input type="text" id="spell-casting-time-input" class="gothic-input text-base" placeholder="1 Ação">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold mb-1">Alcance</label>
                        <input type="text" id="spell-range-input" class="gothic-input text-base" placeholder="18m">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1">Duração</label>
                        <input type="text" id="spell-duration-input" class="gothic-input text-base" placeholder="1 Minuto">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-2">Componentes</label>
                    <div class="flex items-center gap-4">
                        <label class="inline-flex items-center cursor-pointer"><input type="checkbox" id="comp-v" class="h-5 w-5 mr-2" style="accent-color: var(--gold-glow);">V</label>
                        <label class="inline-flex items-center cursor-pointer"><input type="checkbox" id="comp-s" class="h-5 w-5 mr-2" style="accent-color: var(--gold-glow);">S</label>
                        <label class="inline-flex items-center cursor-pointer"><input type="checkbox" id="comp-m" class="h-5 w-5 mr-2" style="accent-color: var(--gold-glow);">M</label>
                        <input type="text" id="spell-material-desc-input" class="gothic-input text-sm flex-grow" placeholder="Descrição Material (Opcional)">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">Descrição</label>
                    <textarea id="spell-description-input" class="gothic-textarea text-base h-32" placeholder="Descreva os efeitos da magia"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">Imagem da Magia (Opcional)</label>
                    <input type="file" id="spell-image-upload" class="hidden" accept="image/*">
                    <button class="gothic-btn w-full text-base" onclick="document.getElementById('spell-image-upload').click()">Carregar Imagem</button>
                </div>
            </div>
            <div class="flex justify-end gap-5 mt-5">
                <button class="gothic-btn text-lg" onclick="closeModal('spellEditModal')">Cancelar</button>
                <button class="gothic-btn text-lg" onclick="saveSpell()">Salvar Magia</button>
            </div>
        </div>
    </div>

    <div id="itemDetailModal" class="modal">
        <div class="modal-content !max-w-lg gothic-card p-6 flex flex-col">
            <h2 id="item-detail-name" class="text-3xl text-center mb-4" style="color: var(--header-gold-text);">Nome do Item</h2>
            <div class="flex-grow overflow-y-auto pr-3 space-y-4">
                <div class="flex flex-col items-center mb-4">
                    <img id="item-detail-image" src="" class="w-32 h-32 object-cover rounded-lg border-2 border-border-gold mb-2">
                </div>
                <div class="grid grid-cols-2 gap-3 text-base">
                    <div><span class="font-bold">Quantidade:</span> <span id="item-detail-qty"></span></div>
                    <div><span class="font-bold">Tipo:</span> <span id="item-detail-type"></span></div>
                    <div><span class="font-bold">Raridade:</span> <span id="item-detail-rarity"></span></div>
                    <div id="item-detail-damage-row" class="col-span-2 hidden"><span class="font-bold">Dano:</span> <span id="item-detail-damage"></span></div>
                    <div id="item-detail-vinculo-row" class="col-span-2 hidden"><span class="font-bold">Vínculo:</span> <span id="item-detail-vinculo"></span></div>
                </div>
                <div class="mt-4">
                    <p class="font-bold text-lg mb-2" style="color: var(--header-gold-text);">Notas:</p>
                    <p id="item-detail-notes" class="text-sm p-3"></p> </div>
                <div class="mt-4">
                    <p class="font-bold text-lg mb-2" style="color: var(--header-gold-text);">Bônus:</p>
                    <div id="item-detail-bonuses" class="text-sm space-y-1">
                        </div>
                    <p id="no-bonuses-message" class="text-sm opacity-70 italic hidden">Nenhum bônus para este item.</p>
                </div>
            </div>
            <div class="flex justify-end gap-5 mt-5">
                <button class="gothic-btn text-lg" onclick="openEditInventoryItemModal(currentDetailItemId)">Editar</button>
                <button class="gothic-btn text-lg" onclick="closeModal('itemDetailModal')">Fechar</button>
            </div>
        </div>
    </div>

    <div id="editInventoryItemModal" class="modal">
        <div class="modal-content gothic-card p-6 flex flex-col">
            <h2 id="edit-item-modal-title" class="text-3xl text-center mb-5" style="color: var(--header-gold-text);">Editar Item</h2>
            <div class="flex-grow overflow-y-auto pr-3 space-y-4">
                <div class="flex flex-col items-center justify-center space-y-2">
                    <img id="edit-item-image" src="https://placehold.co/192x192/000000/ffd700?text=?" class="w-24 h-24 object-cover rounded-lg border-2 border-border-gold">
                    <input type="file" id="edit-item-upload" class="hidden" accept="image/*">
                    <button class="gothic-btn text-xs py-1 px-2" onclick="document.getElementById('edit-item-upload').click()">Alterar Imagem</button>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">Nome do Item</label>
                    <input type="text" id="edit-item-name" class="gothic-input text-base" placeholder="Nome do Item">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold mb-1">Quantidade</label>
                        <div class="flex items-center gap-2">
                            <input type="number" id="edit-item-qty" class="gothic-input text-base flex-grow" value="1" min="1">
                            <label class="inline-flex items-center cursor-pointer text-sm">
                                <input type="checkbox" id="edit-item-is-single" class="h-4 w-4 mr-1" style="accent-color: var(--gold-glow);" onchange="toggleItemIsSingle(this.checked)">
                                Único
                            </label>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1">Tipo</label>
                        <select id="edit-item-type" class="gothic-select text-base" onchange="toggleEditItemDamageField()">
                            <option value="outro">Outro</option>
                            <option value="arma">Arma</option>
                            <option value="armadura">Armadura</option>
                            <option value="magico">Item Mágico</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">Raridade</label>
                    <select id="edit-item-rarity" class="gothic-select text-base">
                        <option value="comum">Comum</option>
                        <option value="incomum">Incomum</option>
                        <option value="raro">Raro</option>
                        <option value="muito raro">Muito Raro</option>
                        <option value="lendario">Lendário</option>
                        <option value="artefato">Artefato</option>
                    </select>
                </div>
                <div id="edit-item-damage-container" class="hidden">
                    <label class="block text-sm font-bold mb-1">Dano</label>
                    <input type="text" id="edit-item-damage" class="gothic-input text-base" placeholder="Dano (ex: 1d8 + MOD)">
                </div>
                <div id="edit-item-vinculo-container">
                    <label class="block text-sm font-bold mb-1">Vincular a Vínculo (Itens Chave)</label>
                    <select id="edit-item-linked-vinculo" class="gothic-select text-base">
                        <option value="">Nenhum</option>
                        </select>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">Notas</label>
                    <textarea id="edit-item-notes" class="gothic-textarea text-base h-24" placeholder="Notas sobre o item..."></textarea>
                </div>
                <div class="mt-4">
                    <h4 class="text-lg font-bold mb-2" style="color: var(--header-gold-text);">Bônus do Item:</h4>
                    <div id="edit-item-bonuses-list" class="text-sm space-y-2 mb-3">
                        </div>
                    <button class="gothic-btn text-base w-full" onclick="openItemBonusModal(currentEditingItemId)">Adicionar Novo Bônus</button>
                </div>
            </div>
            <div class="flex justify-end gap-5 mt-5">
                <button class="gothic-btn text-lg" onclick="closeModal('editInventoryItemModal')">Cancelar</button>
                <button class="gothic-btn text-lg" onclick="saveInventoryItem()">Salvar Item</button>
            </div>
        </div>
    </div>


    <div id="currencyModal" class="modal">
        <div class="modal-content !max-w-md gothic-card p-6 flex flex-col">
            <div id="currency-card"></div>
            <button class="gothic-btn mt-6 self-center text-lg" onclick="closeModal('currencyModal')">Fechar</button>
        </div>
    </div>

    <div id="vinculo-editor-modal" class="modal">
        <div class="modal-content gothic-card p-6 flex flex-col">
            <h2 id="vinculo-modal-title" class="text-3xl text-center mb-5" style="color: var(--header-gold-text);">Adicionar Vínculo</h2>
            <div class="flex-grow overflow-y-auto pr-3 space-y-4">
                <div class="mb-4 flex flex-col items-center">
                    <label class="block text-text-primary text-sm font-bold mb-2">Imagem do Vínculo:</label>
                    <img id="vinculo-imagem-preview" src="" alt="Pré-visualização da imagem do vínculo" class="w-32 h-32 rounded-full object-cover border-2 border-border-gold mb-2" style="display: none;">
                    <input type="file" id="vinculo-imagem-input" accept="image/*" class="hidden">
                    <label for="vinculo-imagem-input" class="cursor-pointer gothic-btn text-xs py-1 px-2">
                        Selecionar Imagem
                    </label>
                </div>

                <div>
                    <label for="vinculo-nome" class="block text-sm font-bold mb-1">Nome do Vínculo:</label>
                    <input type="text" id="vinculo-nome" class="gothic-input text-base" placeholder="Nome do Personagem/NPC">
                </div>

                <div>
                    <label for="vinculo-tipo" class="block text-sm font-bold mb-1">Tipo (Positivo/Negativo):</label>
                    <input type="text" id="vinculo-tipo" class="gothic-input text-base" placeholder="Ex: Amigo, Rival, Mentor">
                </div>

                <div>
                    <label for="vinculo-descricao" class="block text-sm font-bold mb-1">Descrição do Vínculo:</label>
                    <textarea id="vinculo-descricao" rows="5" class="gothic-textarea text-base h-24" placeholder="Descreva como o vínculo afeta o personagem..."></textarea>
                </div>
            </div>
            <div class="flex justify-end gap-5 mt-5">
                <button class="gothic-btn text-lg" onclick="closeModal('vinculo-editor-modal')">Cancelar</button>
                <button class="gothic-btn text-lg" onclick="saveVinculo()">Salvar Vínculo</button>
            </div>
        </div>
    </div>


    <div id="journalEntryModal" class="modal">
        <div class="modal-content gothic-card p-6 flex flex-col">
            <h2 id="journal-entry-modal-title" class="text-3xl text-center mb-5" style="color: var(--header-gold-text);">Nova Entrada de Diário</h2>
            <div class="flex-grow overflow-y-auto pr-3 space-y-4">
                <div>
                    <label class="block text-sm font-bold mb-1">Data</label>
                    <input type="date" id="journal-entry-date" class="gothic-input text-base">
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">Título</label>
                    <input type="text" id="journal-entry-title" class="gothic-input text-base" placeholder="Título da entrada...">
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">Conteúdo</label>
                    <textarea id="journal-entry-content" class="gothic-textarea text-base h-48" placeholder="O que aconteceu hoje?"></textarea>
                </div>
            </div>
            <div class="flex justify-end gap-5 mt-5">
                <button class="gothic-btn text-lg" onclick="closeModal('journalEntryModal')">Cancelar</button>
                <button class="gothic-btn text-lg" onclick="saveJournalEntry()">Salvar Entrada</button>
            </div>
        </div>
    </div>


    <div id="diceRollerModal" class="modal">
        <div class="modal-content !max-w-md gothic-card p-6 flex flex-col">
            <h2 class="text-xl text-center mb-3" style="color: var(--header-gold-text);">Rolador de Dados</h2>
            <div class="grid grid-cols-3 gap-3 mb-3">
                <button class="gothic-btn text-base" onclick="selectDie(4)">D4</button>
                <button class="gothic-btn text-base" onclick="selectDie(6)">D6</button>
                <button class="gothic-btn text-base" onclick="selectDie(8)">D8</button>
                <button class="gothic-btn text-base" onclick="selectDie(10)">D10</button>
                <button class="gothic-btn text-base" onclick="selectDie(12)">D12</button>
                <button class="gothic-btn text-base" onclick="selectDie(20)">D20</button>
            </div>
            <div class="flex items-center gap-3 mb-3">
                <input id="diceQty" type="number" class="gothic-input w-1/3 text-center text-lg" value="1">
                <span id="diceType" class="text-2xl font-bold w-1/3 text-center">D20</span>
                <input id="diceMod" type="number" class="gothic-input w-1/3 text-center text-lg" value="0">
            </div>
            <div class="text-center mb-3">
                <label class="inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="addProficiencyToRoll" class="h-5 w-5 mr-2" style="accent-color: var(--gold-glow);">
                    <span class="text-base">Adicionar Proficiência?</span>
                </label>
            </div>
            <button class="gothic-btn w-full text-lg" onclick="rollDice()"><i data-lucide="dice-5" class="w-6 h-6"></i>Rolar</button>
            <div class="mt-3 text-center">
                <p class="text-lg">Resultado: <span id="rollResult" class="text-3xl font-bold" style="color: var(--header-gold-text);">0</span></p>
                <p class="text-sm opacity-75">Detalhes: <span id="rollDetail"></span></p>
            </div>
            <div class="mt-3 border-t border-yellow-800 pt-3">
                <h3 class="text-center text-base">Histórico</h3>
                <div id="rollHistory" class="text-sm text-center h-48 overflow-y-auto space-y-1 p-2"></div>
            </div>
            <button class="gothic-btn mt-6 self-center text-lg" onclick="closeModal('diceRollerModal')">Fechar</button>
        </div>
    </div>


    <div id="itemBonusModal" class="modal">
        <div class="modal-content !max-w-md gothic-card p-6 flex flex-col">
            <h2 class="text-3xl text-center mb-5" style="color: var(--header-gold-text);">Adicionar Bônus de Item</h2>
            <div class="space-y-4">
                <select id="bonus-type-select" class="gothic-select text-base" onchange="updateBonusTarget()">
                    <option value="attribute">Atributo</option>
                    <option value="skill">Perícia</option>
                    <option value="savingThrow">Teste de Resistência</option>
                    <option value="spellSaveDc">CD de Magia</option>
                    <option value="spellAttackBonus">Ataque de Magia</option>
                    <option value="ac">Classe de Armadura</option>
                    <option value="maxHp">HP Máximo</option>
                </select>
                <select id="bonus-target-select" class="gothic-select text-base"></select>
                <input id="bonus-value-input" type="number" class="gothic-input text-base" placeholder="Valor do Bônus (ex: 2 ou -1)">
            </div>
            <div class="flex justify-end gap-5 mt-5">
                <button class="gothic-btn text-lg" onclick="closeModal('itemBonusModal')">Cancelar</button>
                <button class="gothic-btn text-lg" onclick="saveItemBonus()">Salvar Bônus</button>
            </div>
        </div>
    </div>

    <div id="imageViewerModal" class="modal">
        <div class="modal-content">
            <img id="imageViewerImage" src="" alt="Imagem Ampliada">
            <button class="gothic-btn absolute top-4 right-4 !p-2" onclick="closeModal('imageViewerModal')">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
    </div>

    <div id="attackEditModal" class="modal">
        <div class="modal-content !max-w-lg gothic-card p-6 flex flex-col">
            <h2 id="attack-modal-title" class="text-3xl text-center mb-5" style="color: var(--header-gold-text);">Adicionar Ataque</h2>
            <div class="flex-grow overflow-y-auto pr-3 space-y-4">
                <div>
                    <label class="block text-sm font-bold mb-1">Nome do Ataque</label>
                    <input type="text" id="attack-name-input" class="gothic-input text-base" placeholder="Ex: Espada Longa, Raio de Fogo">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold mb-1">Bônus de Ataque</label>
                        <input type="text" id="attack-bonus-input" class="gothic-input text-base" placeholder="Ex: +5, +FOR, +DEST + PROF">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1">Dano</label>
                        <input type="text" id="attack-damage-input" class="gothic-input text-base" placeholder="Ex: 1d8 + 3 Perfurante">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">Tipo de Ataque</label>
                    <select id="attack-type-input" class="gothic-select text-base">
                        <option value="arma corpo a corpo">Arma Corpo a Corpo</option>
                        <option value="arma a distancia">Arma à Distância</option>
                        <option value="magia">Magia</option>
                        <option value="desarmado">Desarmado</option>
                        <option value="habilidade">Habilidade</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">Notas/Propriedades Especiais</label>
                    <textarea id="attack-notes-input" class="gothic-textarea text-base h-24" placeholder="Ex: Versátil (1d10), Duas Mãos"></textarea>
                </div>
            </div>
            <div class="flex justify-end gap-5 mt-5">
                <button class="gothic-btn text-lg" onclick="closeModal('attackEditModal')">Cancelar</button>
                <button class="gothic-btn text-lg" onclick="saveAttack()">Salvar Ataque</button>
            </div>
        </div>
    </div>

    <div id="spendHitDiceModal" class="modal">
        <div class="modal-content !max-w-sm gothic-card p-6 flex flex-col">
            <h2 class="text-3xl text-center mb-5" style="color: var(--header-gold-text);">Gastar Dados de Vida</h2>
            <div class="space-y-4">
                <p class="text-center">Dados de Vida Disponíveis: <span id="available-hd-count" class="font-bold">0</span> (<span id="hd-type-display">d8</span>)</p>
                <div>
                    <label class="block text-sm font-bold mb-1">Quantos Dados de Vida Gastar?</label>
                    <input type="number" id="num-hd-to-spend" class="gothic-input text-center text-xl" value="1" min="1">
                </div>
                <p id="hd-roll-result" class="text-center text-lg mt-2 font-bold" style="color: var(--success-text);"></p>
            </div>
            <div class="flex justify-end gap-5 mt-5">
                <button class="gothic-btn text-lg" onclick="closeModal('spendHitDiceModal')">Cancelar</button>
                <button class="gothic-btn text-lg" onclick="performSpendHitDice()">Gastar!</button>
            </div>
        </div>
    </div>

    <div id="resourceEditModal" class="modal">
        <div class="modal-content !max-w-lg gothic-card p-6 flex flex-col">
            <h2 id="resource-modal-title" class="text-3xl text-center mb-5" style="color: var(--header-gold-text);">Adicionar Recurso</h2>
            <div class="flex-grow overflow-y-auto pr-3 space-y-4">
                <div>
                    <label class="block text-sm font-bold mb-1">Nome do Recurso/Habilidade</label>
                    <input type="text" id="resource-name-input" class="gothic-input text-base" placeholder="Ex: Fúria, Rajada Mística">
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">Descrição</label>
                    <textarea id="resource-description-input" class="gothic-textarea text-base h-24" placeholder="Descreva o efeito e como funciona..."></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold mb-1">Tipo</label>
                        <select id="resource-type-input" class="gothic-select text-base">
                            <option value="class-feature">Característica de Classe</option>
                            <option value="racial-trait">Traço Racial</option>
                            <option value="feat">Talento</option>
                            <option value="other">Outro</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1">Redefine em</label>
                        <select id="resource-reset-input" class="gothic-select text-base" onchange="toggleResourceUses()">
                            <option value="at-will">À Vontade (At-Will)</option>
                            <option value="short-rest">Descanso Curto</option>
                            <option value="long-rest">Descanso Longo</option>
                            <option value="once-per-day">Uma Vez por Dia</option>
                            <option value="other">Outro</option>
                        </select>
                    </div>
                </div>
                <div id="resource-uses-container" class="grid grid-cols-2 gap-4 hidden">
                    <div>
                        <label class="block text-sm font-bold mb-1">Usos Atuais</label>
                        <input type="number" id="resource-uses-current-input" class="gothic-input text-base" value="0" min="0">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1">Usos Máximos</label>
                        <input type="number" id="resource-uses-max-input" class="gothic-input text-base" value="0" min="0">
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-5 mt-5">
                <button class="gothic-btn text-lg" onclick="closeModal('resourceEditModal')">Cancelar</button>
                <button class="gothic-btn text-lg" onclick="saveResource()">Salvar Recurso</button>
            </div>
        </div>
    </div>

    <div id="conditionModal" class="modal">
        <div class="modal-content !max-w-md gothic-card p-6 flex flex-col">
            <h2 class="text-3xl text-center mb-5" style="color: var(--header-gold-text);">Gerenciar Condições</h2>
            <div id="allConditionsList" class="flex-grow overflow-y-auto pr-3 space-y-3">
                </div>
            <button class="gothic-btn mt-6 self-center text-lg" onclick="closeModal('conditionModal')">Fechar</button>
        </div>
    </div>

    <div id="nowPlayingPopup"></div>
    <div id="messagePopup" class="message-popup"></div>
<script>
    // --- FUNÇÃO DE DEBOUNCE ---
    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), delay);
        };
    }

    // --- ESTRUTURA DE DADOS E VALORES PADRÃO ---
    let characterData = {};
    let currentItemBonusId = null;
    let currentEditingItemId = null;
    let currentDetailItemId = null;
    let currentEditingAttackIndex = null;
    let currentEditingResourceIndex = null;
    let currentEditingJournalEntryId = null;
    let currentEditingVinculoId = null;
    let currentInventoryListTab = 'equip';
    let tempSpellImage = null;
    let tempEditItemImage = null;
    let tempVinculoImage = null;

    let audioPlayer = new Audio();
    let currentTrackIndex = -1;
    let localPlaylist = [];
    let nowPlayingTimeout;
    let messageTimeout;

    const defaultImagePlaceholder = "https://placehold.co/192x192/000000/ffd700?text=?";
    const ATTRIBUTES = [
        { id: 'str', name: 'Força', abbr: 'FOR' },
        { id: 'dex', name: 'Destreza', abbr: 'DES' },
        { id: 'con', name: 'Constituição', abbr: 'CON' },
        { id: 'int', name: 'Inteligência', abbr: 'INT' },
        { id: 'wis', name: 'Sabedoria', abbr: 'SAB' },
        { id: 'cha', name: 'Carisma', abbr: 'CAR' }
    ];
    const SKILLS = [
        { name: 'Acrobacia', attr: 'dex', passive: false },
        { name: 'Arcanismo', attr: 'int', passive: false },
        { name: 'Atletismo', attr: 'str', passive: false },
        { name: 'Atuação', attr: 'cha', passive: false },
        { name: 'Enganação', attr: 'cha', passive: false },
        { name: 'Furtividade', attr: 'dex', passive: false },
        { name: 'História', attr: 'int', passive: false },
        { name: 'Intimidação', attr: 'cha', passive: false },
        { name: 'Intuição', attr: 'wis', passive: true, slug: 'insight' },
        { name: 'Investigação', attr: 'int', passive: true, slug: 'investigation' },
        { name: 'Lidar com Animais', attr: 'wis', passive: false },
        { name: 'Medicina', attr: 'wis', passive: false },
        { name: 'Natureza', attr: 'int', passive: false },
        { name: 'Percepção', attr: 'wis', passive: true, slug: 'perception' },
        { name: 'Persuasão', attr: 'cha', passive: false },
        { name: 'Prestidigitação', attr: 'dex', passive: false },
        { name: 'Religião', attr: 'int', passive: false },
        { name: 'Sobrevivência', attr: 'wis', passive: false }
    ];
    const CONDITIONS = [
        { name: 'Amedrontado', description: 'Desvantagem em testes de habilidade e ataques, não pode se aproximar da fonte do medo.' },
        { name: 'Cego', description: 'O alvo não pode ver e falha automaticamente em qualquer teste de característica que exija visão. Ataques contra o alvo têm vantagem, e os ataques do alvo têm desvantagem.' },
        { name: 'Enfeitiçado', description: 'Não pode atacar o enfeitiçador, e o enfeitiçador tem vantagem em qualquer teste de característica para interagir socialmente com o alvo.' },
        { name: 'Exausto (Nível 1)', description: 'Desvantagem em testes de característica.' },
        { name: 'Exausto (Nível 2)', description: 'Velocidade reduzida pela metade.' },
        { name: 'Exausto (Nível 3)', description: 'Desvantagem em testes de ataque e testes de resistência.' },
        { name: 'Exausto (Nível 4)', description: 'PV máximos reduzidos pela metade.' },
        { name: 'Exausto (Nível 5)', description: 'Velocidade de movimento 0.' },
        { name: 'Exausto (Nível 6)', description: 'Morte.' },
        { name: 'Envenenado', description: 'Desvantagem em testes de ataque e habilidades.' },
        { name: 'Incapacitado', description: 'Não pode realizar ações ou reações, deslocamento é zero.' },
        { name: 'Invisível', description: 'Ataques têm vantagem e defensores têm desvantagem, mas ainda pode ser detectado de outras formas (Ex: por ruídos ou rastros).' },
        { name: 'Paralisado', description: 'Incapacitado, não pode se mover ou falar, desvantagem em salvaguardas de Força e Destreza, ataques contra o alvo têm vantagem e são acertos críticos se a 1.5m.' },
        { name: 'Petrificado', description: 'Transformado em pedra, incapacitado e com deslocamento zero, resistente a todos os danos, exceto àqueles que podem afetar pedra. Imune a veneno e doença. Não se cura naturalmente ou magicamente.' },
        { name: 'Surdo', description: 'Falha automática em testes de percepção baseados em audição.' },
        { name: 'Caído', description: 'A única ação que um alvo caído pode realizar é se levantar, o que consome metade de seu movimento. Ataques à distância contra o alvo têm desvantagem. Ataques corpo a corpo contra o alvo têm vantagem.' },
        { name: 'Agarrado', description: 'Deslocamento é zero. A condição termina se o agarrador estiver incapacitado ou se o alvo estiver fora do alcance do agarrador.' },
        { name: 'Impedido', description: 'Deslocamento é zero.' },
        { name: 'Inconsciente', description: 'Incapacitado e caído, deslocamento é zero, não pode ser afetado por reações. Ataques contra o alvo têm vantagem e são acertos críticos se o atacante estiver a até 1,5 metro do alvo.' },
        { name: 'Amordaçado', description: 'O alvo não pode falar ou fornecer componentes verbais de magias.' },
        { name: 'Contido', description: 'A velocidade do alvo se torna 0 e não pode se beneficiar de qualquer bônus em sua velocidade. Desvantagem em testes de ataque e testes de Destreza. Ataques contra o alvo têm vantagem.' },
        { name: 'Atordoado', description: 'Um alvo atordoado está incapacitado, não pode se mover e só pode falar de forma limitada. O alvo falha automaticamente em testes de resistência de Força e Destreza.' }
    ];

    const portugueseAttr = {str: 'FOR', dex: 'DES', con: 'CON', int: 'INT', wis: 'SAB', cha: 'CAR'};

    const THEME_COLORS = [
        { label: 'Brilho Principal', var: '--gold-glow' },
        { label: 'Brilho Hover', var: '--gold-glow-hover' },
        { label: 'Texto Principal', var: '--text-primary' },
        { label: 'Fundo Escuro', var: '--bg-dark-transparent' },
        { label: 'Borda Dourada', var: '--border-gold' },
        { label: 'Cor do Sucesso', var: '--green-success' },
        { label: 'Cor da Falha', var: '--red-failure' },
        { label: 'Fundo Transparente', var: '--black-transparent' },
        { label: 'HP Grad. Início', var: '--hp-gradient-start' },
        { label: 'HP Grad. Fim', var: '--hp-gradient-end' },
        { label: 'Cor dos Títulos', var: '--header-gold-text' },
        { label: 'Cor do Texto de Sucesso', var: '--success-text' },
        { label: 'Cor do Texto de Falha', var: '--failure-text' }
    ];

    const FLAME_COLORS = [
        { label: 'Cor Principal Chama', var: '--flame-orange' },
        { label: 'Cor Secundária Chama', var: '--flame-yellow' },
        { label: 'Cor Terciária Chama', var: '--flame-red' },
        { label: 'Intensidade Brilho Etéreo', var: '--flame-spread-factor', type: 'range', min: 0.1, max: 2.0, step: 0.05 }
    ];

    const COLOR_PALETTES = {
        'radiant': {
            '--gold-glow': '#ffd700',
            '--gold-glow-hover': '#ffec80',
            '--text-primary': '#f0f0f0',
            '--border-gold': 'rgba(255, 215, 0, 0.6)',
            '--green-success': '#22c55e',
            '--red-failure': '#ef4444',
            '--black-transparent': 'rgba(0, 0, 0, 0.6)',
            '--hp-gradient-start': '#6b0000',
            '--hp-gradient-end': '#ff0000',
            '--flame-orange': 'rgba(255, 165, 0, 0.7)',
            '--flame-yellow': 'rgba(255, 200, 0, 0.5)',
            '--flame-red': 'rgba(255, 100, 0, 0.3)',
            '--flame-orange-alt': 'rgba(255, 180, 0, 0.8)',
            '--flame-yellow-alt': 'rgba(255, 210, 0, 0.6)',
            '--flame-red-alt': 'rgba(255, 80, 0, 0.4)',
            '--header-gold-text': '#ffd700',
            '--success-text': '#22c55e',
            '--failure-text': '#ef4444'
        },
        'necrotic': {
            '--gold-glow': '#00E6E6',
            '--gold-glow-hover': '#00FFFF',
            '--text-primary': '#A0A0A0',
            '--border-gold': 'rgba(0, 150, 150, 0.6)',
            '--green-success': '#7CFC00',
            '--red-failure': '#8B008B',
            '--black-transparent': 'rgba(0, 0, 0, 0.7)',
            '--hp-gradient-start': '#4B0082',
            '--hp-gradient-end': '#800080',
            '--flame-orange': 'rgba(0, 180, 180, 0.7)',
            '--flame-yellow': 'rgba(0, 220, 220, 0.5)',
            '--flame-red': 'rgba(0, 120, 120, 0.3)',
            '--flame-orange-alt': 'rgba(0, 190, 190, 0.8)',
            '--flame-yellow-alt': 'rgba(0, 230, 230, 0.6)',
            '--flame-red-alt': 'rgba(0, 130, 130, 0.4)',
            '--header-gold-text': '#00E6E6',
            '--success-text': '#7CFC00',
            '--failure-text': '#8B008B'
        }
    };

    const ITEM_RARITIES = [
        'comum', 'incomum', 'raro', 'muito raro', 'lendario', 'artefato'
    ];

    function initializeDefaultData() {
        characterData = {
            name: '', characterClass: '', characterLevel: 1, race: '', image: defaultImagePlaceholder, spellcastingAbility: 'int',
            ac: 10, speed: '9m',
            hp: { current: 10, max: 10, temp: 0, hitDice: { current: 1, max: 1, type: 'd8' } },
            deathSaves: { successes: [false, false, false], failures: [false, false, false] },
            attributes: { str: 10, dex: 10, con: 10, int: 10, wis: 10, cha: 10 },
            savingThrows: {}, skills: {}, inventory: [], keyInventory: [], spells: [], spellSlots: {},
            journal: '',
            journalEntries: [],
            rollHistory: [], vinculos: [], currency: { cp: 0, sp: 0, ep: 0, gp: 0, pp: 0 },
            theme: {
                colors: {},
                wallpaper: '',
                musicPlayerEnabled: false,
                flameGlowEnabled: true,
                mode: 'radiant',
                currentTab: 'character-tab',
                quickAccessCollapsed: true,
                sectionVisibility: {
                    attacks: true,
                    resources: true,
                    conditions: true,
                    personality: true,
                    musicPlayer: false,
                    proficiencies: true
                }
            },
            proficiencies: {
                armors: '',
                weapons: '',
                tools: ''
            },
            passiveSenses: {
                perception: 0,
                investigation: 0,
                insight: 0
            },
            combat: {
                attacks: [],
                resources: [],
                conditions: []
            },
            rests: {
                short: 0,
                long: 0
            },
            personality: {
                traits: '',
                ideals: '',
                flaws: '',
                history: '',
                organizations: ''
            }
        };
        ATTRIBUTES.forEach(attr => { characterData.savingThrows[attr.id] = { proficient: false, advantage: false }; });
        SKILLS.forEach(skill => { characterData.skills[skill.name.toLowerCase().replace(/ /g, '-')] = { proficient: false, advantage: false }; });
        for(let i=1; i<=9; i++) { characterData.spellSlots[i] = { current: 0, max: 0 }; }

        Object.assign(characterData.theme.colors, COLOR_PALETTES['radiant']);
        characterData.theme.colors['--flame-spread-factor'] = 1.0;
    }

    // --- PERSISTÊNCIA DE DADOS ---
    const STORAGE_KEY = 'dndGothicSheetComplete'; // Chave única para todos os dados da aplicação

    function saveData() {
        const appState = {
            characterData: characterData,
            localPlaylist: localPlaylist,
        };
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
        } catch (e) {
            console.error("Erro ao salvar dados no localStorage:", e);
            showMessage("Erro ao salvar dados. A ficha pode ser muito grande ou o armazenamento está cheio.", "error");
        }
    }

    function loadData() {
        const savedAppState = localStorage.getItem(STORAGE_KEY);
        if (savedAppState) {
            try {
                const parsedState = JSON.parse(savedAppState);
                characterData = parsedState.characterData || {};
                localPlaylist = parsedState.localPlaylist || [];

                if (!characterData.name) initializeDefaultData();
                
                if (!characterData.vinculos) characterData.vinculos = [];
                if (!characterData.spellcastingAbility) characterData.spellcastingAbility = 'int';
                if (!characterData.currency) characterData.currency = { cp: 0, sp: 0, ep: 0, gp: 0, pp: 0 };
                if (!characterData.keyInventory) characterData.keyInventory = [];
                if (!characterData.theme) characterData.theme = { colors: {}, wallpaper: '', musicPlayerEnabled: false, flameGlowEnabled: true, mode: 'radiant' };
                if (characterData.theme.musicPlayerEnabled === undefined) characterData.theme.musicPlayerEnabled = false;
                if (characterData.theme.flameGlowEnabled === undefined) characterData.theme.flameGlowEnabled = true;
                if (characterData.theme.mode === undefined) characterData.theme.mode = 'radiant';
                if (characterData.theme.quickAccessCollapsed === undefined) characterData.theme.quickAccessCollapsed = true;
                if (!characterData.theme.currentTab) characterData.theme.currentTab = 'character-tab';

                Object.assign(characterData.theme.colors, COLOR_PALETTES[characterData.theme.mode], characterData.theme.colors);
                if (characterData.theme.colors['--flame-spread-factor'] === undefined) characterData.theme.colors['--flame-spread-factor'] = 1.0;
                
                if (!characterData.savingThrows) {
                    characterData.savingThrows = {};
                    ATTRIBUTES.forEach(attr => { characterData.savingThrows[attr.id] = { proficient: false, advantage: false }; });
                }
                Object.values(characterData.savingThrows).forEach(s => { if(s.advantage === undefined) s.advantage = false; });
                Object.values(characterData.skills).forEach(s => { if(s.advantage === undefined) s.advantage = false; });

                ['inventory', 'keyInventory'].forEach(invType => {
                    characterData[invType].forEach(item => {
                        if (item.rarity === undefined) item.rarity = 'comum';
                        if (item.isSingle === undefined) item.isSingle = false;
                        if (item.bonuses === undefined) item.bonuses = [];
                    });
                });

                if (!characterData.proficiencies) characterData.proficiencies = { armors: '', weapons: '', tools: '' };
                characterData.passiveSenses = { perception: 0, investigation: 0, insight: 0 };

                if (!characterData.combat) characterData.combat = { attacks: [], resources: [], conditions: [] };
                if (!characterData.combat.attacks) characterData.combat.attacks = [];
                if (!characterData.combat.resources) {
                    characterData.combat.resources = [];
                } else {
                    characterData.combat.resources.forEach(res => {
                        if (res.uses === undefined) { res.uses = { current: 0, max: 0, reset: 'other' }; }
                        if (res.uses.reset === undefined) res.uses.reset = 'other';
                    });
                }
                if (!characterData.combat.conditions) characterData.combat.conditions = [];

                if (!characterData.hp.hitDice) characterData.hp.hitDice = { current: characterData.characterLevel, max: characterData.characterLevel, type: 'd8' };
                if (!characterData.rests) characterData.rests = { short: 0, long: 0 };
                if (!characterData.personality) characterData.personality = { traits: '', ideals: '', flaws: '', organizations: '', history: '' };
                if (!characterData.journalEntries) characterData.journalEntries = [];
                
            } catch (e) {
                console.error("Erro ao analisar dados do localStorage. Revertendo para dados padrão.", e);
                initializeDefaultData();
                showMessage("Dados salvos corrompidos. A ficha foi redefinida para os valores padrão.", "error", 5000);
            }
        } else {
            initializeDefaultData();
        }
    }

    function populateUIFromData() {
        document.getElementById('characterName').value = characterData.name;
        document.getElementById('characterClass').value = characterData.characterClass;
        const characterLevelDisplay = document.getElementById('characterLevelDisplay');
        if (characterLevelDisplay) characterLevelDisplay.textContent = characterData.characterLevel;

        document.getElementById('characterRace').value = characterData.race;
        document.getElementById('charImage').src = characterData.image;
        document.getElementById('hpCurrent').value = characterData.hp.current;
        document.getElementById('hpMax').value = characterData.hp.max;
        document.getElementById('hpTemp').value = characterData.hp.temp;
        
        const spellcastingAbilitySelect = document.getElementById('spellcasting-ability');
        if (spellcastingAbilitySelect) {
            spellcastingAbilitySelect.value = characterData.spellcastingAbility;
        } else {
            characterData.spellcastingAbility = characterData.spellcastingAbility || 'int';
        }
        document.getElementById('ac').value = characterData.ac;

        document.getElementById('prof-armors').value = characterData.proficiencies.armors;
        document.getElementById('prof-weapons').value = characterData.proficiencies.weapons;
        document.getElementById('prof-tools').value = characterData.proficiencies.tools;

        document.getElementById('hit-dice-current').value = characterData.hp.hitDice.current;
        document.getElementById('hit-dice-max').value = characterData.hp.hitDice.max;
        document.getElementById('hit-dice-type').value = characterData.hp.hitDice.type;
        document.getElementById('short-rests-count').textContent = characterData.rests.short;
        document.getElementById('long-rests-count').textContent = characterData.rests.long;

        document.getElementById('personalityTraits').value = characterData.personality.traits;
        document.getElementById('ideals').value = characterData.personality.ideals;
        document.getElementById('flaws').value = characterData.personality.flaws;
        document.getElementById('characterHistory').value = characterData.personality.history;
        document.getElementById('organizations').value = characterData.personality.organizations;

        applyTheme();
        renderAttributeBar();
        renderAbilitySkillGroups();
        renderSpells();
        renderInventory();
        renderCurrency();
        renderVinculos();
        renderDeathSaves();
        renderRollHistory();
        renderAttacks();
        renderResources();
        renderActiveConditions();
        renderJournalEntries();
        updateAllCalculations();

        setupMusicPlayer();

        switchTab(characterData.theme.currentTab);
        renderThemeSettings();

        for (const section in characterData.theme.sectionVisibility) {
            const checkbox = document.getElementById(`toggle-section-${section}`);
            if (checkbox) {
                checkbox.checked = characterData.theme.sectionVisibility[section];
            }
            toggleSectionVisibility(section, characterData.theme.sectionVisibility[section], false);
        }
        updateCharImageDisplay();

        const quickAccessContainer = document.getElementById('global-quick-access-container');
        const contentWrapper = document.getElementById('quick-access-content-wrapper');
        const toggleBtnIcon = document.querySelector('#quick-access-toggle-btn i');

        if (characterData.theme.quickAccessCollapsed) {
            quickAccessContainer.classList.add('collapsed');
            contentWrapper.style.maxHeight = '0';
            contentWrapper.style.opacity = 0;
            contentWrapper.style.pointerEvents = 'none';
            quickAccessContainer.style.paddingBottom = '0';
        } else {
            quickAccessContainer.classList.remove('collapsed');
            contentWrapper.style.maxHeight = contentWrapper.scrollHeight + 'px';
            contentWrapper.style.opacity = 1;
            contentWrapper.style.pointerEvents = 'auto';
            quickAccessContainer.style.paddingBottom = '0.5rem';
        }
        if (toggleBtnIcon) {
            toggleBtnIcon.setAttribute('data-lucide', characterData.theme.quickAccessCollapsed ? 'chevron-down' : 'chevron-up');
            lucide.createIcons();
        }
    }

    const debouncedCollectDataAndRecalculate = debounce(() => {
        collectDataFromUI();
        updateAllCalculations();
    }, 300);

    const debouncedUpdateProficiencies = debounce((type, value) => {
        characterData.proficiencies[type] = value;
        saveData();
    }, 300);

    const debouncedUpdateHitDice = debounce(() => {
        characterData.hp.hitDice.current = parseInt(document.getElementById('hit-dice-current').value) || 0;
        characterData.hp.hitDice.max = parseInt(document.getElementById('hit-dice-max').value) || 0;
        characterData.hp.hitDice.type = document.getElementById('hit-dice-type').value;
        saveData();
        updateAllCalculations();
    }, 300);

    function collectDataFromUI() {
        characterData.name = document.getElementById('characterName').value;
        characterData.characterClass = document.getElementById('characterClass').value;
        characterData.race = document.getElementById('characterRace').value;
        characterData.ac = parseInt(document.getElementById('ac').value) || 10;
        characterData.hp.current = parseInt(document.getElementById('hpCurrent').value) || 0;
        characterData.hp.max = parseInt(document.getElementById('hpMax').value) || 0;
        characterData.hp.temp = parseInt(document.getElementById('hpTemp').value) || 0;
        
        const spellcastingAbilitySelect = document.getElementById('spellcasting-ability');
        if (spellcastingAbilitySelect) {
            characterData.spellcastingAbility = spellcastingAbilitySelect.value;
        } else {
            characterData.spellcastingAbility = characterData.spellcastingAbility || 'int';
        }
        characterData.personality.traits = document.getElementById('personalityTraits').value;
        characterData.personality.ideals = document.getElementById('ideals').value;
        characterData.personality.flaws = document.getElementById('flaws').value;
        characterData.personality.history = document.getElementById('characterHistory').value;
        characterData.personality.organizations = document.getElementById('organizations').value;

        saveData();
    }

    function adjustLevel(delta) {
        let newLevel = characterData.characterLevel + delta;
        if (newLevel < 1) newLevel = 1;
        if (newLevel > 20) newLevel = 20;
        characterData.characterLevel = newLevel;
        document.getElementById('characterLevelDisplay').textContent = characterData.characterLevel;
        collectDataFromUI();
        updateAllCalculations();
    }

    let currentAttrModalId = '';
    function adjustAttributeScore(delta) {
        if (!currentAttrModalId) return;
        let currentScore = characterData.attributes[currentAttrModalId];
        let newScore = currentScore + delta;
        if (newScore < 1) newScore = 1;

        characterData.attributes[currentAttrModalId] = newScore;
        const input = document.getElementById('attribute-modal-input');
        const modifierSpan = document.getElementById('attribute-modal-modifier');
        input.value = newScore;
        modifierSpan.textContent = calculateModifier(newScore) >= 0 ? `+${calculateModifier(newScore)}` : calculateModifier(newScore);
        updateAllCalculations();
        saveData();
    }

    const getLevel = () => parseInt(characterData.characterLevel || 1);
    const calculateProficiencyBonus = () => Math.ceil(1 + getLevel() / 4);
    const calculateModifier = (score) => Math.floor((score - 10) / 2);

    function calculateAllItemBonuses() {
        const allItems = [...characterData.inventory, ...characterData.keyInventory];
        const totalBonuses = { attributes: {}, skills: {}, savingThrows: {}, spellSaveDc: 0, spellAttackBonus: 0, ac: 0, maxHp: 0 };
        for (const item of allItems) {
            if (!item.bonuses) continue;
            for (const bonus of item.bonuses) {
                switch (bonus.type) {
                    case 'attribute':
                    case 'skill':
                    case 'savingThrow':
                        const category = bonus.type === 'attribute' ? 'attributes' : (bonus.type === 'skill' ? 'skills' : 'savingThrows');
                        totalBonuses[category][bonus.target] = (totalBonuses[category][bonus.target] || 0) + bonus.value;
                        break;
                    case 'ac':
                        totalBonuses.ac += bonus.value;
                        break;
                    case 'maxHp':
                        totalBonuses.maxHp += bonus.value;
                        break;
                    case 'spellSaveDc':
                        totalBonuses.spellSaveDc += bonus.value;
                        break;
                    case 'spellAttackBonus':
                        totalBonuses.spellAttackBonus += bonus.value;
                        break;
                    default:
                        totalBonuses[bonus.type] = (totalBonuses[bonus.type] || 0) + bonus.value;
                        break;
                }
            }
        }
        return totalBonuses;
    }

    function updateAllCalculations() {
        const profBonus = calculateProficiencyBonus();
        const itemBonuses = calculateAllItemBonuses();
        
        const proficiencyBonusDisplayEl = document.getElementById('proficiencyBonusDisplay');
        if (proficiencyBonusDisplayEl) proficiencyBonusDisplayEl.textContent = `+${profBonus}`;

        const baseMaxHp = parseInt(characterData.hp.max) || 0;
        const finalMaxHp = baseMaxHp + itemBonuses.maxHp;
        document.getElementById('hpMax').value = finalMaxHp;

        const baseAC = parseInt(characterData.ac) || 10;
        const finalAC = baseAC + itemBonuses.ac;
        document.getElementById('ac').value = finalAC;

        ATTRIBUTES.forEach(attr => {
            const baseScore = characterData.attributes[attr.id] || 10;
            const finalScore = baseScore + (itemBonuses.attributes[attr.id] || 0);
            const modifier = calculateModifier(finalScore);

            const scoreDisplayEl = document.querySelector(`.attribute-item[data-attr='${attr.id}'] .attr-score-display`);
            if(scoreDisplayEl) scoreDisplayEl.textContent = finalScore;

            const modifierPopupEl = document.querySelector(`.attribute-item[data-attr='${attr.id}'] .attr-modifier`);
            if(modifierPopupEl) modifierPopupEl.textContent = `${modifier >= 0 ? '+' : ''}${modifier}`;

            if (attr.id === 'dex') {
                const initiativeEl = document.getElementById('initiative');
                if (initiativeEl) {
                    initiativeEl.textContent = modifier >= 0 ? `+${modifier}` : modifier;
                }
            }

            const saveProf = characterData.savingThrows[attr.id]?.proficient || false;
            const totalSave = modifier + (saveProf ? profBonus : 0) + (itemBonuses.savingThrows[attr.id] || 0);
            const saveTotalEl = document.getElementById(`save-total-${attr.id}`);
            if (saveTotalEl) saveTotalEl.textContent = totalSave >= 0 ? `+${totalSave}` : totalSave;
        });

        SKILLS.forEach(skill => {
            const skillId = skill.name.toLowerCase().replace(/ /g, '-');
            const baseAttrScore = characterData.attributes[skill.attr] || 10;
            const itemAttrBonus = itemBonuses.attributes[skill.attr] || 0;
            const modifier = calculateModifier(baseAttrScore + itemAttrBonus);
            const skillProf = characterData.skills[skillId]?.proficient || false;
            const totalSkill = modifier + (skillProf ? profBonus : 0) + (itemBonuses.skills[skillId] || 0);
            const skillTotalEl = document.getElementById(`skill-total-${skillId}`);
            if(skillTotalEl) skillTotalEl.textContent = totalSkill >= 0 ? `+${totalSkill}` : totalSkill;

            if (skill.passive) {
                const passiveScore = 10 + totalSkill;
                const passiveElementId = `passive-${skill.slug || skill.name.toLowerCase().replace(/[^a-z0-9]/g, '')}`;
                const passiveElement = document.getElementById(passiveElementId);
                if (passiveElement) {
                    passiveElement.textContent = passiveScore;
                    characterData.passiveSenses[skill.slug || skill.name.toLowerCase().replace(/[^a-z0-9]/g, '')] = passiveScore;
                }
            }
        });

        updateHpBar();
        updateSpellSlots();
        updateSpellcastingStats();
    }

    function updateSpellcastingStats() {
        const itemBonuses = calculateAllItemBonuses();
        const ability = characterData.spellcastingAbility;
        const baseScore = characterData.attributes[ability] || 10;
        const itemAttrBonus = itemBonuses.attributes[ability] || 0;
        const modifier = calculateModifier(baseScore + itemAttrBonus);
        const profBonus = calculateProficiencyBonus();
        const dc = 8 + profBonus + modifier + itemBonuses.spellSaveDc;
        const attackBonus = profBonus + modifier + itemBonuses.spellAttackBonus;
        
        const spellSaveDcEl = document.getElementById('spell-save-dc');
        if (spellSaveDcEl) spellSaveDcEl.textContent = dc;
        
        const spellAttackBonusEl = document.getElementById('spell-attack-bonus');
        if (spellAttackBonusEl) spellAttackBonusEl.textContent = attackBonus >= 0 ? `+${attackBonus}` : attackBonus;
    }

    function updateHpBar() {
        const current = parseInt(document.getElementById('hpCurrent').value) || 0;
        const max = parseInt(document.getElementById('hpMax').value) || 1;
        const percentage = Math.max(0, Math.min(100, (current / max) * 100));
        const bar = document.getElementById('hpBar');
        bar.style.width = `${percentage}%`;
        bar.textContent = `${current} / ${max}`;
    }

    function renderAttributeBar() {
        const container = document.getElementById('attribute-bar');
        if (!container) return;

        container.innerHTML = '';

        ATTRIBUTES.forEach(attr => {
            const item = document.createElement('div');
            item.className = 'attribute-item';
            item.dataset.attr = attr.id;
            item.innerHTML = `
                <div class="attr-score-display" onclick="openAttributeModal('${attr.id}')"></div>
                <div class="attr-modifier"></div>
                <div class="attr-name">${attr.abbr}</div>
            `;
            container.appendChild(item);
        });
        lucide.createIcons();
    }

    function renderAbilitySkillGroups() {
        const container = document.getElementById('ability-skill-groups');
        if (!container) return;

        container.innerHTML = '';

        ATTRIBUTES.forEach(attr => {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'ability-group';

            const saveSkillData = characterData.savingThrows[attr.id] || { proficient: false, advantage: false };
            groupDiv.innerHTML += `
                <div class="ability-row">
                    <label class="font-bold" style="color: var(--header-gold-text);">${attr.name}</label>
                    <div class="advantage-dot ${saveSkillData.advantage ? 'toggled' : ''}" onclick="toggleAdvantage(event, 'savingThrows', '${attr.id}')"></div>
                    <div class="proficiency-dot ${saveSkillData.proficient ? 'toggled' : ''}" onclick="toggleProficiency(event, 'savingThrows', '${attr.id}')"></div>
                    <span id="save-total-${attr.id}" class="font-bold text-lg">+0</span>
                </div>
            `;

            const associatedSkills = SKILLS.filter(skill => skill.attr === attr.id);
            associatedSkills.forEach(skill => {
                const skillId = skill.name.toLowerCase().replace(/ /g, '-');
                const skillData = characterData.skills[skillId] || { proficient: false, advantage: false };
                groupDiv.innerHTML += `
                    <div class="ability-row">
                        <label>${skill.name}</label>
                        <div class="advantage-dot ${skillData.advantage ? 'toggled' : ''}" onclick="toggleAdvantage(event, 'skills', '${skillId}')"></div>
                        <div class="proficiency-dot ${skillData.proficient ? 'toggled' : ''}" onclick="toggleProficiency(event, 'skills', '${skillId}')"></div>
                        <span id="skill-total-${skillId}" class="font-bold text-lg">+0</span>
                    </div>
                `;
            });
            container.appendChild(groupDiv);
        });
        lucide.createIcons();
    }

    // --- LISTENERS DE EVENTOS E CONFIGURAÇÃO INICIAL ---
    function setupEventListeners() {
        document.querySelectorAll('#characterName, #characterClass, #characterRace, #hpCurrent, #hpMax, #hpTemp, #ac').forEach(el => {
            el.addEventListener('input', debouncedCollectDataAndRecalculate);
        });
        document.querySelectorAll('#personalityTraits, #ideals, #flaws, #characterHistory, #organizations').forEach(el => {
            el.addEventListener('input', debouncedCollectDataAndRecalculate);
        });
        
        document.getElementById('imageUpload').addEventListener('change', handleImageUpload);
        document.getElementById('wallpaperUpload').addEventListener('change', handleWallpaperUpload);
        
        document.getElementById('spell-image-upload').addEventListener('change', handleTempSpellImage);
        document.getElementById('edit-item-upload').addEventListener('change', handleEditItemImageUpload);
        
        document.getElementById('vinculo-imagem-input').addEventListener('change', handleVinculoImageUpload);

        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', function() {
                switchTab(this.dataset.tab);
            });
        });

        document.querySelectorAll('.spell-modal-tabs .spell-modal-tab-button').forEach(button => {
            button.addEventListener('click', function() {
                const tabId = this.dataset.tabTarget;
                switchSpellModalTab(tabId);
            });
        });

        const localMusicInput = document.getElementById('localMusicInput');
        if (localMusicInput) {
            localMusicInput.addEventListener('change', handleLocalMusicFiles);
        }

        const localMusicDropArea = document.getElementById('localMusicDropArea');
        if (localMusicDropArea) {
            localMusicDropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                localMusicDropArea.classList.add('drag-over');
            });
            localMusicDropArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                localMusicDropArea.classList.remove('drag-over');
            });
            localMusicDropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                localMusicDropArea.classList.remove('drag-over');
                if (e.dataTransfer && e.dataTransfer.files) {
                    handleLocalMusicFiles({ target: { files: e.dataTransfer.files } });
                }
            });
            localMusicDropArea.addEventListener('click', () => localMusicInput.click());
        }

        if (audioPlayer) {
            audioPlayer.addEventListener('ended', nextTrack);
            audioPlayer.addEventListener('play', () => {
                document.getElementById('playPauseIcon').setAttribute('data-lucide', 'pause');
                lucide.createIcons();
                if (localPlaylist[currentTrackIndex]) {
                    showNowPlaying(localPlaylist[currentTrackIndex].name, "Música Local");
                }
            });
            audioPlayer.addEventListener('pause', () => {
                document.getElementById('playPauseIcon').setAttribute('data-lucide', 'play');
                lucide.createIcons();
            });
        }

        document.getElementById('prof-armors').addEventListener('input', (e) => debouncedUpdateProficiencies('armors', e.target.value));
        document.getElementById('prof-weapons').addEventListener('input', (e) => debouncedUpdateProficiencies('weapons', e.target.value));
        document.getElementById('prof-tools').addEventListener('input', (e) => debouncedUpdateProficiencies('tools', e.target.value));

        document.getElementById('importFileInput').addEventListener('change', importAllData);
    }

    window.onload = () => { loadData(); populateUIFromData(); setupEventListeners(); lucide.createIcons(); };

    // --- FUNÇÕES DE MODAL E RECURSOS ---
    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    function showMessage(message, type = 'success', duration = 3000) {
        const popup = document.getElementById('messagePopup');
        if (!popup) return;

        clearTimeout(messageTimeout);

        popup.textContent = message;
        popup.classList.remove('success', 'error');
        popup.classList.add(type);
        popup.classList.add('show');

        messageTimeout = setTimeout(() => {
            popup.classList.remove('show');
        }, duration);
    }

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('active');
        });

        document.getElementById(tabId).classList.add('active');
        document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('active');

        characterData.theme.currentTab = tabId;
        saveData();
    }

    function switchSpellModalTab(tabId) {
        document.querySelectorAll('.spell-modal-tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.querySelectorAll('.spell-modal-tab-button').forEach(button => {
            button.classList.remove('active');
        });

        document.getElementById(tabId).classList.add('active');
        document.querySelector(`.spell-modal-tab-button[data-tab-target="${tabId}"]`).classList.add('active');

        if (tabId === 'conjuration-tab-content') {
            updateSpellcastingStats();
            updateAllCalculations();
        }
    }

    function handleImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            characterData.image = e.target.result;
            document.getElementById('charImage').src = characterData.image;
            updateCharImageDisplay();
            saveData();
        };
        reader.readAsDataURL(file);
    }

    function updateCharImageDisplay() {
        const charImage = document.getElementById('charImage');
        const overlay = document.getElementById('char-image-overlay');
        if (charImage.src === defaultImagePlaceholder || !characterData.image || characterData.image === defaultImagePlaceholder) {
            overlay.classList.remove('opacity-0', 'invisible');
            charImage.style.opacity = '0.5';
        } else {
            overlay.classList.add('opacity-0', 'invisible');
            charImage.style.opacity = '1';
        }
        lucide.createIcons();
    }

    function toggleAdvantage(event, type, id) {
        const target = type === 'skills' ? characterData.skills[id] : characterData.savingThrows[id];
        target.advantage = !target.advantage;
        event.currentTarget.classList.toggle('toggled', target.advantage);
        saveData();
    }
    function toggleProficiency(event, type, id) {
        const target = type === 'skills' ? characterData.skills[id] : characterData.savingThrows[id];
        target.proficient = !target.proficient;
        event.currentTarget.classList.toggle('toggled', target.proficient);
        updateAllCalculations();
        saveData();
    }

    function openAttributeModal(attrId) {
        currentAttrModalId = attrId;
        const attr = ATTRIBUTES.find(a => a.id === attrId);
        const score = characterData.attributes[attrId];
        document.getElementById('attribute-modal-title').textContent = `Editar ${attr.name}`;
        const input = document.getElementById('attribute-modal-input');
        const modifierSpan = document.getElementById('attribute-modal-modifier');
        input.value = score;
        modifierSpan.textContent = calculateModifier(score) >= 0 ? `+${calculateModifier(score)}` : calculateModifier(score);
        
        input.oninput = () => {
            const newScore = parseInt(input.value) || 0;
            characterData.attributes[currentAttrModalId] = newScore;
            modifierSpan.textContent = calculateModifier(newScore) >= 0 ? `+${calculateModifier(newScore)}` : calculateModifier(newScore);
            updateAllCalculations();
            saveData();
        };
        openModal('attributeEditModal');
    }

    function renderDeathSaves(){
        for(let i = 0; i < 3; i++) {
            if(characterData.deathSaves.successes[i]) document.getElementById(`dss-${i+1}`).classList.add('checked');
            else document.getElementById(`dss-${i+1}`).classList.remove('checked');
            if(characterData.deathSaves.failures[i]) document.getElementById(`dsf-${i+1}`).classList.add('checked');
            else document.getElementById(`dsf-${i+1}`).classList.remove('checked');
        }
    }
    function toggleDeathSave(type, index) {
        characterData.deathSaves[type][index] = !characterData.deathSaves[type][index];
        document.getElementById(`${type === 'successes' ? 'dss' : 'dsf'}-${index+1}`).classList.toggle('checked');
        saveData();
    }

    let currentEditingSpellIndex = null;
    function openSpellEditModal(index) {
        currentEditingSpellIndex = index;
        tempSpellImage = null;
        if (index !== null) {
            const spell = characterData.spells[index];
            document.getElementById('spell-modal-title').textContent = 'Editar Magia';
            document.getElementById('spell-name-input').value = spell.name;
            document.getElementById('spell-level-input').value = spell.level;
            document.getElementById('spell-casting-time-input').value = spell.castingTime;
            document.getElementById('spell-range-input').value = spell.range;
            document.getElementById('comp-v').checked = spell.components.V;
            document.getElementById('comp-s').checked = spell.components.S;
            document.getElementById('comp-m').checked = spell.components.M;
            document.getElementById('spell-material-desc-input').value = spell.components.materialDesc;
            document.getElementById('spell-duration-input').value = spell.duration;
            document.getElementById('spell-description-input').value = spell.description;
        } else {
            document.getElementById('spell-modal-title').textContent = 'Criar Magia';
            document.getElementById('spell-name-input').value = '';
            document.getElementById('spell-level-input').value = 0;
            document.getElementById('spell-casting-time-input').value = '';
            document.getElementById('spell-range-input').value = '';
            document.getElementById('comp-v').checked = false;
            document.getElementById('comp-s').checked = false;
            document.getElementById('comp-m').checked = false;
            document.getElementById('spell-material-desc-input').value = '';
            document.getElementById('spell-duration-input').value = '';
            document.getElementById('spell-description-input').value = '';
        }
        openModal('spellEditModal');
    }
    function handleTempSpellImage(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => { tempSpellImage = e.target.result; };
        reader.readAsDataURL(file);
    }
    function closeSpellEditModal() { closeModal('spellEditModal'); }
    function saveSpell() {
        const spellName = document.getElementById('spell-name-input').value.trim();

        if (!spellName) {
            showMessage("Nome da magia é obrigatório!", "error");
            return;
        }

        const spell = {
            name: spellName,
            level: parseInt(document.getElementById('spell-level-input').value),
            castingTime: document.getElementById('spell-casting-time-input').value,
            range: document.getElementById('spell-range-input').value,
            components: {
                V: document.getElementById('comp-v').checked,
                S: document.getElementById('comp-s').checked,
                M: document.getElementById('comp-m').checked,
                materialDesc: document.getElementById('spell-material-desc-input').value
            },
            duration: document.getElementById('spell-duration-input').value,
            description: document.getElementById('spell-description-input').value,
            image: tempSpellImage || ''
        };
        
        if (currentEditingSpellIndex !== null) {
            characterData.spells[currentEditingSpellIndex] = spell;
            showMessage("Magia atualizada com sucesso!", "success");
        } else {
            characterData.spells.push(spell);
            showMessage("Magia criada com sucesso!", "success");
        }
        characterData.spells.sort((a,b) => a.level - b.level || a.name.localeCompare(b.name));
        renderSpells();
        saveData();
        closeModal('spellEditModal');
    }
    function deleteSpell(index) {
        characterData.spells.splice(index, 1);
        renderSpells();
        saveData();
        showMessage("Magia removida.", "success");
    }
    function renderSpells() {
        const list = document.getElementById('spellList');
        list.innerHTML = '';
        let currentLevel = -1;
        characterData.spells.forEach((spell, index) => {
            if (spell.level !== currentLevel) {
                currentLevel = spell.level;
                const levelTitle = currentLevel == 0 ? "Truques" : `${currentLevel}º Nível`;
                list.innerHTML += `<h3 class="text-xl border-b-2 border-yellow-800/30 mt-4 pb-1" style="color: var(--header-gold-text);">${levelTitle}</h3>`;
            }
            const components = `${spell.components.V ? 'V ' : ''}${spell.components.S ? 'S ' : ''}${spell.components.M ? 'M ' : ''}`.trim();
            list.innerHTML += `
                <div class="gothic-card p-3 mt-2 flex gap-4">
                    <div class="flex-grow">
                        <div class="flex justify-between items-start">
                            <h4 class="text-lg font-bold">${spell.name}</h4>
                            <div class="flex gap-2">
                                <button class="gothic-btn text-xs py-1 px-2" onclick="openSpellEditModal(${index})">Editar</button>
                                <button class="gothic-btn text-xs py-1 px-2 !border-red-500 !text-red-500 hover:!bg-red-500 hover:!text-black" onclick="deleteSpell(${index})">X</button>
                            </div>
                        </div>
                        <div class="text-xs opacity-70 mt-1">
                            <span>${spell.castingTime} | ${spell.range} | ${spell.duration} | ${components}</span>
                        </div>
                        <p class="text-sm mt-2 pt-2 border-t border-yellow-800/30">${spell.description}</p>
                    </div>
                    ${spell.image ? `<img src="${spell.image}" class="w-24 h-24 object-cover rounded-lg border-2 border-border-gold flex-shrink-0">` : ''}
                </div>`;
        });
    }
    const debouncedUpdateSpellSlot = debounce((level, type, value) => {
        characterData.spellSlots[level][type] = parseInt(value) || 0;
        saveData();
    }, 300);

    function updateSpellSlots() {
        const container = document.getElementById('spellSlots');
        container.innerHTML = '';
        for(let i=1; i<=9; i++) {
            container.innerHTML += `
                <div class="text-center">
                    <label class="text-xs">Nível ${i}</label>
                    <div class="flex gap-1">
                        <input value="${characterData.spellSlots[i]?.current || 0}" class="gothic-input w-full text-center p-1 text-sm" oninput="debouncedUpdateSpellSlot(${i}, 'current', this.value);">
                        <span class="p-1">/</span>
                        <input value="${characterData.spellSlots[i]?.max || 0}" class="gothic-input w-full text-center p-1 text-sm" oninput="debouncedUpdateSpellSlot(${i}, 'max', this.value);">
                    </div>
                </div>`;
        }
    }

    function switchInventoryListTab(tab) {
        currentInventoryListTab = tab;
        document.getElementById('inventory-tab-equip').classList.toggle('opacity-50', tab !== 'equip');
        document.getElementById('inventory-tab-key').classList.toggle('opacity-50', tab !== 'key');
        document.getElementById('add-item-btn').textContent = tab === 'equip' ? 'Adicionar Equipamento' : 'Adicionar Item Chave';
        renderInventory();
    }

    function openEditInventoryItemModal(itemId = null) {
        currentEditingItemId = itemId;
        tempEditItemImage = null;
        const item = itemId !== null ? 
                                (currentInventoryListTab === 'equip' ? characterData.inventory : characterData.keyInventory).find(i => i.id === itemId) :
                                { id: Date.now(), name: 'Novo Item', qty: 1, isSingle: false, image: defaultImagePlaceholder, type: 'outro', notes: '', damage: '', bonuses: [], linkedVinculoId: '', rarity: 'comum' };

        document.getElementById('edit-item-modal-title').textContent = itemId !== null ? 'Editar Item' : 'Criar Novo Item';
        document.getElementById('edit-item-image').src = item.image;
        document.getElementById('edit-item-name').value = item.name;
        document.getElementById('edit-item-qty').value = item.qty;
        document.getElementById('edit-item-type').value = item.type;
        document.getElementById('edit-item-rarity').value = item.rarity || 'comum';
        document.getElementById('edit-item-damage').value = item.damage || '';
        document.getElementById('edit-item-notes').value = item.notes;
        document.getElementById('edit-item-is-single').checked = item.isSingle;
        toggleItemIsSingle(item.isSingle);

        const vinculoSelect = document.getElementById('edit-item-linked-vinculo');
        vinculoSelect.innerHTML = '<option value="">Nenhum</option>' + 
                                   characterData.vinculos.map(v => `<option value="${v.id}" ${item.linkedVinculoId == v.id ? 'selected' : ''}>${v.name}</option>`).join('');
        
        toggleEditItemDamageField();
        document.getElementById('edit-item-vinculo-container').style.display = (currentInventoryListTab === 'key' ? 'block' : 'none');

        renderEditItemBonusesList(item.bonuses);
        openModal('editInventoryItemModal');
        currentDetailItemId = null;
    }

    function toggleEditItemDamageField() {
        const itemType = document.getElementById('edit-item-type').value;
        document.getElementById('edit-item-damage-container').style.display = (itemType === 'arma' ? 'block' : 'none');
    }

    function toggleItemIsSingle(isChecked) {
        const qtyInput = document.getElementById('edit-item-qty');
        if (isChecked) {
            qtyInput.value = 1;
            qtyInput.disabled = true;
        } else {
            qtyInput.disabled = false;
        }
    }

    function handleEditItemImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => { 
            tempEditItemImage = e.target.result; 
            document.getElementById('edit-item-image').src = tempEditItemImage;
        };
        reader.readAsDataURL(file);
    }

    function saveInventoryItem() {
        const itemName = document.getElementById('edit-item-name').value.trim();

        if (!itemName) {
            showMessage("Nome do item é obrigatório!", "error");
            return;
        }

        const isSingle = document.getElementById('edit-item-is-single').checked;
        const itemToSave = {
            id: currentEditingItemId || Date.now(),
            name: itemName,
            qty: isSingle ? 1 : (parseInt(document.getElementById('edit-item-qty').value) || 1),
            isSingle: isSingle,
            image: tempEditItemImage || document.getElementById('edit-item-image').src,
            type: document.getElementById('edit-item-type').value,
            rarity: document.getElementById('edit-item-rarity').value,
            notes: document.getElementById('edit-item-notes').value,
            damage: document.getElementById('edit-item-damage').value,
            linkedVinculoId: document.getElementById('edit-item-linked-vinculo').value,
            bonuses: characterData.tempItemBonuses || []
        };

        const inventoryArray = currentInventoryListTab === 'equip' ? characterData.inventory : characterData.keyInventory;
        const existingItemIndex = inventoryArray.findIndex(i => i.id === itemToSave.id);

        if (existingItemIndex !== -1) {
            inventoryArray[existingItemIndex] = itemToSave;
            const existingCard = document.querySelector(`.inventory-item-card[data-item-id="${itemToSave.id}"]`);
            if (existingCard) {
                existingCard.querySelector('img').src = itemToSave.image;
                existingCard.querySelector('.item-name').innerHTML = `${itemToSave.name} <br> <span class="item-qty-display">${itemToSave.isSingle ? 'Único' : `Qtd: ${item.qty}`}</span>`;
            }
            showMessage("Item atualizado com sucesso!", "success");
        } else {
            inventoryArray.unshift(itemToSave);
            const list = document.getElementById('inventoryList');
            const newItemHtml = `
                <div class="inventory-item-card" data-item-id="${itemToSave.id}" onclick="openItemDetailModal(${itemToSave.id})">
                    <button class="delete-item-btn" onclick="event.stopPropagation(); removeInventoryItem(${itemToSave.id})">X</button>
                    <img src="${itemToSave.image}" alt="${itemToSave.name}" onerror="this.src='${defaultImagePlaceholder}'">
                    <span class="item-name">${itemToSave.name} <br> <span class="item-qty-display">${itemToSave.isSingle ? 'Único' : `Qtd: ${itemToSave.qty}`}</span></span>
                </div>
            `;
            if (list.firstChild) {
                list.insertBefore(document.createRange().createContextualFragment(newItemHtml), list.firstChild);
            } else {
                list.innerHTML = newItemHtml;
            }
            lucide.createIcons();
            showMessage("Item adicionado com sucesso!", "success");
        }
        
        characterData.tempItemBonuses = [];

        saveData();
        updateAllCalculations();
        closeModal('editInventoryItemModal');
    }

    function renderEditItemBonusesList(bonuses) {
        const listContainer = document.getElementById('edit-item-bonuses-list');
        listContainer.innerHTML = '';

        characterData.tempItemBonuses = bonuses ? [...bonuses] : [];

        if (characterData.tempItemBonuses.length === 0) {
            listContainer.innerHTML = '<p class="opacity-70 italic text-center">Nenhum bônus adicionado ainda.</p>';
        } else {
            characterData.tempItemBonuses.forEach((b, i) => {
                const bonusDiv = document.createElement('div');
                bonusDiv.className = 'flex justify-between items-center bg-black/20 p-1 rounded';
                bonusDiv.innerHTML = `
                    <span>${b.label}: ${b.value > 0 ? '+' : ''}${b.value}</span>
                    <button class="text-red-500" onclick="removeEditItemBonus(${i})">×</button>
                `;
                listContainer.appendChild(bonusDiv);
            });
        }
    }

    function removeEditItemBonus(bonusIndex) {
        if (characterData.tempItemBonuses) {
            characterData.tempItemBonuses.splice(bonusIndex, 1);
            renderEditItemBonusesList(characterData.tempItemBonuses);
        }
    }

    function removeInventoryItem(itemId) {
        const inventory = currentInventoryListTab === 'equip' ? characterData.inventory : characterData.keyInventory;
        const itemIndex = inventory.findIndex(i => i.id === itemId);
        if (itemIndex !== -1) {
            inventory.splice(itemIndex, 1);
            saveData();
            const itemElement = document.querySelector(`.inventory-item-card[data-item-id="${itemId}"]`);
            if (itemElement) {
                itemElement.remove();
            }
            updateAllCalculations();
            showMessage("Item removido.", "success");
        }
    }

    function openItemDetailModal(itemId) {
        currentDetailItemId = itemId;
        const inventory = currentInventoryListTab === 'equip' ? characterData.inventory : characterData.keyInventory;
        const item = inventory.find(i => i.id === itemId);

        if (!item) return;

        document.getElementById('item-detail-name').textContent = item.name;
        const itemDetailImage = document.getElementById('item-detail-image');
        itemDetailImage.src = item.image;
        itemDetailImage.onclick = () => openImageViewerModal(item.image);

        document.getElementById('item-detail-qty').textContent = item.isSingle ? 'Único' : item.qty;
        document.getElementById('item-detail-type').textContent = item.type;
        document.getElementById('item-detail-rarity').textContent = item.rarity ? item.rarity.charAt(0).toUpperCase() + item.rarity.slice(1) : 'Comum';
        document.getElementById('item-detail-notes').textContent = item.notes || 'Nenhuma nota.';

        const damageRow = document.getElementById('item-detail-damage-row');
        if (item.type === 'arma' && item.damage) {
            document.getElementById('item-detail-damage').textContent = item.damage;
            damageRow.classList.remove('hidden');
        } else {
            damageRow.classList.add('hidden');
        }

        const vinculoRow = document.getElementById('item-detail-vinculo-row');
        if (currentInventoryListTab === 'key' && item.linkedVinculoId) {
            const linkedVinculo = characterData.vinculos.find(v => v.id == item.linkedVinculoId);
            document.getElementById('item-detail-vinculo').textContent = linkedVinculo ? linkedVinculo.name : 'Vínculo Desconhecido';
            vinculoRow.classList.remove('hidden');
        } else {
            vinculoRow.classList.add('hidden');
        }

        const bonusesContainer = document.getElementById('item-detail-bonuses');
        const noBonusesMessage = document.getElementById('no-bonuses-message');
        bonusesContainer.innerHTML = '';
        if (item.bonuses && item.bonuses.length > 0) {
            item.bonuses.forEach(b => {
                const bonusDiv = document.createElement('div');
                bonusDiv.textContent = `${b.label}: ${b.value > 0 ? '+' : ''}${b.value}`;
                bonusesContainer.appendChild(bonusDiv);
            });
            noBonusesMessage.classList.add('hidden');
        } else {
            noBonusesMessage.classList.add('hidden'); // Alterado para esconder sempre se não houver bônus
        }

        openModal('itemDetailModal');
    }

    function openImageViewerModal(imageUrl) {
        const imageViewerImage = document.getElementById('imageViewerImage');
        imageViewerImage.src = imageUrl;
        openModal('imageViewerModal');
    }

    function renderInventory() {
        const list = document.getElementById('inventoryList');
        if(!list) return;
        const inventory = currentInventoryListTab === 'equip' ? characterData.inventory : characterData.keyInventory;
        list.innerHTML = inventory.map(item => `
            <div class="inventory-item-card" data-item-id="${item.id}" onclick="openItemDetailModal(${item.id})">
                <button class="delete-item-btn" onclick="event.stopPropagation(); removeInventoryItem(${item.id})">X</button>
                <img src="${item.image}" alt="${item.name}" onerror="this.src='${defaultImagePlaceholder}'">
                <span class="item-name">${item.name} <br> <span class="item-qty-display">${item.isSingle ? 'Único' : `Qtd: ${item.qty}`}</span></span>
            </div>
        `).join('');
        lucide.createIcons();
    }

    function openItemBonusModal(itemId) {
        currentItemBonusId = itemId;
        updateBonusTarget();
        openModal('itemBonusModal');
    }
    function updateBonusTarget() {
        const type = document.getElementById('bonus-type-select').value;
        const targetSelect = document.getElementById('bonus-target-select');
        let options = '';
        if (type === 'attribute' || type === 'savingThrow') options = ATTRIBUTES.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
        else if (type === 'skill') options = SKILLS.map(s => `<option value="${s.name.toLowerCase().replace(/ /g, '-')}">${s.name}</option>`).join('');
        
        targetSelect.innerHTML = '';

        if (type === 'attribute' || type === 'skill' || type === 'savingThrow') {
            targetSelect.innerHTML = options;
            targetSelect.style.display = 'block';
        } else {
            targetSelect.style.display = 'none';
        }
    }
    function saveItemBonus() {
        const type = document.getElementById('bonus-type-select').value;
        const target = (type === 'attribute' || type === 'skill' || type === 'savingThrow') ? document.getElementById('bonus-target-select').value : '';
        const valueInput = document.getElementById('bonus-value-input');
        const value = parseInt(valueInput.value);

        if (isNaN(value)) {
            showMessage("O valor do bônus deve ser um número.", "error");
            return;
        }
        if (!currentItemBonusId) {
             showMessage("Erro: Nenhum item selecionado para adicionar bônus.", "error");
             return;
        }

        const targetLabel = document.getElementById('bonus-type-select').selectedOptions[0]?.text;
        const targetSubLabel = target ? document.getElementById('bonus-target-select').selectedOptions[0]?.text : '';
        let bonusLabel = targetSubLabel ? `${targetLabel}: ${targetSubLabel}` : targetLabel;

        const newBonus = { type, target, value, label: bonusLabel };
        
        if (!characterData.tempItemBonuses) {
            characterData.tempItemBonuses = [];
        }
        characterData.tempItemBonuses.push(newBonus);
        
        renderEditItemBonusesList(characterData.tempItemBonuses);

        document.getElementById('bonus-type-select').value = 'attribute';
        valueInput.value = '';
        updateBonusTarget();

        closeModal('itemBonusModal');
        showMessage("Bônus adicionado ao item!", "success");
    }

    function openVinculoModal(vinculoId = null) {
        currentEditingVinculoId = vinculoId;
        const nameInput = document.getElementById('vinculo-nome');
        const typeInput = document.getElementById('vinculo-tipo');
        const descriptionTextarea = document.getElementById('vinculo-descricao');
        const imagePreview = document.getElementById('vinculo-imagem-preview');
        const imageInput = document.getElementById('vinculo-imagem-input');

        imageInput.value = '';
        tempVinculoImage = null;

        if (vinculoId !== null) {
            const vinculo = characterData.vinculos.find(v => v.id == vinculoId);
            if (!vinculo) return;
            document.getElementById('vinculo-modal-title').textContent = 'Editar Vínculo';
            nameInput.value = vinculo.name;
            typeInput.value = vinculo.type;
            descriptionTextarea.value = vinculo.description;
            if (vinculo.image) {
                imagePreview.src = vinculo.image;
                imagePreview.style.display = 'block';
            } else {
                imagePreview.src = "";
                imagePreview.style.display = 'none';
            }
            tempVinculoImage = vinculo.image;
        } else {
            document.getElementById('vinculo-modal-title').textContent = 'Adicionar Novo Vínculo';
            nameInput.value = '';
            typeInput.value = '';
            descriptionTextarea.value = '';
            imagePreview.src = "";
            imagePreview.style.display = 'none';
        }
        openModal('vinculo-editor-modal');
    }

    function handleVinculoImageUpload(event) {
        const file = event.target.files[0];
        const preview = document.getElementById('vinculo-imagem-preview');

        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                tempVinculoImage = e.target.result;
                preview.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            tempVinculoImage = null;
            preview.src = "";
            preview.style.display = 'none';
        }
    }

    function saveVinculo() {
        const name = document.getElementById('vinculo-nome').value.trim();
        const type = document.getElementById('vinculo-tipo').value;
        const description = document.getElementById('vinculo-descricao').value;

        if (!name) {
            showMessage("O nome do vínculo é obrigatório.", "error");
            return;
        }

        const vinculoToSave = {
            id: currentEditingVinculoId || Date.now(),
            name,
            type,
            description,
            image: tempVinculoImage || defaultImagePlaceholder
        };

        if (currentEditingVinculoId !== null) {
            const index = characterData.vinculos.findIndex(v => v.id == currentEditingVinculoId);
            if (index !== -1) {
                characterData.vinculos[index] = vinculoToSave; 
            }
            showMessage("Vínculo atualizado!", "success");
        } else {
            characterData.vinculos.push(vinculoToSave);
            showMessage("Vínculo salvo!", "success");
        }
        saveData();
        renderVinculos();
        closeModal('vinculo-editor-modal');
    }

    function deleteVinculo(vinculoId) {
        characterData.vinculos = characterData.vinculos.filter(v => v.id != vinculoId);
        saveData();
        renderVinculos();
        showMessage("Vínculo removido.", "success");
    }

    function renderVinculos() {
        const container = document.getElementById('lista-vinculos');
        if(!container) return; 
        container.innerHTML = '';

        if (characterData.vinculos.length === 0) {
            container.innerHTML = '<p class="text-text-primary text-center col-span-full">Nenhum vínculo adicionado ainda.</p>';
            return;
        }

        characterData.vinculos.forEach(v => {
            const vinculoCard = document.createElement('div');
            vinculoCard.className = `flex items-center space-x-4 p-4 rounded-lg shadow-md border-2 border-border-gold bg-black-transparent`;
            
            vinculoCard.innerHTML = `
                <img src="${v.image || defaultImagePlaceholder}" alt="${v.name}" 
                     class="w-16 h-16 rounded-full object-cover border-2 border-gold-glow">
                <div class="flex-grow">
                    <h4 class="text-lg font-bold text-header-gold-text">${v.name}</h4>
                    <p class="text-text-primary text-sm">${v.type ? `${v.type} - ` : ''}${v.description}</p>
                </div>
                <div class="flex flex-col gap-2">
                    <button onclick="openVinculoModal(${v.id})" class="text-gold-glow hover:text-gold-glow-hover">
                        <i data-lucide="pencil" class="w-5 h-5"></i>
                    </button>
                    <button onclick="deleteVinculo(${v.id})" class="text-red-failure hover:opacity-80">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                </div>
            `;
            container.appendChild(vinculoCard);
        });
        lucide.createIcons();
    }

    const debouncedUpdateCurrency = debounce((coinId, value) => {
        characterData.currency[coinId] = parseInt(value) || 0;
        saveData();
    }, 300);

    function renderCurrency() {
        const container = document.getElementById('currency-card');
        if (!container) return;
        const coins = [{id:'cp', name:'Cobre'}, {id:'sp', name:'Prata'}, {id:'ep', name:'Electro'}, {id:'gp', name:'Ouro'}, {id:'pp', name:'Platina'}];
        container.innerHTML = `
            <h2 class="text-xl mb-2" style="color: var(--header-gold-text);">Moedas</h2>
            <div class="space-y-2">
                ${coins.map(coin => `
                    <div class="flex items-center justify-between">
                        <label class="text-sm">${coin.name} (${coin.id.toUpperCase()})</label>
                        <input type="number" id="currency-${coin.id}" class="gothic-input !w-24 text-center" value="${characterData.currency[coin.id] || 0}" oninput="debouncedUpdateCurrency('${coin.id}', this.value);">
                    </div>`).join('')}
            </div>
            <button class="gothic-btn w-full mt-4 text-sm" onclick="consolidateCurrency()"><i data-lucide="coins"></i>Consolidar</button>`;
        lucide.createIcons();
    }
    function consolidateCurrency() {
        let { cp, sp, ep, gp, pp } = characterData.currency;
        sp += Math.floor(cp / 10); cp %= 10;
        gp += Math.floor(sp / 10); sp %= 10;
        gp += Math.floor(ep / 2);  ep %= 2;
        pp += Math.floor(gp / 10); gp %= 10;
        characterData.currency = { cp, sp, ep, gp, pp };
        saveData();
        renderCurrency();
        showMessage("Moedas consolidadas!", "success");
    }

    let selectedDie = 20;
    function selectDie(sides) {
        selectedDie = sides;
        document.getElementById('diceType').textContent = `D${sides}`;
    }
    function rollDice() {
        const qty = parseInt(document.getElementById('diceQty').value) || 1;
        const mod = parseInt(document.getElementById('diceMod').value) || 0;
        const addProf = document.getElementById('addProficiencyToRoll').checked;
        const profBonus = addProf ? calculateProficiencyBonus() : 0;
        let total = 0;
        let rolls = [];
        for(let i = 0; i < qty; i++) {
            const roll = Math.floor(Math.random() * selectedDie) + 1;
            rolls.push(roll);
            total += roll;
        }
        total += mod + profBonus;
        const detail = `${qty}d${selectedDie} (${rolls.join(', ')}) + ${mod}` + (addProf ? ` + ${profBonus}(P)` : '');
        document.getElementById('rollResult').textContent = total;
        document.getElementById('rollDetail').textContent = detail;
        characterData.rollHistory.unshift({result: total, detail: detail});
        if(characterData.rollHistory.length > 20) characterData.rollHistory.pop();
        renderRollHistory();
        saveData();
    }
    function renderRollHistory() {
        const container = document.getElementById('rollHistory');
        container.innerHTML = characterData.rollHistory.map(r => `<p><span class="font-bold" style="color: var(--header-gold-text);">${r.result}</span> = ${r.detail}</p>`).join('');
    }

    function renderThemeSettings() {
        const colorPickersContainer = document.getElementById('color-pickers');
        colorPickersContainer.innerHTML = THEME_COLORS.map(c => {
            let inputHtml = '';
            if (c.type === 'range') {
                const currentValue = parseFloat(getComputedStyle(document.documentElement).getPropertyValue(c.var).trim());
                inputHtml = `<input type="range" min="${c.min}" max="${c.max}" step="${c.step}" value="${currentValue}" oninput="updateThemeColor('${c.var}', this.value)">`;
            } else {
                inputHtml = `<input type="color" value="${getComputedStyle(document.documentElement).getPropertyValue(c.var).trim()}" oninput="updateThemeColor('${c.var}', this.value)">`;
            }
            return `
                <div class="color-picker-item">
                    <label>${c.label}</label>
                    ${inputHtml}
                </div>`;
        }).join('');

        const flameColorPickersContainer = document.getElementById('flame-color-pickers');
        flameColorPickersContainer.innerHTML = FLAME_COLORS.map(c => {
            let inputHtml = '';
            if (c.type === 'range') {
                const currentValue = parseFloat(getComputedStyle(document.documentElement).getPropertyValue(c.var).trim());
                inputHtml = `<input type="range" min="${c.min}" max="${c.max}" step="${c.step}" value="${currentValue}" oninput="updateThemeColor('${c.var}', this.value)">`;
            } else {
                inputHtml = `<input type="color" value="${getComputedStyle(document.documentElement).getPropertyValue(c.var).trim()}" oninput="updateThemeColor('${c.var}', this.value)">`;
            }
            return `
                <div class="color-picker-item">
                    <label>${c.label}</label>
                    ${inputHtml}
                </div>`;
        }).join('');

        document.getElementById('toggleFlameGlow').checked = characterData.theme.flameGlowEnabled;
        document.getElementById('themeModeSwitch').checked = (characterData.theme.mode === 'necrotic');

        for (const sectionKey in characterData.theme.sectionVisibility) {
            const checkbox = document.getElementById(`toggle-section-${sectionKey}`);
            if (checkbox) {
                checkbox.checked = characterData.theme.sectionVisibility[sectionKey];
            } else {
                console.warn(`Checkbox for section '${sectionKey}' not found.`)
            }
        }
    }

    function updateThemeColor(cssVar, value) {
        document.documentElement.style.setProperty(cssVar, value);
        characterData.theme.colors[cssVar] = value;
        saveData();
    }

    function applyTheme() {
        const root = document.documentElement;
        const currentPalette = COLOR_PALETTES[characterData.theme.mode];

        for (const [cssVar, value] of Object.entries(currentPalette)) {
            root.style.setProperty(cssVar, value);
        }

        for (const [cssVar, value] of Object.entries(characterData.theme.colors)) {
            if (value !== undefined) {
                root.style.setProperty(cssVar, value);
            }
        }
        
        root.style.setProperty('--flame-spread-factor', characterData.theme.colors['--flame-spread-factor'] || 1.0);

        if(characterData.theme.wallpaper) {
            document.body.style.backgroundImage = `linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.85)), url('${characterData.theme.wallpaper}')`;
        }

        if (characterData.theme.mode === 'necrotic') {
            document.body.classList.add('theme-necrotic');
        } else {
            document.body.classList.remove('theme-necrotic');
        }

        if (characterData.theme.flameGlowEnabled) {
            document.body.classList.remove('no-flame-glow');
        } else {
            document.body.classList.add('no-flame-glow');
        }
    }
    
    function handleWallpaperUpload(event){
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            characterData.theme.wallpaper = e.target.result;
            applyTheme();
            saveData();
        };
        reader.readAsDataURL(file);
    }

    function toggleFlameGlow(checked) {
        characterData.theme.flameGlowEnabled = checked;
        applyTheme();
        saveData();
    }

    function toggleThemeMode(checked) {
        characterData.theme.mode = checked ? 'necrotic' : 'radiant';
        characterData.theme.colors = {};
        Object.assign(characterData.theme.colors, COLOR_PALETTES[characterData.theme.mode]);
        characterData.theme.colors['--flame-spread-factor'] = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--flame-spread-factor').trim()) || 1.0;

        applyTheme();
        renderThemeSettings();
        saveData();
    }

    function toggleSectionVisibility(sectionId, isVisible, save = true) {
        let cardElement;
        let toggleIcon;
        switch (sectionId) {
            case 'attacks':
                cardElement = document.getElementById('attacksCard');
                break;
            case 'resources':
                cardElement = document.getElementById('resourcesCard');
                break;
            case 'conditions':
                cardElement = document.getElementById('conditionsCard');
                break;
            case 'personality':
                cardElement = document.getElementById('personalityCard');
                break;
            case 'musicPlayer':
                toggleMusicPlayerVisibility(isVisible, save);
                return;
            case 'proficiencies':
                cardElement = document.getElementById('proficiencies-content');
                toggleIcon = document.getElementById('proficiencies-toggle-icon');
                break;
            default:
                return;
        }
        if (cardElement) {
            cardElement.style.display = isVisible ? 'block' : 'none';
            if (toggleIcon) {
                toggleIcon.setAttribute('data-lucide', isVisible ? 'chevron-up' : 'chevron-down');
                lucide.createIcons();
            }
            if (save) {
                characterData.theme.sectionVisibility[sectionId] = isVisible;
                saveData();
            }
        }
    }

    // --- MUSIC PLAYER FUNCTIONS ---
    function setupMusicPlayer() {
        audioPlayer = document.getElementById('backgroundMusicPlayer');
        const volumeControl = document.getElementById('volumeControl');
        if (volumeControl) {
            audioPlayer.volume = parseFloat(volumeControl.value);
        }

        renderLocalPlaylist();
    }

    function toggleMusicPlayerVisibility(enabled, save = true) {
        const musicPlayerCard = document.getElementById('musicPlayerCard');
        if (musicPlayerCard) {
            musicPlayerCard.style.display = enabled ? 'block' : 'none';
            if (save) {
                characterData.theme.musicPlayerEnabled = enabled;
                characterData.theme.sectionVisibility.musicPlayer = enabled;
                saveData();
            }
            if (!enabled) {
                audioPlayer.pause();
            }
        }
    }

    function handleLocalMusicFiles(event) {
        const files = event.target.files;
        if (!files.length) return;

        localPlaylist = [];
        currentTrackIndex = -1;

        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            if (file.type.startsWith('audio/')) {
                localPlaylist.push({
                    name: file.name,
                    url: URL.createObjectURL(file)
                });
            }
        }
        renderLocalPlaylist();
        if (localPlaylist.length > 0 && characterData.theme.musicPlayerEnabled) {
            currentTrackIndex = 0;
            playTrack(currentTrackIndex);
        }
    }

    function renderLocalPlaylist() {
        const playlistEl = document.getElementById('localPlaylist');
        if (!playlistEl) return;

        playlistEl.innerHTML = '';
        if (localPlaylist.length === 0) {
            playlistEl.innerHTML = '<li class="text-center opacity-75">Nenhuma música adicionada.</li>';
            return;
        }

        localPlaylist.forEach((track, index) => {
            const li = document.createElement('li');
            li.textContent = track.name;
            li.className = (index === currentTrackIndex && !audioPlayer.paused) ? 'active-track' : '';
            li.onclick = () => {
                currentTrackIndex = index;
                playTrack(currentTrackIndex);
            };
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'X';
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                removeTrack(index);
            };
            li.appendChild(deleteBtn);
            playlistEl.appendChild(li);
        });
    }

    function playTrack(index) {
        if (index >= 0 && index < localPlaylist.length) {
            audioPlayer.src = localPlaylist[index].url;
            audioPlayer.play();
            currentTrackIndex = index;
            renderLocalPlaylist();
            showNowPlaying(localPlaylist[currentTrackIndex].name.split('.').slice(0, -1).join('.'), "Música Local");
        } else {
            audioPlayer.pause();
            currentTrackIndex = -1;
            renderLocalPlaylist();
        }
    }

    function togglePlayPause() {
        if (audioPlayer.paused) {
            if (audioPlayer.src && localPlaylist.length > 0) {
                audioPlayer.play();
            } else if (localPlaylist.length > 0) {
                currentTrackIndex = 0;
                playTrack(currentTrackIndex);
            }
        } else {
            audioPlayer.pause();
        }
    }

    function nextTrack() {
        if (localPlaylist.length === 0) return;
        currentTrackIndex = (currentTrackIndex + 1) % localPlaylist.length;
        playTrack(currentTrackIndex);
    }

    function prevTrack() {
        if (localPlaylist.length === 0) return;
        currentTrackIndex = (currentTrackIndex - 1 + localPlaylist.length) % localPlaylist.length;
        playTrack(currentTrackIndex);
    }

    function setVolume(value) {
        audioPlayer.volume = parseFloat(value);
    }

    function removeTrack(index) {
        if (index === currentTrackIndex) {
            audioPlayer.pause();
            audioPlayer.src = '';
            currentTrackIndex = -1;
        }
        localPlaylist.splice(index, 1);
        if (currentTrackIndex > index) {
            currentTrackIndex--;
        } else if (currentTrackIndex === index && localPlaylist.length > 0) {
            currentTrackIndex = currentTrackIndex % localPlaylist.length;
            playTrack(currentTrackIndex);
        } else if (localPlaylist.length === 0) {
            currentTrackIndex = -1;
        }
        renderLocalPlaylist();
    }

    function showNowPlaying(title, artist = "Desconhecido") {
        const popup = document.getElementById('nowPlayingPopup');
        if (!popup) return;

        clearTimeout(nowPlayingTimeout);

        popup.textContent = `${title} - ${artist}`;
        popup.classList.add('show');

        nowPlayingTimeout = setTimeout(() => {
            popup.classList.remove('show');
        }, 5000);
    }

    // --- FUNÇÕES DE COMBATE ---
    function openAttackEditModal(index = null) {
        currentEditingAttackIndex = index;
        const attack = index !== null ? 
                                characterData.combat.attacks[index] :
                                { name: '', attackBonus: '', damage: '', type: 'arma corpo a corpo', notes: '' };
        
        document.getElementById('attack-modal-title').textContent = index !== null ? 'Editar Ataque' : 'Adicionar Novo Ataque';
        document.getElementById('attack-name-input').value = attack.name;
        document.getElementById('attack-bonus-input').value = attack.attackBonus;
        document.getElementById('attack-damage-input').value = attack.damage;
        document.getElementById('attack-type-input').value = attack.type;
        document.getElementById('attack-notes-input').value = attack.notes;

        openModal('attackEditModal');
    }

    function saveAttack() {
        const attackName = document.getElementById('attack-name-input').value.trim();

        if (!attackName) {
            showMessage("Nome do ataque é obrigatório!", "error");
            return;
        }

        const attackToSave = {
            name: attackName,
            attackBonus: document.getElementById('attack-bonus-input').value,
            damage: document.getElementById('attack-damage-input').value,
            type: document.getElementById('attack-type-input').value,
            notes: document.getElementById('attack-notes-input').value
        };

        if (currentEditingAttackIndex !== null) {
            characterData.combat.attacks[currentEditingAttackIndex] = attackToSave;
            showMessage("Ataque atualizado com sucesso!", "success");
        } else {
            characterData.combat.attacks.push(attackToSave);
            showMessage("Ataque criado com sucesso!", "success");
        }

        saveData();
        renderAttacks();
        closeModal('attackEditModal');
    }

    function deleteAttack(index) {
        characterData.combat.attacks.splice(index, 1);
        saveData();
        renderAttacks();
        showMessage("Ataque removido.", "success");
    }

    function renderAttacks() {
        const attackListContainer = document.getElementById('attackList');
        if (!attackListContainer) return;

        attackListContainer.innerHTML = '';

        if (characterData.combat.attacks.length === 0) {
            attackListContainer.innerHTML = '<p class="opacity-70 italic text-center">Nenhum ataque adicionado ainda.</p>';
        } else {
            characterData.combat.attacks.forEach((attack, index) => {
                const attackItemDiv = document.createElement('div');
                attackItemDiv.className = 'attack-item';
                attackItemDiv.innerHTML = `
                    <div class="attack-item-header">
                        <h4>${attack.name}</h4>
                        <div class="flex gap-2">
                            <button class="gothic-btn text-xs py-1 px-2" onclick="openAttackEditModal(${index})">Editar</button>
                            <button class="gothic-btn text-xs py-1 px-2 !border-red-500 !text-red-500 hover:!bg-red-500 hover:!text-black" onclick="deleteAttack(${index})">X</button>
                        </div>
                    </div>
                    <div class="attack-details">
                        <span>Bônus: ${attack.attackBonus || '--'}</span> | 
                        <span>Dano: ${attack.damage || '--'}</span> | 
                        <span>Tipo: ${attack.type || '--'}</span>
                    </div>
                    ${attack.notes ? `<p class="attack-notes">${attack.notes}</p>` : ''}
                `;
                attackListContainer.appendChild(attackItemDiv);
            });
        }
        lucide.createIcons();
    }

    function rollIndividualDie(dieType) {
        const sides = parseInt(dieType.substring(1));
        return Math.floor(Math.random() * sides) + 1;
    }

    function openSpendHitDicePrompt() {
        const currentHD = characterData.hp.hitDice.current;
        const hdType = characterData.hp.hitDice.type;

        document.getElementById('available-hd-count').textContent = currentHD;
        document.getElementById('hd-type-display').textContent = hdType;
        document.getElementById('num-hd-to-spend').value = Math.min(1, currentHD);
        document.getElementById('num-hd-to-spend').max = currentHD;
        document.getElementById('hd-roll-result').textContent = '';

        openModal('spendHitDiceModal');
    }

    function performSpendHitDice() {
        const numDiceToSpend = parseInt(document.getElementById('num-hd-to-spend').value) || 0;
        const currentHD = characterData.hp.hitDice.current;
        const hdType = characterData.hp.hitDice.type;
        const conModifier = calculateModifier(characterData.attributes.con);

        if (numDiceToSpend <= 0 || numDiceToSpend > currentHD) {
            document.getElementById('hd-roll-result').textContent = 'Número inválido de Dados de Vida!';
            showMessage("Número inválido de Dados de Vida!", "error");
            return;
        }

        let totalHealed = 0;
        let rolls = [];
        for (let i = 0; i < numDiceToSpend; i++) {
            const roll = rollIndividualDie(hdType);
            const healAmount = roll + conModifier;
            rolls.push(`${roll}${conModifier >= 0 ? '+' : ''}${conModifier}`);
            totalHealed += Math.max(1, healAmount);
        }

        characterData.hp.hitDice.current -= numDiceToSpend;
        characterData.hp.current = Math.min(characterData.hp.max, characterData.hp.current + totalHealed);

        document.getElementById('hd-roll-result').textContent = `Curado ${totalHealed} PV! (${rolls.join(' + ')})`;
        document.getElementById('hit-dice-current').value = characterData.hp.hitDice.current;
        document.getElementById('available-hd-count').textContent = characterData.hp.hitDice.current;

        updateHpBar();
        saveData();
        showMessage(`Curado ${totalHealed} PV!`, "success");
        setTimeout(() => closeModal('spendHitDiceModal'), 2000);
    }

    function takeShortRest() {
        characterData.rests.short++;
        characterData.hp.hitDice.current = Math.min(characterData.hp.hitDice.max, characterData.hp.hitDice.current + Math.max(1, Math.floor(characterData.hp.hitDice.max / 2)));
        
        resetResources('short-rest');

        document.getElementById('short-rests-count').textContent = characterData.rests.short;
        document.getElementById('hit-dice-current').value = characterData.hp.hitDice.current;

        saveData();
        updateAllCalculations();
        showMessage("Descanso Curto Concluído! Seus Dados de Vida foram recuperados e recursos de Descanso Curto redefinidos. Você pode gastá-los agora.", "success");
    }

    function takeLongRest() {
        characterData.rests.long++;
        characterData.hp.current = characterData.hp.max;
        characterData.hp.hitDice.current = characterData.hp.hitDice.max;
        
        resetResources('long-rest');
        resetResources('once-per-day');

        characterData.combat.conditions = [];
        renderActiveConditions();

        document.getElementById('long-rests-count').textContent = characterData.rests.long;
        document.getElementById('hpCurrent').value = characterData.hp.current;
        document.getElementById('hit-dice-current').value = characterData.hp.hitDice.current;

        saveData();
        updateAllCalculations();
        showMessage("Descanso Longo Concluído! HP, Dados de Vida e a maioria dos recursos totalmente restaurados. Condições limpas.", "success");
    }

    function toggleResourceUses() {
        const resetType = document.getElementById('resource-reset-input').value;
        const usesContainer = document.getElementById('resource-uses-container');
        if (resetType === 'at-will' || resetType === 'other') {
            usesContainer.classList.add('hidden');
        } else {
            usesContainer.classList.remove('hidden');
        }
    }

    function openResourceEditModal(resourceId = null) {
        currentEditingResourceIndex = resourceId !== null ? characterData.combat.resources.findIndex(r => r.id === resourceId) : null;
        
        const resource = resourceId !== null && currentEditingResourceIndex !== -1 ?
            characterData.combat.resources[currentEditingResourceIndex] :
            { id: Date.now(), name: '', description: '', type: 'class-feature', uses: { current: 0, max: 0, reset: 'at-will' } };

        document.getElementById('resource-modal-title').textContent = resourceId !== null ? 'Editar Recurso' : 'Adicionar Novo Recurso';
        document.getElementById('resource-name-input').value = resource.name;
        document.getElementById('resource-description-input').value = resource.description;
        document.getElementById('resource-type-input').value = resource.type;
        document.getElementById('resource-reset-input').value = resource.uses.reset;
        document.getElementById('resource-uses-current-input').value = resource.uses.current;
        document.getElementById('resource-uses-max-input').value = resource.uses.max;

        toggleResourceUses();
        openModal('resourceEditModal');
    }

    function saveResource() {
        const name = document.getElementById('resource-name-input').value.trim();
        const description = document.getElementById('resource-description-input').value;
        const type = document.getElementById('resource-type-input').value;
        const reset = document.getElementById('resource-reset-input').value;
        let currentUses = 0;
        let maxUses = 0;

        if (reset !== 'at-will' && reset !== 'other') {
            currentUses = parseInt(document.getElementById('resource-uses-current-input').value) || 0;
            maxUses = parseInt(document.getElementById('resource-uses-max-input').value) || 0;
        }

        if (!name) {
            showMessage("O nome do recurso/habilidade não pode estar vazio.", "error");
            return;
        }

        const resourceToSave = {
            id: currentEditingResourceIndex !== null && currentEditingResourceIndex !== -1 ? characterData.combat.resources[currentEditingResourceIndex].id : Date.now(),
            name,
            description,
            type,
            uses: { current: currentUses, max: maxUses, reset }
        };

        if (currentEditingResourceIndex !== null && currentEditingResourceIndex !== -1) {
            characterData.combat.resources[currentEditingResourceIndex] = resourceToSave;
            showMessage("Recurso/Habilidade atualizada com sucesso!", "success");
        } else {
            characterData.combat.resources.push(resourceToSave);
            showMessage("Recurso/Habilidade salva com sucesso!", "success");
        }
        saveData();
        renderResources();
        closeModal('resourceEditModal');
    }

    function deleteResource(resourceId) {
        characterData.combat.resources = characterData.combat.resources.filter(res => res.id !== resourceId);
        saveData();
        renderResources();
        showMessage("Recurso/Habilidade removida.", "success");
    }

    function useResource(resourceId) {
        const resource = characterData.combat.resources.find(res => res.id === resourceId);
        if (resource && resource.uses.reset !== 'at-will' && resource.uses.current > 0) {
            resource.uses.current--;
            saveData();
            renderResources();
            showMessage(`Recurso "${resource.name}" usado. Usos restantes: ${resource.uses.current}`, "success", 1500);
        } else if (resource && resource.uses.current <= 0) {
            showMessage(`Você não tem usos restantes para "${resource.name}".`, "error", 1500);
        }
    }
    
    function resetResources(resetType) {
        characterData.combat.resources.forEach(res => {
            if (res.uses.reset === resetType) {
                res.uses.current = res.uses.max;
            }
        });
        saveData();
        renderResources();
    }

    function renderResources() {
        const resourcesListContainer = document.getElementById('resourcesList');
        if (!resourcesListContainer) return;

        resourcesListContainer.innerHTML = '';

        if (characterData.combat.resources.length === 0) {
            resourcesListContainer.innerHTML = '<p class="opacity-70 italic text-center">Nenhum recurso ou habilidade adicionada ainda.</p>';
        } else {
            characterData.combat.resources.forEach((resource) => {
                const resourceItemDiv = document.createElement('div');
                resourceItemDiv.className = 'resource-item';
                let usesDisplay = '';
                let useButton = '';
                let resetButton = '';

                if (resource.uses.reset !== 'at-will' && resource.uses.reset !== 'other') {
                    usesDisplay = `<div class="flex items-center gap-1"><span>Usos: ${resource.uses.current} / ${resource.uses.max}</span></div>`;
                    useButton = `<button class="resource-use-btn" onclick="useResource(${resource.id})"><i data-lucide="minus" class="w-4 h-4"></i></button>`;
                    resetButton = `<button class="resource-use-btn" onclick="resetResource(${resource.id})"><i data-lucide="rotate-ccw" class="w-4 h-4"></i></button>`;
                } else {
                    usesDisplay = `Usos: ${resource.uses.reset === 'at-will' ? 'À Vontade' : 'Outro'}`;
                }

                resourceItemDiv.innerHTML = `
                    <div class="resource-item-header">
                        <h4>${resource.name}</h4>
                        <div class="flex gap-2">
                            <button class="gothic-btn text-xs py-1 px-2" onclick="openResourceEditModal(${resource.id})">Editar</button>
                            <button class="gothic-btn text-xs py-1 px-2 !border-red-500 !text-red-500 hover:!bg-red-500 hover:!text-black" onclick="deleteResource(${resource.id})">X</button>
                        </div>
                    </div>
                    <div class="resource-details">
                        <span>Tipo: ${resource.type}</span> | 
                        <span>Redefine: ${resource.uses.reset}</span>
                    </div>
                    <p class="resource-notes">${resource.description || 'Nenhuma descrição.'}</p>
                    <div class="flex items-center justify-end gap-2 mt-2">
                        ${usesDisplay}
                        ${useButton}
                        ${resetButton}
                    </div>
                `;
                resourcesListContainer.appendChild(resourceItemDiv);
            });
        }
        lucide.createIcons();
    }

    function openConditionModal() {
        const allConditionsListContainer = document.getElementById('allConditionsList');
        if (!allConditionsListContainer) return;

        allConditionsListContainer.innerHTML = '';

        CONDITIONS.forEach(condition => {
            const isChecked = characterData.combat.conditions.includes(condition.name);
            const conditionDiv = document.createElement('div');
            conditionDiv.className = 'condition-item p-2 flex items-center justify-between';
            if (isChecked) conditionDiv.classList.add('active');

            conditionDiv.innerHTML = `
                <label class="flex items-center flex-grow cursor-pointer">
                    <input type="checkbox" class="condition-checkbox" ${isChecked ? 'checked' : ''} onchange="toggleCondition('${condition.name}', this.checked)">
                    <span class="text-base font-bold">${condition.name}</span>
                </label>
                <div class="text-sm opacity-80 max-w-[60%] text-right">${condition.description}</div>
            `;
            allConditionsListContainer.appendChild(conditionDiv);
        });
        lucide.createIcons();

        openModal('conditionModal');
    }

    function toggleCondition(conditionName, isChecked) {
        const index = characterData.combat.conditions.indexOf(conditionName);
        if (isChecked && index === -1) {
            characterData.combat.conditions.push(conditionName);
            showMessage(`Condição "${conditionName}" ativada.`, "success", 1500);
        } else if (!isChecked && index !== -1) {
            characterData.combat.conditions.splice(index, 1);
            showMessage(`Condição "${conditionName}" desativada.`, "success", 1500);
        }
        saveData();
        renderActiveConditions();
        const checkboxEl = document.querySelector(`#allConditionsList input[type="checkbox"][onchange*="toggleCondition('${conditionName}', this.checked)"]`);
        if (checkboxEl) {
            checkboxEl.closest('.condition-item').classList.toggle('active', isChecked);
        }
    }

    function renderActiveConditions() {
        const activeConditionsListContainer = document.getElementById('activeConditionsList');
        if (!activeConditionsListContainer) return;

        activeConditionsListContainer.innerHTML = '';

        if (characterData.combat.conditions.length === 0) {
            activeConditionsListContainer.innerHTML = '<p class="opacity-70 italic text-center">Nenhuma condição ativa.</p>';
        } else {
            characterData.combat.conditions.forEach(conditionName => {
                const conditionData = CONDITIONS.find(c => c.name === conditionName);
                if (conditionData) {
                    const conditionItemDiv = document.createElement('div');
                    conditionItemDiv.className = 'condition-item active p-2';
                    conditionItemDiv.innerHTML = `
                        <div class="condition-item-header">
                            <h4>${conditionData.name}</h4>
                            <button class="gothic-btn text-xs py-1 px-2 !border-red-500 !text-red-500 hover:!bg-red-500 hover:!text-black" onclick="toggleCondition('${conditionData.name}', false)">Remover</button>
                        </div>
                        <p class="condition-notes">${conditionData.description}</p>
                    `;
                    activeConditionsListContainer.appendChild(conditionItemDiv);
                }
            });
        }
        lucide.createIcons();
    }

    function renderJournalEntries() {
        const listContainer = document.getElementById('journalEntriesList');
        if (!listContainer) return;

        listContainer.innerHTML = '';

        if (characterData.journalEntries.length === 0) {
            listContainer.innerHTML = '<p class="opacity-70 italic text-center">Nenhuma entrada de diário adicionada ainda.</p>';
        } else {
            const sortedEntries = [...characterData.journalEntries].sort((a, b) => new Date(b.date) - new Date(a.date));

            sortedEntries.forEach(entry => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'gothic-card p-3 flex justify-between items-center cursor-pointer';
                entryDiv.innerHTML = `
                    <div>
                        <p class="text-sm opacity-80">${entry.date}</p>
                        <h4 class="text-lg font-bold">${entry.title || 'Sem Título'}</h4>
                    </div>
                    <div class="flex gap-2">
                        <button class="gothic-btn text-xs py-1 px-2" onclick="event.stopPropagation(); openJournalEntryModal('${entry.id}')">Editar</button>
                        <button class="gothic-btn text-xs py-1 px-2 !border-red-500 !text-red-500 hover:!bg-red-500 hover:!text-black" onclick="event.stopPropagation(); deleteJournalEntry('${entry.id}')">X</button>
                    </div>
                `;
                listContainer.appendChild(entryDiv);
            });
        }
    }

    function openJournalEntryModal(entryId = null) {
        currentEditingJournalEntryId = entryId;
        const dateInput = document.getElementById('journal-entry-date');
        const titleInput = document.getElementById('journal-entry-title');
        const contentTextarea = document.getElementById('journal-entry-content');
        const modalTitle = document.getElementById('journal-entry-modal-title');

        if (entryId !== null) {
            const entry = characterData.journalEntries.find(e => e.id == entryId);
            if (!entry) return;
            modalTitle.textContent = 'Editar Entrada de Diário';
            dateInput.value = entry.date;
            titleInput.value = entry.title;
            contentTextarea.value = entry.content;
        } else {
            modalTitle.textContent = 'Nova Entrada de Diário';
            dateInput.value = new Date().toISOString().split('T')[0];
            titleInput.value = '';
            contentTextarea.value = '';
        }
        openModal('journalEntryModal');
    }

    function saveJournalEntry() {
        const date = document.getElementById('journal-entry-date').value;
        const title = document.getElementById('journal-entry-title').value.trim();
        const content = document.getElementById('journal-entry-content').value;

        if (!date || !title) {
            showMessage("Data e Título são obrigatórios para a entrada de diário.", "error");
            return;
        }

        const entryToSave = {
            id: currentEditingJournalEntryId || Date.now(),
            date,
            title,
            content
        };

        if (currentEditingJournalEntryId !== null) {
            const index = characterData.journalEntries.findIndex(e => e.id == currentEditingJournalEntryId);
            if (index !== -1) {
                characterData.journalEntries[index] = entryToSave; 
            }
            showMessage("Entrada de diário atualizada!", "success");
        } else {
            characterData.journalEntries.push(entryToSave);
            showMessage("Entrada de diário salva!", "success");
        }
        saveData();
        renderJournalEntries();
        closeModal('journalEntryModal');
    }

    function deleteJournalEntry(entryId) {
        characterData.journalEntries = characterData.journalEntries.filter(e => e.id != entryId);
        saveData();
        renderJournalEntries();
        showMessage("Entrada de diário removida.", "success");
    }

    // --- FUNÇÕES DE EXPORTAR/IMPORTAR FICHA (CORRIGIDAS E DEBUGADAS) ---

    // Função exportAllData movida para o escopo global
    function exportAllData() {
        console.log("Iniciando exportAllData...");
        const appStateToExport = {
            characterData: characterData,
            localPlaylist: localPlaylist,
            // Adicione outras variáveis globais persistentes aqui, se houver necessidade no futuro
        };
        
        let dataStr;
        try {
            dataStr = JSON.stringify(appStateToExport, null, 2);
            console.log("Dados serializados com sucesso.");
        } catch (e) {
            console.error("Erro ao serializar dados para JSON:", e);
            showMessage("Erro ao preparar dados para exportação. Detalhes: " + e.message, "error", 7000);
            return; // Aborta se a serialização falhar
        }

        const blob = new Blob([dataStr], { type: "application/json" });
        console.log("Blob criado:", blob);

        const url = URL.createObjectURL(blob);
        console.log("URL de objeto criada:", url);
        
        const now = new Date();
        const dateString = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
        const filename = `ficha_dnd_${characterData.name.replace(/\s/g, '_') || 'personagem'}_${dateString}.json`;
        console.log("Nome do arquivo:", filename);

        try {
            // Tenta a abordagem moderna com um elemento <a> temporário
            if ('download' in document.createElement('a')) {
                console.log("Tentando download via elemento <a> (método moderno)...");
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a); // Anexa ao corpo para garantir que o clique funcione
                a.click(); // Simula um clique
                document.body.removeChild(a); // Remove o elemento <a>
            } else if (window.navigator.msSaveOrOpenBlob) { // Fallback para IE/Edge (versões antigas)
                console.log("Tentando msSaveOrOpenBlob (IE/Edge antigo)...");
                window.navigator.msSaveOrOpenBlob(blob, filename);
            } else { // Fallback genérico para navegadores que não suportam 'download' nem msSaveOrOpenBlob
                console.log("Nenhum método de download direto suportado. Abrindo em nova aba...");
                window.open(url, '_blank'); // Abre o JSON em uma nova aba
                showMessage("Seu navegador não suporta download direto. O conteúdo da ficha foi aberto em uma nova aba. Salve o arquivo manualmente (Ctrl+S).", "error", 10000);
            }
            URL.revokeObjectURL(url); // Libera a URL do objeto
            console.log("Download acionado. URL do objeto revogada.");
            showMessage("Ficha e dados exportados com sucesso!", "success", 4000);
        } catch (e) {
            console.error("Erro ao acionar download:", e);
            showMessage("Erro ao acionar o download do arquivo. Verifique as permissões do navegador ou bloqueadores de pop-up. Detalhes: " + e.message, "error", 7000);
        }
    }

    // Função importAllData movida para o escopo global
    function importAllData(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedAppState = JSON.parse(e.target.result);

                if (importedAppState && typeof importedAppState === 'object' && importedAppState.characterData) {
                    if (confirm('Importar esta ficha substituirá TODOS os dados atuais (ficha, músicas, etc.). Deseja continuar?')) {
                        localStorage.removeItem(STORAGE_KEY); 
                        
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(importedAppState));
                        
                        showMessage("Dados importados com sucesso! Recarregando a ficha...", "success", 4000);
                        setTimeout(() => location.reload(), 1000);
                    }
                } else {
                    showMessage("Arquivo JSON inválido. Certifique-se de que é um arquivo de exportação de ficha válido.", "error", 5000);
                }
            } catch (error) {
                console.error("Erro ao importar dados:", error);
                showMessage("Erro ao ler o arquivo. Certifique-se de que é um JSON válido. Detalhes: " + error.message, "error", 7000);
            }
        };
        reader.readAsText(file);
    }

    // As demais funções que precisam ser chamadas pelo HTML diretamente (onclick, onchange etc.)
    // também devem estar no escopo global. No seu código atual, elas já parecem estar,
    // mas se ocorrerem erros de "not defined" para outras funções, o mesmo princípio se aplica:
    // mova-as para fora do window.onload ou de qualquer função que não as coloque no escopo global.

    function toggleQuickAccessBar() {
        const quickAccessContainer = document.getElementById('global-quick-access-container');
        const contentWrapper = document.getElementById('quick-access-content-wrapper');
        const toggleBtnIcon = document.querySelector('#quick-access-toggle-btn i');
        
        const isCollapsed = quickAccessContainer.classList.toggle('collapsed');
        characterData.theme.quickAccessCollapsed = isCollapsed;
        saveData();

        if (isCollapsed) {
            contentWrapper.style.maxHeight = '0';
            contentWrapper.style.opacity = 0;
            contentWrapper.style.pointerEvents = 'none';
            quickAccessContainer.style.paddingBottom = '0';
        } else {
            contentWrapper.style.maxHeight = contentWrapper.scrollHeight + 'px';
            contentWrapper.style.opacity = 1;
            contentWrapper.style.pointerEvents = 'auto';
            quickAccessContainer.style.paddingBottom = '0.5rem';
        }

        if (toggleBtnIcon) {
            toggleBtnIcon.setAttribute('data-lucide', isCollapsed ? 'chevron-down' : 'chevron-up');
            lucide.createIcons();
        }
    }

    // O window.onload deve ser o *último* a ser chamado ou deve conter apenas a inicialização da UI.
    // Todas as funções que precisam ser globais (como exportAllData, importAllData, openModal, etc.)
    // devem ser definidas *fora* do window.onload, diretamente no escopo global.
    window.onload = () => { 
        loadData(); 
        populateUIFromData(); 
        setupEventListeners(); 
        lucide.createIcons(); 
    };

</script>
</body>
</html>
